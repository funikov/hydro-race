<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Водная битва — Classic & Groovy</title>

  <!-- Шрифты -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fredoka:wght@400;600;800&family=Monoton&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#0b0f1d; --bg2:#0f172a;
      --border:rgba(148,163,184,.16);
      --muted:#94a3b8; --text:#e5e7eb;
      --brand:#22d3ee; --brand2:#60a5fa;
      --barStart: var(--brand); --barEnd: var(--brand2);
      --shadow:0 20px 40px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:Inter, Fredoka, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 900px at 10% -10%, #0b122a66, transparent 40%),
        radial-gradient(900px 700px at 120% 10%, #0a3f5d55, transparent 50%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    }
    body[data-theme="groovy"]{
      --bg1:#120019; --bg2:#03041c; --border:rgba(255,255,255,.14);
      --muted:#b8c4ff; --text:#f6f7ff; --brand:#00ffd1; --brand2:#7df9ff;
      --barStart:#00ffd1; --barEnd:#7df9ff; --shadow:0 30px 60px rgba(0,0,0,.45); --radius:20px;
      font-family:Fredoka, Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
    }
    body[data-theme="groovy"]::before{
      content:""; position:fixed; inset:-10% -10%; z-index:-1; pointer-events:none;
      background:
        conic-gradient(from 0deg at 30% 30%, #ff6ad533, #7df9ff33, #ffd16633, #00ffd133, #ff8fab33, #a78bfa33, #ff6ad533),
        conic-gradient(from 180deg at 70% 60%, #00ffd124, #ffd16624, #7df9ff24, #ff6ad524, #a78bfa24, #00ffd124);
      filter:hue-rotate(0deg) saturate(140%) blur(.2px);
      animation: swirl 28s linear infinite; mix-blend-mode: screen;
    }
    @keyframes swirl{0%{transform:rotate(0) scale(1.02)}50%{transform:rotate(180deg) scale(1.04)}100%{transform:rotate(360deg) scale(1.02)}}

    body[data-theme="classic"]{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 18px;background:rgba(8,14,28,.55);backdrop-filter:blur(12px) saturate(120%);border-bottom:1px solid var(--border)}
    .brand{display:flex;gap:12px;align-items:center}
    .drop{width:32px;height:32px;border-radius:10px;background:
        radial-gradient(circle at 25% 25%, #fff8, transparent 35%),
        conic-gradient(from 220deg, var(--brand), var(--brand2), var(--brand));
      box-shadow:inset 0 0 14px #fff3, 0 8px 22px rgba(34,211,238,.35), 0 0 0 2px #ffffff22;}
    body[data-theme="groovy"] .drop{ width:38px;height:38px;border-radius:12px; animation:bob 3.8s ease-in-out infinite;}
    @keyframes bob{0%,100%{ transform:translateY(0) rotate(12deg)} 50%{ transform:translateY(-2px) rotate(8deg)}}
    .title{font-weight:800} body[data-theme="groovy"] .title{font-family:Monoton,cursive;letter-spacing:1px;font-size:28px;text-shadow:0 2px 8px #0009}
    .subtitle{font-size:12px;color:var(--muted)} .row{display:flex;gap:12px;align-items:center}
    .seg{display:inline-flex;gap:4px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:12px;padding:4px}
    .seg .segbtn{background:transparent;color:var(--text);border:0;padding:8px 12px;cursor:pointer;border-radius:10px;font-weight:800}
    .seg .segbtn.active{background:linear-gradient(180deg, rgba(34,211,238,.24), rgba(96,165,250,.18));}
    body[data-theme="groovy"] .seg .segbtn.active{background:linear-gradient(180deg, rgba(0,255,209,.24), rgba(125,249,255,.18));}
    .btn{border:0;color:#06111c;background:linear-gradient(180deg, var(--brand) 0%, var(--brand2) 86%);
      padding:10px 16px;border-radius:999px;cursor:pointer;font-weight:800;letter-spacing:.3px;box-shadow:0 6px 16px rgba(34,211,238,.35);transition:transform .08s ease, filter .2s ease}
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}

    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .grid.two-col{display:grid;gap:18px;align-items:stretch}
    #achCard{grid-area: ach;} #myDayCard{grid-area: day;} #lbCard{grid-area: lb;} #insightsCard{grid-area: insights;} #donutCard{grid-area: donut;}

    /* Мобильная — ачивки в самом низу */
    @media(max-width:960px){
      .grid.two-col{grid-template-columns:1fr;grid-template-areas:"day" "lb" "insights" "donut" "ach";}
    }
    /* Десктоп — ачивки под двумя рядами */
    @media (min-width: 961px){
      .grid.two-col{grid-template-columns:1.1fr .9fr;grid-template-areas:"day lb" "insights donut" "ach ach";}
    }

    .card{position:relative;overflow:clip;background:linear-gradient(180deg, rgba(34,211,238,.06), #070b18);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; isolation:isolate;}
    .card::before{content:""; position:absolute; inset:-30% -10% auto auto; width:200px;height:200px; border-radius:50%;
      background:repeating-radial-gradient(circle at 50% 50%, #ffffff06 0px, #ffffff06 2px, transparent 3px, transparent 5px),
        conic-gradient(from 0deg, #ff6ad5, var(--brand), #ffd166, var(--brand2), #a78bfa, #ff6ad5);
      filter:blur(18px) saturate(120%); opacity:.20; pointer-events:none; transform:rotate(-8deg); z-index:-1;}
    h2{margin:0 0 10px 0;font-size:20px} .stat{display:flex;align-items:baseline;gap:10px}.stat .big{font-size:44px;font-weight:900;letter-spacing:.3px}
    .unit{color:var(--muted)} .muted{color:var(--muted);font-size:13px}
    .chipbar{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 10px}
    .chip{border:1px dashed rgba(148,163,184,.6); color:var(--text); background:linear-gradient(180deg, #111829, #0c1426);
      padding:10px 14px;border-radius:12px;cursor:pointer;transition:border-color .2s ease, transform .08s ease, filter .2s ease; box-shadow:inset 0 0 0 1px #ffffff10}
    .chip:hover{border-color:rgba(255,255,255,.4)} .chip:active{transform:translateY(1px)}

    .bev-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:8px 0 14px}
    @media(max-width:520px){.bev-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .bev{position:relative; display:grid;place-items:center;gap:6px; padding:12px 8px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(180deg,#192238,#0c1222); cursor:pointer;text-align:center;transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease; box-shadow:inset 0 0 0 1px #ffffff10}
    .bev:hover{border-color:rgba(255,255,255,.4)} .bev.selected{border-color:rgba(0,255,209,.8); box-shadow:0 0 0 2px rgba(0,255,209,.25) inset}
    .bev .icon{width:28px;height:28px} .bev .name{font-size:12px;color:var(--text)}

    .progress-wrap{display:flex;gap:18px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .progress{position:relative;width:130px;height:130px}
    .progress svg{width:130px;height:130px;transform:rotate(-90deg)}
    .progress .ring-bg{stroke:rgba(148,163,184,.18);stroke-width:12;fill:none}
    .progress .ring-fg{stroke:url(#ringGradient);stroke-linecap:round;stroke-width:12;fill:none;transition:stroke-dashoffset .5s ease}
    .progress .inside{position:absolute;inset:0;display:grid;place-items:center;text-align:center}
    .progress .inside .big{font-weight:900;font-size:20px;display:inline-block;white-space:nowrap;transform-origin:center center}

    .goal-controls{display:flex;gap:8px;align-items:center}
    input[type=number]{width:140px;background:#0a0f1d;color:var(--text);border:1px solid rgba(148,163,184,.4);border-radius:12px;padding:10px 12px}

    .hidden{display:none!important}
    #splashLayer{position:fixed;inset:0;pointer-events:none;z-index:9999}
    .splash-particle{position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, var(--brand2), var(--brand) 60%);opacity:.95;filter:drop-shadow(0 6px 16px rgba(34,211,238,.35));animation:splash 720ms ease-out forwards}
    .splash-ripple{position:absolute;width:12px;height:12px;border:2px solid rgba(34,211,238,.8);border-radius:50%;transform:translate(-50%,-50%) scale(.2);opacity:.9;animation:ripple 650ms ease-out forwards}
    @keyframes splash{0%{transform:translate(0,0) scale(.85);opacity:.95}80%{opacity:1}100%{transform:translate(var(--dx), var(--dy)) scale(.2);opacity:0}}
    @keyframes ripple{to{transform:translate(-50%,-50%) scale(4.2);opacity:0}}

    .hour-wrap{display:flex;gap:8px;align-items:flex-end}
    .y-axis{position:relative;height:140px;width:40px;margin-top:8px}
    .y-axis .ylabel{position:absolute;left:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);writing-mode:vertical-rl;transform:rotate(180deg)}
    .yticks{position:absolute;right:0;top:0;bottom:0;display:flex;flex-direction:column;justify-content:space-between;align-items:flex-end;font-size:11px;color:var(--muted)}
    .yticks .tick{line-height:1}
    .hour-chart{position:relative;flex:1;display:flex;gap:4px;align-items:flex-end;height:140px;margin-top:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0b1220}
    .hgrid{position:absolute;inset:10px;pointer-events:none}
    .hgrid .line{position:absolute;left:0;right:0;height:1px;background:rgba(148,163,184,.22)}
    .hour-bar{flex:1;min-width:0;height:8px;border-radius:8px 8px 0 0;background:linear-gradient(180deg, var(--barStart), var(--barEnd) 80%), linear-gradient(0deg, #ffffffaa, #ffffff00);box-shadow:0 6px 16px rgba(34,211,238,.25);transition:height .35s ease, filter .2s ease}
    .hour-bar:hover{filter:saturate(120%)} .hour-axis{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}

    .ach-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:8px}
    @media(max-width:520px){.ach-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .ach{display:grid;place-items:center;gap:8px;padding:12px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#11192d,#0d1426);text-align:center;}
    .ach.locked{opacity:.65;filter:grayscale(.15) brightness(.95)}
    .ach-title{font-size:12px;font-weight:700} .ach-sub{font-size:11px;color:var(--muted)}
    .ach-ill{width:56px;height:56px;border-radius:12px;overflow:hidden;background:#0b0d24;border:1px solid var(--border);display:grid;place-items:center}
    .ach-ill svg{width:46px;height:46px}

    .donut-wrap{position:relative;display:grid;grid-template-columns:auto 1fr;gap:14px}
    @media(max-width:520px){ .donut-wrap{grid-template-columns:1fr} }
    #donutCanvas{width:260px;height:260px;border-radius:12px;background:#0b0d24;border:1px solid var(--border)}
    .donut-center{position:absolute;left:0;top:0;width:260px;height:260px;display:grid;place-items:center;pointer-events:none}
    .donut-center .big{font-weight:900;font-size:20px}
    .legend{display:flex;flex-direction:column;gap:8px;align-self:center}
    .legend-item{display:flex;align-items:center;gap:10px;font-size:14px}
    .legend-dot{width:10px;height:10px;border-radius:50%}
    .legend-sub{color:var(--muted);font-size:12px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:10000}
    .modal{width:min(880px,92vw);max-height:80vh;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,.16);text-align:right}
    .table th:first-child,.table td:first-child{text-align:left}
    .tfoot td{font-weight:800}
  </style>
</head>
<body data-theme="classic">
  <header>
    <div class="brand">
      <div class="drop" aria-hidden="true"></div>
      <div>
        <div class="title">Водная битва</div>
        <div class="subtitle"><span id="themeLabel">Classic</span> — соревнование по воде 💧</div>
      </div>
    </div>

    <div class="row" id="authRow" style="gap:10px;flex-wrap:wrap">
      <div class="seg" role="tablist" aria-label="Theme">
        <button class="segbtn active" id="themeClassicBtn" data-theme-btn="classic" role="tab" aria-selected="true">Classic</button>
        <button class="segbtn" id="themeGroovyBtn" data-theme-btn="groovy" role="tab" aria-selected="false">Groovy</button>
      </div>

      <div class="row hidden" id="userInfo">
        <div class="avatar" id="userAvatar" style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#0a0f1d"></div>
        <div class="name" id="userName"></div>
      </div>
      <button class="btn" id="signInBtn">Войти через Google</button>
      <button class="btn secondary hidden" id="signOutBtn">Выйти</button>
    </div>
  </header>

  <main id="app" class="hidden">
    <div class="grid two-col">
      <section class="card" id="myDayCard" aria-labelledby="myDayTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="myDayTitle">Мой день</h2>
          <div class="muted" id="todayLabel"></div>
        </div>

        <div class="bev-grid" id="bevGrid" aria-label="Выбор напитка"></div>
        <div class="muted" id="factorHint"></div>

        <svg width="0" height="0" style="position:absolute">
          <defs>
            <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop id="rgStop1" offset="0%" stop-color="#22d3ee"/>
              <stop id="rgStop2" offset="50%" stop-color="#60a5fa"/>
              <stop id="rgStop3" offset="100%" stop-color="#60a5fa"/>
            </linearGradient>
          </defs>
        </svg>

        <div class="progress-wrap">
          <div class="progress" aria-label="Прогресс к цели">
            <svg viewBox="0 0 130 130" aria-hidden="true">
              <circle class="ring-bg" cx="65" cy="65" r="52" />
              <circle class="ring-fg" id="goalFg" cx="65" cy="65" r="52" stroke-dasharray="327" stroke-dashoffset="327" />
            </svg>
            <div class="inside">
              <div class="inside-center" style="text-align:center">
                <div class="big" id="goalCurrent">0.0 л</div>
                <div class="muted" id="goalSub">из 3.0 л • 0%</div>
              </div>
            </div>
          </div>
          <div>
            <div class="stat" aria-live="polite">
              <div class="big" id="myTotalWaterLiters">0,0</div>
              <div class="unit">л воды-экв.</div>
            </div>
            <div class="muted" id="myRawTotal" style="margin-top:4px">Всего напитков: 0,0 л</div>
            <div class="goal-controls" style="margin-top:10px">
              <label for="goalInput" class="muted">Цель на день:</label>
              <input id="goalInput" type="number" min="0.5" max="10" step="0.1" placeholder="л" style="width:90px" />
              <span class="muted">л</span>
              <button class="btn secondary" id="saveGoalBtn" title="Сохранить цель">Сохранить</button>
            </div>
            <div class="hint" id="lastAction" style="margin-top:6px"></div>
          </div>
        </div>

        <div class="chipbar" aria-label="Быстро добавить">
          <button class="chip" data-add="250">+ стакан (250 мл)</button>
          <button class="chip" data-add="500">+ бутылка 0,5 л</button>
          <button class="chip" data-add="1500">+ бутылка 1,5 л</button>
        </div>

        <div class="custom-add" style="margin-top:10px">
          <input id="customInput" type="number" min="1" step="1" placeholder="Другое, мл" />
          <button class="btn" id="addCustomBtn">Добавить</button>
          <button class="btn secondary" id="undoBtn" title="Отменить последнее">Отменить</button>
        </div>
        <div class="muted" style="margin-top:6px">Можно добавлять отрицательные значения (например, -250) для коррекции.</div>
      </section>

      <section class="card" id="lbCard" aria-labelledby="lbTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="lbTitle">Таблица лидеров</h2>
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            <div class="tabs" role="tablist">
              <button class="segbtn tab active" data-scope="day" role="tab" aria-selected="true">День</button>
              <button class="segbtn tab" data-scope="month" role="tab" aria-selected="false">Месяц</button>
              <button class="segbtn tab" data-scope="year" role="tab" aria-selected="false">Год</button>
            </div>
            <button class="btn secondary" id="openMonthDailyBtn" title="Показать таблицу по дням месяца">Дни месяца</button>
          </div>
        </div>
        <div class="muted" id="periodLabel" style="margin:8px 0 12px;"></div>
        <div class="lb-list" id="lbList" aria-live="polite"></div>
        <div class="muted" style="margin-top:6px">Рейтинг по воде-эквиваленту; общий объём хранится отдельно.</div>
      </section>

      <section class="card" id="insightsCard" aria-labelledby="insightsTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="insightsTitle">Аналитика сегодня</h2>
          <div class="muted">по воде-эквиваленту</div>
        </div>

        <div class="muted" style="margin-top:6px">Гидратация по часам (сегодня)</div>
        <div class="hour-wrap">
          <div class="y-axis">
            <div class="ylabel">мл</div>
            <div id="yTicks" class="yticks"></div>
          </div>
          <div id="hourChart" class="hour-chart" aria-label="График по часам"></div>
        </div>
        <div class="hour-axis"><span>0</span><span>6</span><span>12</span><span>18</span><span>24</span></div>
        <div id="hourEmpty" class="muted" style="margin-top:8px;text-align:center;display:none;">Пока нет добавлений за сегодня</div>
      </section>

      <section class="card" id="donutCard" aria-labelledby="donutTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="donutTitle">Состав напитков (сегодня)</h2>
          <div class="muted">по воде-эквиваленту</div>
        </div>

        <div class="donut-wrap" style="margin-top:6px">
          <div style="position:relative">
            <canvas id="donutCanvas" width="260" height="260" aria-label="Диаграмма по напиткам"></canvas>
            <div class="donut-center">
              <div style="text-align:center">
                <div class="big" id="donutTotal">0,0 л</div>
                <div class="muted" style="font-size:12px">сегодня</div>
              </div>
            </div>
          </div>
          <div class="legend" id="donutLegend"></div>
        </div>

        <div id="donutEmpty" class="muted" style="margin-top:8px;text-align:center;display:none;">Пока нет данных за сегодня</div>
      </section>

      <!-- Ачивки — теперь в самом низу -->
      <section class="card" id="achCard" aria-labelledby="achTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="achTitle">Ачивки</h2>
          <div class="muted" id="achHint">дневные обновляются каждый день</div>
        </div>
        <div id="achievements" class="ach-grid"></div>
      </section>
    </div>
  </main>

  <footer style="max-width:1100px;margin:26px auto 60px;padding:0 16px;" class="muted">
    Переключатель тем сохраняется в профиле и в браузере. Один HTML-файл, Firebase + Firestore.
  </footer>

  <template id="lbRowTpl">
    <div class="lb-item" style="display:grid;grid-template-columns:28px 1fr auto;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(148,163,184,.22)">
      <div class="muted rank"></div>
      <div class="row" style="gap:10px; overflow:hidden;">
        <div class="avatar av" style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#0a0f1d"></div>
        <div class="name nm" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
      </div>
      <div class="amt am" style="font-weight:800"></div>
    </div>
  </template>

  <div id="monthModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="monthTitle">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div id="monthTitle" style="font-weight:800;font-size:18px">Месяц по дням</div>
          <div class="muted" id="monthSubTitle"></div>
        </div>
        <button class="btn secondary" id="monthCloseBtn">Закрыть</button>
      </div>
      <div style="overflow:auto;">
        <table class="table" id="monthTable">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Вода-экв., л</th>
              <th>Всего, л</th>
              <th>К цели</th>
            </tr>
          </thead>
          <tbody id="monthTableBody"></tbody>
          <tfoot>
            <tr class="tfoot">
              <td>Итого</td>
              <td id="sumWater">0</td>
              <td id="sumTotal">0</td>
              <td id="sumShare">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div id="splashLayer"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection, onSnapshot, orderBy, limit, query, getDocs, increment, where, collectionGroup, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8з2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    setPersistence(auth, browserLocalPersistence).catch(console.warn);
    getRedirectResult(auth).catch(()=>{});

    /* ==== ICONS ==== */
    const ICONS = {
      water:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2s6 7.2 6 11.2A6 6 0 1 1 6 13.2C6 9.2 12 2 12 2Z" stroke="currentColor" stroke-width="1.5"/></svg>`,
      tea:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 10h11a4 4 0 0 1 0 8H9a5 5 0 0 1-5-5v-3Z" stroke="currentColor" stroke-width="1.5"/><path d="M15 10h3a3 3 0 1 1 0 6h-2" stroke="currentColor" stroke-width="1.5"/></svg>`,
      coffee:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 10h10a4 4 0 0 1 0 8H9a5 5 0 0 1-5-5v-3З" stroke="currentColor" stroke-width="1.5"/><path d="M16 10h3a3 3 0 1 1 0 6h-2" stroke="currentColor" stroke-width="1.5"/><path d="M8 4c0 1 .8 1.5.8 2.4S8 8 8 8M11 4c0 1 .8 1.5.8 2.4S11 8 11 8" stroke="currentColor" stroke-width="1.5"/></svg>`.replace('З','Z'),
      milk:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 3h8l-2 3v13a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V6L8 3Z" stroke="currentColor" stroke-width="1.5"/><path d="M10 11h4M10 15h4" stroke="currentColor" stroke-width="1.5"/></svg>`,
      cola_zero:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 3h6l-1 4v9a4 4 0 0 1-4 4h0a4 4 0 0 1-4-4V7l3-4Z" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="1.5"/></svg>`,
      kvass:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 3h10l-1 4v9a4 4 0 0 1-4 4h0a4 4 0 0 1-4-4V7L7 3Z" stroke="currentColor" stroke-width="1.5"/><path d="M8 9h8" stroke="currentColor" stroke-width="1.5"/></svg>`,
      juice:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6h12l-1 3v9a3 3 0 0 1-3 3H10a3 3 0 0 1-3-3V9L6 6Z" stroke="currentColor" stroke-width="1.5"/><path d="M9 3h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      lemonade:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="6" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M5 7h10l-1 3v8a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3V10L5 7Z" stroke="currentColor" stroke-width="1.5"/></svg>`
    };

    const BEVERAGES = [
      { key:'water',    name:'Вода',               factor: 1.00 },
      { key:'tea',      name:'Чай',                factor: 0.98 },
      { key:'coffee',   name:'Кофе',               factor: 0.90 },
      { key:'milk',     name:'Молоко',             factor: 0.87 },
      { key:'cola_zero',name:'Кола лайт/0 сахар',  factor: 0.95 },
      { key:'kvass',    name:'Квас',               factor: 0.92 },
      { key:'juice',    name:'Соки',               factor: 0.90 },
      { key:'lemonade', name:'Лимонады',           factor: 0.90 },
    ];
    const BEV_BY_KEY = Object.fromEntries(BEVERAGES.map(b=>[b.key,b]));

    /* ==== UI refs ==== */
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn= document.getElementById('signOutBtn');
    const userInfoEl= document.getElementById('userInfo');
    const userNameEl= document.getElementById('userName');
    const userAvatarEl=document.getElementById('userAvatar');
    const appEl     = document.getElementById('app');

    const themeClassicBtn = document.getElementById('themeClassicBtn');
    const themeGroovyBtn  = document.getElementById('themeGroovyBtn');
    const themeLabelEl    = document.getElementById('themeLabel');

    const todayLabelEl = document.getElementById('todayLabel');
    const bevGrid = document.getElementById('bevGrid');
    const factorHintEl = document.getElementById('factorHint');

    const myTotalWaterLitersEl = document.getElementById('myTotalWaterLiters');
    const myRawTotalEl         = document.getElementById('myRawTotal');
    const lastActionEl         = document.getElementById('lastAction');

    const addChips = Array.from(document.querySelectorAll('[data-add]'));
    const customInput = document.getElementById('customInput');
    const addCustomBtn= document.getElementById('addCustomBtn');
    const undoBtn     = document.getElementById('undoBtn');

    const lbListEl = document.getElementById('lbList');
    const periodLabelEl = document.getElementById('periodLabel');
    const tabs = Array.from(document.querySelectorAll('.tab'));

    const goalFg = document.getElementById('goalFg');
    const goalCurrent = document.getElementById('goalCurrent');
    const goalSub     = document.getElementById('goalSub');
    const goalInput   = document.getElementById('goalInput');
    const saveGoalBtn = document.getElementById('saveGoalBtn');
    let currentGoalMl = 3000; const CIRC = 2 * Math.PI * 52;

    const monthModal      = document.getElementById('monthModal');
    const monthCloseBtn   = document.getElementById('monthCloseBtn');

    const donutCanvas = document.getElementById('donutCanvas');
    const donutLegend = document.getElementById('donutLegend');
    const donutEmpty  = document.getElementById('donutEmpty');
    const donutTotalEl= document.getElementById('donutTotal');
    const donutCard   = document.getElementById('donutCard');
    const insightsCard= document.getElementById('insightsCard');

    let compMap = Object.create(null); // key -> water_ml

    let currentTheme = null;
    function setThemeButtons(theme){
      themeClassicBtn.classList.toggle('active', theme==='classic');
      themeGroovyBtn.classList.toggle('active', theme==='groovy');
      themeClassicBtn.setAttribute('aria-selected', theme==='classic' ? 'true':'false');
      themeGroovyBtn.setAttribute('aria-selected', theme==='groovy' ? 'true':'false');
      themeLabelEl.textContent = theme==='groovy' ? 'Groovy' : 'Classic';
    }
    function updateRingGradient(theme){
      const s1=document.getElementById('rgStop1'), s2=document.getElementById('rgStop2'), s3=document.getElementById('rgStop3');
      if (theme==='groovy'){ s1.setAttribute('stop-color','#00ffd1'); s2.setAttribute('stop-color','#7df9ff'); s3.setAttribute('stop-color','#ffd166'); }
      else { s1.setAttribute('stop-color','#22d3ee'); s2.setAttribute('stop-color','#60a5fa'); s3.setAttribute('stop-color','#60a5fa'); }
    }
    async function applyTheme(theme, source='local'){
      if (theme!=='classic' && theme!=='groovy') theme='classic';
      if (currentTheme===theme) return;
      document.body.setAttribute('data-theme', theme);
      currentTheme = theme;
      setThemeButtons(theme);
      updateRingGradient(theme);
      try{ localStorage.setItem('theme', theme); }catch{}
      const user = auth.currentUser;
      if (user && source!=='remote'){
        try{ await setDoc(doc(db,'users',user.uid), { theme }, { merge:true }); }catch(e){}
      }
    }

    const pad=(n)=>String(n).padStart(2,'0');
    const keysFor=(date=new Date())=>({ dateStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`, monthStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}`, yearStr:`${date.getFullYear()}` });

    function setRingProgress(ratio){ const clamped = Math.max(0, Math.min(1, ratio || 0)); goalFg.setAttribute('stroke-dasharray', String(CIRC)); goalFg.setAttribute('stroke-dashoffset', String(CIRC * (1 - clamped))); }
    function updateProgressUI(water_ml){
      const goal = Math.max(0, currentGoalMl || 0);
      const ratio = goal > 0 ? water_ml / goal : 0;
      setRingProgress(ratio);
      const curL = (water_ml/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2});
      const goalL= (goal/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2});
      const pct  = Math.round(Math.max(0, Math.min(100, ratio*100)));
      goalCurrent.textContent = `${curL} л`; goalSub.textContent = `из ${goalL} л • ${pct}%`;
    }

    let currentBevKey = 'water';
    function renderBeverages(){
      bevGrid.innerHTML = '';
      BEVERAGES.forEach(b => {
        const btn = document.createElement('button');
        btn.className='bev'+(b.key===currentBevKey?' selected':'');
        btn.type='button'; btn.dataset.key=b.key;
        btn.innerHTML = `${ICONS[b.key]||''}<div class="name">${b.name}</div>`;
        const ic = btn.querySelector('.icon'); if (ic) ic.style.color = b.key==='water' ? 'var(--brand2)' : '#ffd166';
        btn.addEventListener('click', ()=>{ currentBevKey=b.key; updateFactorHint(); renderBeverages(); });
        bevGrid.appendChild(btn);
      });
    }
    function updateFactorHint(){ const bev = BEVERAGES.find(b=>b.key===currentBevKey); factorHintEl.textContent = `Сейчас: ${bev.name} — множитель ×${bev.factor}`; }

    todayLabelEl.textContent = `Сегодня: ${new Date().toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short', year:'numeric'})}`;
    applyTheme((()=>{ try{ return localStorage.getItem('theme'); }catch{return null;}})() || 'classic', 'local');
    themeClassicBtn.addEventListener('click', ()=>applyTheme('classic'));
    themeGroovyBtn.addEventListener('click', ()=>applyTheme('groovy'));

    const provider = new GoogleAuthProvider(); provider.setCustomParameters({ prompt:'select_account' });
    signInBtn.addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth, provider); }
      catch(e){ if (e?.code==='auth/operation-not-supported-in-this-environment' || e?.code==='auth/popup-blocked'){ await signInWithRedirect(auth, provider); } else { alert('Ошибка входа: '+(e?.message||e)); } }
    });
    signOutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

    let unsubMyDaily=null, unsubLB=null, unsubUserDoc=null, unsubAch=null, unsubIntakes=null;

    const cleanupSubscriptions=()=>{
      if (unsubMyDaily){unsubMyDaily();unsubMyDaily=null}
      if (unsubLB){unsubLB();unsubLB=null}
      if (unsubUserDoc){unsubUserDoc();unsubUserDoc=null}
      if (unsubAch){unsubAch();unsubAch=null}
      if (unsubIntakes){unsubIntakes();unsubIntakes=null}
    };

    onAuthStateChanged(auth, async (user)=>{
      if (user){
        appEl.classList.remove('hidden');
        signInBtn.classList.add('hidden'); signOutBtn.classList.remove('hidden'); userInfoEl.classList.remove('hidden');
        userNameEl.textContent = user.displayName || user.email;
        userAvatarEl.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="Аватар" width="32" height="32"/>` : '';

        const userRef = doc(db, 'users', user.uid);
        await setDoc(userRef, { uid:user.uid, displayName:user.displayName||null, email:user.email||null, photoURL:user.photoURL||null, lastLoginAt:serverTimestamp(), createdAt:serverTimestamp() }, { merge:true });

        unsubUserDoc = onSnapshot(userRef, async (snap)=>{
          const d = snap.data() || {};
          if (d.theme && (d.theme==='classic' || d.theme==='groovy')) applyTheme(d.theme, 'remote');
          if (typeof d.daily_goal_ml !== 'number'){ await setDoc(userRef, { daily_goal_ml: 3000 }, { merge:true }); currentGoalMl = 3000; }
          else { currentGoalMl = Math.min(10000, Math.max(500, Math.round(d.daily_goal_ml))); }
          goalInput.value = (currentGoalMl/1000).toFixed(1);
          updateProgressUI(lastWaterMl);
        });

        renderBeverages(); updateFactorHint();
        subscribeMyDailyTotal();
        subscribeIntakesToday();
        renderHourChart();
        subscribeAchievements();
        activateTab('day');
      } else {
        appEl.classList.add('hidden');
        signInBtn.classList.remove('hidden'); signOutBtn.classList.add('hidden'); userInfoEl.classList.add('hidden');
        cleanupSubscriptions(); renderBeverages(); updateFactorHint();
      }
    });

    tabs.forEach(tab => {
      tab.addEventListener('click', () => activateTab(tab.dataset.scope));
      tab.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activateTab(tab.dataset.scope); } });
    });

    function activateTab(scope){
      tabs.forEach(t=>{ const a=t.dataset.scope===scope; t.classList.toggle('active',a); t.setAttribute('aria-selected',a?'true':'false'); });
      if (unsubLB){unsubLB();unsubLB=null;}
      const now = new Date(); const { dateStr, monthStr, yearStr } = keysFor(now);
      let colRef,label;
      if (scope==='day'){ colRef=collection(db,'daily_totals',dateStr,'users'); label=`Сегодня — ${now.toLocaleDateString()}`; }
      else if (scope==='month'){ colRef=collection(db,'monthly_totals',monthStr,'users'); label=`Месяц — ${now.toLocaleString(undefined,{month:'long',year:'numeric'})}`; }
      else { colRef=collection(db,'yearly_totals',yearStr,'users'); label=`Год — ${yearStr}`; }
      periodLabelEl.textContent = label;
      unsubLB = onSnapshot(query(colRef, orderBy('total_water_ml','desc'), limit(50)), (qs)=>renderLeaderboard(qs.docs.map(d=>d.data())));
    }
    function renderLeaderboard(items){
      lbListEl.innerHTML='';
      if (!items.length){ lbListEl.innerHTML='<div class="muted">Пока пусто. Будьте первым! 💧</div>'; return; }
      const tpl = document.getElementById('lbRowTpl');
      items.forEach((it,i)=>{
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.rank').textContent = i+1;
        node.querySelector('.av').innerHTML = it.photoURL ? `<img src="${it.photoURL}" alt="Аватар" width="32" height="32"/>` : '';
        node.querySelector('.nm').textContent = it.displayName || 'Без имени';
        node.querySelector('.am').textContent = `${(Math.max(0,it.total_water_ml||0)/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} л воды-экв.`;
        lbListEl.appendChild(node);
      });
    }

    const splashLayer = document.getElementById('splashLayer');
    function splashAt(x,y,opts={}){ const count = opts.count || 14; for(let i=0;i<count;i++){ const p=document.createElement('div'); p.className='splash-particle'; const angle=Math.random()*Math.PI*2; const dist=40+Math.random()*70; const dx=Math.cos(angle)*dist; const dy=Math.sin(angle)*dist-10; const size=6+Math.random()*8; p.style.setProperty('--dx',dx+'px'); p.style.setProperty('--dy',dy+'px'); p.style.width=size+'px'; p.style.height=size+'px'; p.style.left=(x-size/2)+'px'; p.style.top=(y-size/2)+'px'; if (opts.neg){ p.style.background='radial-gradient(circle at 30% 30%, #fca5a5, #f87171 60%)'; p.style.filter='drop-shadow(0 6px 16px rgba(248,113,113,.25))'; } splashLayer.appendChild(p); p.addEventListener('animationend',()=>p.remove()); } const r=document.createElement('div'); r.className='splash-ripple'; r.style.left=x+'px'; r.style.top=y+'px'; if (opts.neg){ r.style.borderColor='rgba(248,113,113,.7)'; } splashLayer.appendChild(r); r.addEventListener('animationend',()=>r.remove()); }
    function splashNearTotal(neg){ const el=document.getElementById('myTotalWaterLiters'); const rect=el.getBoundingClientRect(); splashAt(rect.left+rect.width/2, rect.top+rect.height/2, {neg:!!neg, count:10}); }

    addChips.forEach(btn=>btn.addEventListener('click',(e)=>{const ml=parseInt(btn.dataset.add,10); addAmount(ml); if(e && e.clientX!=null){ splashAt(e.clientX,e.clientY,{neg:ml<0}); }}));
    addCustomBtn.addEventListener('click', ()=>{ const v=parseInt(customInput.value,10); if (!Number.isFinite(v) || v===0){ toast('Введите количество мл (не 0)'); return; } addAmount(v); customInput.value=''; const r = addCustomBtn.getBoundingClientRect(); splashAt(r.left+r.width/2, r.top+r.height/2, {neg:v<0}); });
    undoBtn.addEventListener('click', undoLast);

    async function addAmount(ml){
      const user=auth.currentUser; if(!user) return;
      const bev = BEVERAGES.find(b=>b.key===currentBevKey) || BEVERAGES[0];
      const water_ml = Math.round(ml * bev.factor);
      const now = new Date(); const { dateStr, monthStr, yearStr } = keysFor(now);

      const batch = writeBatch(db);
      const intakeRef = doc(collection(db,'intakes'));
      batch.set(intakeRef, { uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, ml, beverage:bev.key, beverage_name:bev.name, factor:bev.factor, water_ml, ts:serverTimestamp(), dateStr, monthStr, yearStr });

      const base={ uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, updatedAt:serverTimestamp() };
      batch.set(doc(db,'daily_totals',dateStr,'users',user.uid),   { ...base, dateStr,  total_ml: increment(ml), total_water_ml: increment(water_ml) }, { merge:true });
      batch.set(doc(db,'monthly_totals',monthStr,'users',user.uid),{ ...base, monthStr, total_ml: increment(ml), total_water_ml: increment(water_ml) }, { merge:true });
      batch.set(doc(db,'yearly_totals',yearStr,'users',user.uid), { ...base, yearStr,  total_ml: increment(ml), total_water_ml: increment(water_ml) }, { merge:true });

      await batch.commit();
      splashNearTotal(ml<0);
      toast(`Добавлено: ${ml>0?'+':''}${ml} мл (${bev.name} → ${water_ml} мл воды-экв.)`);
    }

    async function undoLast(){
      const user=auth.currentUser; if(!user) return;
      const { dateStr } = keysFor(new Date());
      const qs = await getDocs(query(collection(db,'intakes'), orderBy('ts','desc'), limit(50)));
      const mine = qs.docs.find(d=> d.data().uid===user.uid && d.data().dateStr===dateStr);
      if (!mine){ toast('Нечего отменять за сегодня'); return; }
      const data = mine.data();
      const wml = data.water_ml || Math.round(data.ml * (data.factor||1));
      const batch = writeBatch(db);
      batch.set(doc(db,'daily_totals',dateStr,'users',user.uid),   { total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'monthly_totals',data.monthStr,'users',user.uid),{ total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'yearly_totals',data.yearStr,'users',user.uid), { total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      await batch.commit();
      toast('Последнее действие отменено');
    }

    const hourChart = document.getElementById('hourChart');
    const hourEmpty = document.getElementById('hourEmpty');
    const yTicksEl  = document.getElementById('yTicks');
    let hourData = new Array(24).fill(0);

    function niceStep(max, target=4){
      if (!isFinite(max) || max<=0) return 250;
      const raw = max / target; const pow = Math.pow(10, Math.floor(Math.log10(raw)));
      const base = raw / pow; let mult = 1; if (base<=1) mult=1; else if (base<=2) mult=2; else if (base<=5) mult=5; else mult=10;
      let step = mult * pow; step = Math.max(50, Math.round(step/50)*50); return step;
    }
    function renderYAxis(niceMax, step){
      if (yTicksEl) {
        const ticks = []; for (let v = niceMax; v >= 0; v -= step) ticks.push(v);
        yTicksEl.innerHTML = ticks.map(v=>`<div class="tick">${v}</div>`).join('');
      }
      if (hourChart) {
        const inner = 120; const grid = document.createElement('div'); grid.className = 'hgrid';
        for (let v = 0; v <= niceMax; v += step) {
          const y = inner - Math.round((v/(niceMax||1)) * inner);
          const line = document.createElement('div'); line.className = 'line'; line.style.top = y + 'px';
          grid.appendChild(line);
        }
        hourChart.appendChild(grid);
      }
    }
    function renderHourChart(){
      hourChart.innerHTML='';
      const total = hourData.reduce((a,b)=>a+b,0);
      hourEmpty.style.display = total > 0 ? 'none' : 'block';
      const defaultMax = 1000, defaultStep = 250;
      if (total <= 0) { renderYAxis(defaultMax, defaultStep); syncHeights(); return; }

      const max = Math.max(1, ...hourData);
      const step = niceStep(max, 4);
      const niceMax = Math.ceil(max / step) * step;
      renderYAxis(niceMax, step);

      for(let i=0;i<24;i++){
        const bar=document.createElement('div'); bar.className='hour-bar';
        const ratio = hourData[i] / (niceMax || 1);
        bar.style.height = Math.max(8, Math.round(120*ratio))+'px';
        bar.title = `${i}:00 — ${hourData[i].toLocaleString()} мл`;
        hourChart.appendChild(bar);
      }
      syncHeights();
    }

    /* ====== Ачивки ====== */

    const ACH_DEFS = [
      // Базовые
      { id:'first_liter', name:'Первый литр', desc:'1 л за день' },
      { id:'goal_today',  name:'Цель достигнута', desc:'Выполнить дневную цель' },
      { id:'streak_3',    name:'Серия ×3', desc:'3 дня подряд' },
      { id:'streak_7',    name:'Серия ×7', desc:'7 дней подряд' },

      // Объём за день / цель (ДНЕВНЫЕ)
      { id:'half_goal',        name:'Разогрелся', desc:'≥50% дневной цели' },
      { id:'camel_4l',         name:'Верблюд', desc:'≥4.0 л за день' },
      { id:'double_goal',      name:'Двойной удар', desc:'≥200% дневной цели' },
      { id:'precision_sniper', name:'Снайпер', desc:'В пределах ±100 мл от цели' },
      { id:'morning_goal',     name:'Ранний финиш', desc:'Цель до 15:00' },

      // Серии (НЕ дневные)
      { id:'streak_14', name:'Две недели', desc:'Серия 14' },
      { id:'streak_30', name:'Железный', desc:'Серия 30' },
      { id:'perfect_week_7', name:'Идеальная неделя', desc:'7/7 дней этой недели' },
      { id:'monthly_20', name:'Месячный марафон', desc:'≥20 дней в месяце' },
      { id:'comeback', name:'Камбек', desc:'После провала — выполнено' },

      // Долгосрочные (НЕ дневные)
      { id:'lifetime_100l', name:'Сотня', desc:'100 л всего' },
      { id:'lifetime_500l', name:'Пол-океана', desc:'500 л всего' },
      { id:'lifetime_1000l', name:'Тысяча', desc:'1000 л всего' },

      // Поведение (ДНЕВНЫЕ)
      { id:'early_bird',  name:'Жаворонок', desc:'Первый приём до 09:00' },
      { id:'night_owl',   name:'Сова', desc:'Приём после 22:00' },
      { id:'hourly_6',    name:'Ниндзя часов', desc:'В 6+ разных часах суток' },
      { id:'pacer_10',    name:'Ровный темп', desc:'10+ добавлений за день' },
      { id:'no_corrections', name:'Без правок', desc:'Без отрицательных добавлений' },

      // Разнообразие (ДНЕВНЫЕ)
      { id:'diversity_4',   name:'Дегустатор', desc:'4+ типов напитков за день' },
      { id:'pure_water_day',name:'Кристально', desc:'Только вода за день' },
    ];

    const DAILY_ACH_IDS = new Set([
      'first_liter','goal_today','half_goal','camel_4l','double_goal','precision_sniper','morning_goal',
      'early_bird','night_owl','hourly_6','pacer_10','no_corrections','diversity_4','pure_water_day'
    ]);

    const badge = (color, text)=>`
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g>
        <circle cx="32" cy="32" r="22" fill="${color}" opacity=".9"/>
        <circle cx="32" cy="32" r="14" fill="#0b0d24" opacity=".28"/>
        <text x="32" y="37" text-anchor="middle" font-size="16" fill="#ffffff" font-family="Inter, Arial" font-weight="700">${text}</text>
      </g></svg>`;
    const ACH_SVGS = {
      first_liter:      badge('#00c2ff','1L'),
      goal_today:       badge('#ffd166','✓'),
      streak_3:         badge('#7df9ff','3'),
      streak_7:         badge('#00ffd1','7'),

      half_goal:        badge('#60a5fa','50%'),
      camel_4l:         badge('#34d399','4L'),
      double_goal:      badge('#f472b6','2×'),
      precision_sniper: badge('#f59e0b','±100'),
      morning_goal:     badge('#a78bfa','AM'),

      streak_14:        badge('#22c55e','14'),
      streak_30:        badge('#eab308','30'),
      perfect_week_7:   badge('#f97316','7/7'),
      monthly_20:       badge('#38bdf8','20+'),
      comeback:         badge('#ef4444','↺'),

      lifetime_100l:    badge('#22d3ee','100'),
      lifetime_500l:    badge('#60a5fa','500'),
      lifetime_1000l:   badge('#a78bfa','1k'),

      early_bird:       badge('#16a34a','☀️'),
      night_owl:        badge('#6366f1','🌙'),
      hourly_6:         badge('#10b981','⏱'),
      pacer_10:         badge('#f43f5e','×10'),
      no_corrections:   badge('#84cc16','OK'),

      diversity_4:      badge('#fb7185','4️⃣'),
      pure_water_day:   badge('#0ea5e9','💧'),
    };

    const achGrid = document.getElementById('achievements');
    let unlockedAll = new Set();   // постоянные (и любые не-дневные)
    let unlockedToday = new Set(); // дневные за сегодня

    function renderAchievements(){
      const today = keysFor(new Date()).dateStr;
      achGrid.innerHTML='';
      ACH_DEFS.forEach(a=>{
        const isDaily = DAILY_ACH_IDS.has(a.id);
        const has = isDaily ? unlockedToday.has(a.id) : unlockedAll.has(a.id);
        const el=document.createElement('div');
        el.className='ach'+(has?'':' locked');
        el.innerHTML=`<div class="ach-ill">${ACH_SVGS[a.id]||badge('#64748b','?')}</div>
          <div class="ach-title">${a.name}</div><div class="ach-sub">${a.desc}${isDaily ? ' • сегодня' : ''}</div>`;
        achGrid.appendChild(el);
      });
    }

    function subscribeAchievements(){
      if (unsubAch) unsubAch();
      const uid=auth.currentUser?.uid; if (!uid) return;
      const today = keysFor(new Date()).dateStr;
      unlockedAll = new Set();
      unlockedToday = new Set();
      unsubAch = onSnapshot(collection(db,'users',uid,'achievements'), (qs)=>{
        unlockedAll.clear(); unlockedToday.clear();
        qs.forEach(docSnap=>{
          const x = docSnap.data()||{};
          const baseId = x.id || null; // сохраняем исходный id
          if (!baseId) return;
          const isDaily = x.daily === true || DAILY_ACH_IDS.has(baseId);
          if (isDaily){
            if (x.dateStr === today) unlockedToday.add(baseId);
          } else {
            unlockedAll.add(baseId);
          }
        });
        renderAchievements();
      });
    }

    // защита от повторной записи в одну сессию
    const emittedAchDocIds = new Set();
    async function recordAchievement(id,payload={}){
      const uid=auth.currentUser?.uid; if (!uid) return;
      const isDaily = DAILY_ACH_IDS.has(id);
      const ds = payload.dateStr || keysFor(new Date()).dateStr;
      const docId = isDaily ? `${id}_${ds}` : id;
      if (emittedAchDocIds.has(docId)) return;
      emittedAchDocIds.add(docId);
      await setDoc(doc(db,'users',uid,'achievements',docId), { id, daily:isDaily, dateStr: ds, unlockedAt: serverTimestamp(), ...payload }, { merge:true });
    }

    function ymdShift(date,delta){ const dt=new Date(date); dt.setDate(dt.getDate()+delta); const y=dt.getFullYear(); const m=('0'+(dt.getMonth()+1)).slice(-2); const d=('0'+dt.getDate()).slice(-2); return `${y}-${m}-${d}`; }
    function startOfWeek(d){ const dt=new Date(d); const day=(dt.getDay()+6)%7; dt.setHours(0,0,0,0); dt.setDate(dt.getDate()-day); return dt; }
    function onSnapshotOnce(ref){ return new Promise((resolve)=>{ const unsub=onSnapshot(ref,(snap)=>{ resolve(snap); unsub(); },{includeMetadataChanges:false}); }); }

    async function fetchDailyWater(uid, dateStr){
      const ds = await getDoc(doc(db,'daily_totals', dateStr, 'users', uid));
      if (!ds.exists()) return 0;
      const x = ds.data(); return Math.max(0, x.total_water_ml||0);
    }
    async function countWeekGoals(uid, when, goal){
      const start = startOfWeek(when);
      let hits=0;
      for (let i=0;i<7;i++){
        const d = new Date(start); d.setDate(d.getDate()+i);
        const ds = keysFor(d).dateStr;
        const w = await fetchDailyWater(uid, ds);
        if (w >= goal) hits++;
      }
      return hits;
    }
    async function countMonthGoalHits(uid, date, goal){
      const year = date.getFullYear(); const month = date.getMonth();
      const rows = await fetchMonthRowsSafe(uid, year, month);
      return rows.reduce((acc,r)=> acc + ((r.total_water_ml||0) >= goal ? 1 : 0), 0);
    }
    async function lifetimeTotalWater(uid){
      const cg = await getDocs(query(collectionGroup(db,'users'), where('uid','==',uid)));
      let sum = 0;
      cg.forEach(d=>{
        const x=d.data();
        if (x.yearStr && typeof x.total_water_ml === 'number') sum += Math.max(0, x.total_water_ml);
      });
      return sum;
    }

    function toast(msg){ lastActionEl.textContent = msg; lastActionEl.classList.add('success'); setTimeout(()=>{ lastActionEl.textContent=''; lastActionEl.classList.remove('success'); }, 2500); }

    let lastWaterMl = 0;
    function subscribeMyDailyTotal(){
      if (unsubMyDaily) unsubMyDaily();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const ref = doc(db, 'daily_totals', dateStr, 'users', uid);
      unsubMyDaily = onSnapshot(ref, async (snap)=>{
        const d = snap.exists()? snap.data() : { total_water_ml:0, total_ml:0 };
        const water = d.total_water_ml || 0; const raw = d.total_ml || 0;
        lastWaterMl = water;
        myTotalWaterLitersEl.textContent = (water/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2});
        myRawTotalEl.textContent = `Всего напитков: ${(raw/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} л`;
        updateProgressUI(water);
        await checkStreakAndAchievements(water, todayIntakes);
      });
    }

    function liters(n_ml){ return (n_ml/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2}); }
    function goalPct(w, goalMl){ if (!goalMl) return '—'; return Math.round((w/goalMl)*100)+'%'; }

    async function fetchMonthRowsSafe(uid, year, monthIndex){
      const monthStr = year + '-' + String(monthIndex+1).padStart(2,'0');
      const daysInMonth = new Date(year, monthIndex+1, 0).getDate();
      const rows = Array.from({length:daysInMonth}, (_,i)=>({ day:i+1, dateStr: `${monthStr}-${String(i+1).padStart(2,'0')}`, total_water_ml:0, total_ml:0 }));

      try{
        const startStr = `${monthStr}-01`;
        const endStr   = `${monthStr}-31`;
        const cg = query(
          collectionGroup(db, 'users'),
          where('uid','==', uid),
          where('dateStr','>=', startStr),
          where('dateStr','<=', endStr),
          orderBy('dateStr','asc')
        );
        const snap = await getDocs(cg);
        snap.forEach(d=>{
          const x = d.data();
          const ds = x.dateStr;
          const idx = parseInt(ds.slice(-2), 10) - 1;
          if (idx>=0 && idx<rows.length){
            rows[idx].total_water_ml = Math.max(0, x.total_water_ml||0);
            rows[idx].total_ml = Math.max(0, x.total_ml||0);
          }
        });
        return rows;
      } catch{
        const promises = rows.map(async (r)=>{
          const ref = doc(db,'daily_totals', r.dateStr, 'users', uid);
          const ds  = await getDoc(ref);
          if (ds.exists()){
            const x = ds.data();
            r.total_water_ml = Math.max(0, x.total_water_ml||0);
            r.total_ml       = Math.max(0, x.total_ml||0);
          }
          return r;
        });
        return Promise.all(promises);
      }
    }

    document.getElementById('openMonthDailyBtn').addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user) return;
      const now = new Date();
      const rows = await fetchMonthRowsSafe(user.uid, now.getFullYear(), now.getMonth());

      let sumW=0, sumT=0;
      const body = document.getElementById('monthTableBody');
      body.innerHTML = rows.map(r=>{
        sumW += r.total_water_ml; sumT += r.total_ml;
        return `<tr>
          <td>${new Date(r.dateStr).toLocaleDateString(undefined,{day:'2-digit', month:'short', weekday:'short'})}</td>
          <td>${liters(r.total_water_ml)}</td>
          <td>${liters(r.total_ml)}</td>
          <td>${goalPct(r.total_water_ml, currentGoalMl)}</td>
        </tr>`;
      }).join('');
      document.getElementById('sumWater').textContent = liters(sumW);
      document.getElementById('sumTotal').textContent = liters(sumT);
      document.getElementById('sumShare').textContent = '—';

      document.getElementById('monthTitle').textContent = 'Месяц по дням';
      document.getElementById('monthSubTitle').textContent = new Date(now.getFullYear(), now.getMonth(), 1).toLocaleDateString(undefined,{month:'long', year:'numeric'});
      document.getElementById('monthModal').style.display = 'flex';
    });

    document.getElementById('monthCloseBtn').addEventListener('click', ()=>{ document.getElementById('monthModal').style.display='none'; });
    document.getElementById('monthModal').addEventListener('click', (e)=>{ if (e.target === document.getElementById('monthModal')) document.getElementById('monthModal').style.display='none'; });

    const PALETTE = ['#00ffd1','#7df9ff','#ff6ad5','#ffd166','#a78bfa','#ff8fab','#8aff80','#f5a3ff'];

    function drawDonut(){
      if (!donutCanvas) return;
      const dpr = window.devicePixelRatio || 1;
      const W = 260, H = 260;
      donutCanvas.width = W * dpr; donutCanvas.height = H * dpr;
      donutCanvas.style.width = W + 'px'; donutCanvas.style.height= H + 'px';
      const ctx = donutCanvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,W,H);

      const entries = Object.entries(compMap).filter(([k,v])=>v>0);
      const total = entries.reduce((s,[,v])=>s+v,0);
      donutTotalEl.textContent = (total/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2}) + ' л';

      donutEmpty.style.display = total>0 ? 'none':'block';
      donutLegend.innerHTML = '';

      const cx = W/2, cy = H/2, R = 100, r = 66;
      if (total <= 0){
        ctx.globalAlpha = .18;
        ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.arc(cx,cy,r,Math.PI*2,0,true);
        ctx.closePath(); ctx.fillStyle = '#ffffff22'; ctx.fill(); ctx.globalAlpha = 1;
        syncHeights(); return;
      }

      let start = -Math.PI/2; const gap = 0.02;
      entries.sort((a,b)=>b[1]-a[1]).forEach(([key,val],i)=>{
        const frac = val/total; const ang  = Math.max(0.04, frac * Math.PI*2) - gap; const end  = start + ang;
        ctx.beginPath(); ctx.arc(cx,cy,R,start,end); ctx.arc(cx,cy,r,end,start,true); ctx.closePath();
        ctx.fillStyle = PALETTE[i % PALETTE.length]; ctx.fill(); start = end + gap;
      });

      entries.forEach(([key,val],i)=>{
        const bev = BEV_BY_KEY[key] || { name: key };
        const node = document.createElement('div');
        node.className = 'legend-item';
        node.innerHTML = `
          <div class="legend-dot" style="background:${PALETTE[i % PALETTE.length]}"></div>
          <div>
            <div>${bev.name || key}</div>
            <div class="legend-sub">${(val/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} л • ${Math.round((val/Math.max(1,total))*100)}%</div>
          </div>`;
        donutLegend.appendChild(node);
      });

      syncHeights();
    }

    saveGoalBtn.addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user) return;
      const liters = parseFloat(goalInput.value);
      if (!Number.isFinite(liters)){ alert('Введите цель в литрах'); return; }
      const clamped = Math.min(10, Math.max(0.5, liters));
      const ml = Math.round(clamped*1000);
      await setDoc(doc(db,'users', user.uid), { daily_goal_ml: ml }, { merge:true });
      currentGoalMl = ml; updateProgressUI(lastWaterMl);
      toast(`Цель сохранена: ${clamped.toFixed(1)} л/день`);
    });

    // Синхронизация высот «Аналитика ↔ Пончик»
    function syncHeights(){
      const desktop = window.matchMedia('(min-width: 961px)').matches;
      if (!desktop){ insightsCard.style.height=''; return; }
      requestAnimationFrame(()=>{ insightsCard.style.height = donutCard.offsetHeight + 'px'; });
    }
    window.addEventListener('resize', ()=>syncHeights());
    if ('ResizeObserver' in window){
      const ro = new ResizeObserver(()=>syncHeights());
      ro.observe(donutCard); ro.observe(insightsCard);
    }
    renderBeverages(); updateFactorHint(); requestAnimationFrame(()=>{ syncHeights(); });

    // ====== СЕГОДНЯШНИЕ ПРИЁМЫ ======
    let todayIntakes = [];
    function subscribeIntakesToday(){
      if (unsubIntakes) unsubIntakes();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const qy = query(collection(db,'intakes'), where('uid','==',uid), where('dateStr','==',dateStr));
      unsubIntakes = onSnapshot(qy, async (qs)=>{
        hourData = new Array(24).fill(0);
        compMap = Object.create(null);
        todayIntakes = [];
        qs.forEach(d=>{
          const it=d.data();
          const ts=it.ts?.toDate ? it.ts.toDate() : new Date();
          const h=(ts instanceof Date) ? ts.getHours() : 0;
          const ml = it.ml || 0;
          const wml = Math.max(0, it.water_ml ?? Math.round(ml * (it.factor||1)));
          if (h>=0 && h<24) hourData[h] += wml;
          const key = it.beverage || 'unknown';
          compMap[key] = (compMap[key]||0) + wml;
          todayIntakes.push({ ts, ml, water_ml: wml, beverage: key });
        });
        renderHourChart();
        drawDonut();
        await checkStreakAndAchievements(lastWaterMl || hourData.reduce((a,b)=>a+b,0), todayIntakes);
      });
    }

    // ====== Ачивки / streaks / долгосрочные ======
    async function checkStreakAndAchievements(todayWater, intakes = []){
      const user=auth.currentUser; if(!user) return;
      const userRef = doc(db,'users',user.uid);
      const uSnap = await onSnapshotOnce(userRef); const u = uSnap.data()||{};
      const goal = typeof u.daily_goal_ml === 'number' ? u.daily_goal_ml : 3000;
      const todayStr = keysFor(new Date()).dateStr;
      const yesterdayStr = ymdShift(new Date(), -1);

      // Объём / цель (дневные)
      if (todayWater >= 1000) await recordAchievement('first_liter', { dateStr: todayStr });
      if (todayWater >= goal)  await recordAchievement('goal_today',  { dateStr: todayStr, goal_ml: goal });
      if (todayWater >= 0.5*goal) await recordAchievement('half_goal', { dateStr: todayStr, goal_ml: goal });
      if (todayWater >= 4000) await recordAchievement('camel_4l', { dateStr: todayStr });
      if (todayWater >= 2*goal) await recordAchievement('double_goal', { dateStr: todayStr, goal_ml: goal });
      if (Math.abs(todayWater - goal) <= 100 && todayWater>0) await recordAchievement('precision_sniper', { dateStr: todayStr, goal_ml: goal, delta_ml: todayWater - goal });

      // Утренняя цель
      if (intakes.length && todayWater >= goal){
        const sorted = [...intakes].sort((a,b)=> (a.ts?.getTime?.()||0)-(b.ts?.getTime?.()||0));
        let cum=0, crossed=null;
        for (const it of sorted){ cum += it.water_ml||0; if (cum >= goal){ crossed = it.ts; break; } }
        if (crossed && crossed.getHours() < 15) await recordAchievement('morning_goal', { dateStr: todayStr, hour: crossed.getHours() });
      }

      // Поведение / разнообразие (дневные)
      if (intakes.length){
        const sorted = [...intakes].sort((a,b)=> (a.ts?.getTime?.()||0)-(b.ts?.getTime?.()||0));
        const firstH = sorted[0]?.ts?.getHours?.();
        const lastH  = sorted[sorted.length-1]?.ts?.getHours?.();
        if (typeof firstH==='number' && firstH < 9) await recordAchievement('early_bird', { dateStr: todayStr, hour:firstH });
        if (typeof lastH==='number'  && lastH >=22) await recordAchievement('night_owl', { dateStr: todayStr, hour:lastH });

        const distinctHours = hourData.reduce((acc,v)=> acc + (v>0?1:0), 0);
        if (distinctHours >= 6) await recordAchievement('hourly_6', { dateStr: todayStr, hours: distinctHours });

        const addsCount = intakes.length;
        if (addsCount >= 10) await recordAchievement('pacer_10', { dateStr: todayStr, count: addsCount });

        const hasNegative = intakes.some(it=> (it.ml||0) < 0);
        if (!hasNegative && addsCount>0) await recordAchievement('no_corrections', { dateStr: todayStr });

        const typesCount = Object.keys(compMap).length;
        if (typesCount >= 4) await recordAchievement('diversity_4', { dateStr: todayStr, types: typesCount });
        if (typesCount === 1 && compMap.water>0) await recordAchievement('pure_water_day', { dateStr: todayStr });
      }

      // Серии (постоянные)
      if (todayWater >= goal){
        const lastDone = u.streak_last_completed_dateStr;
        const isYesterdayDone = (lastDone === yesterdayStr);
        const willBeCurrent = isYesterdayDone ? (u.streak_current||0)+1 : 1;
        if (lastDone !== todayStr){
          const best = Math.max(u.streak_best||0, willBeCurrent);
          await setDoc(userRef, { streak_current: willBeCurrent, streak_best: best, streak_last_completed_dateStr: todayStr }, { merge:true });
        }
        if (willBeCurrent >= 14) await recordAchievement('streak_14', { dateStr: todayStr, streak: willBeCurrent });
        if (willBeCurrent >= 30) await recordAchievement('streak_30', { dateStr: todayStr, streak: willBeCurrent });
        if (!isYesterdayDone) await recordAchievement('comeback', { dateStr: todayStr });
        const weekHits = await countWeekGoals(user.uid, new Date(), goal);
        if (weekHits >= 7) await recordAchievement('perfect_week_7', { dateStr: todayStr });
        const monthHits = await countMonthGoalHits(user.uid, new Date(), goal);
        if (monthHits >= 20) await recordAchievement('monthly_20', { dateStr: todayStr, count: monthHits });
      }

      // Долгосрочные (постоянные)
      const life = await lifetimeTotalWater(user.uid);
      if (life >= 100*1000)  await recordAchievement('lifetime_100l',  { total_ml: life });
      if (life >= 500*1000)  await recordAchievement('lifetime_500l', { total_ml: life });
      if (life >= 1000*1000) await recordAchievement('lifetime_1000l',{ total_ml: life });
    }
  </script>
</body>
</html>
