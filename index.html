<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞ ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ø–æ –≤–æ–¥–µ</title>
  <!--
  ==========================
  –í–ê–ñ–ù–û: –ö–ê–ö –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–û–ï–ö–¢
  ==========================
  1) –í Firebase –≤–∫–ª—é—á–µ–Ω—ã Authentication (Google) –∏ Firestore (Production mode).
  2) –í—Å—Ç–∞–≤–ª–µ–Ω –∫–æ–Ω—Ñ–∏–≥ –Ω–∏–∂–µ.
  3) –ü—Ä–∞–≤–∏–ª–∞ Firestore –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã (—Å–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è).
  4) –î–æ–º–µ–Ω funikov.github.io –¥–æ–±–∞–≤–ª–µ–Ω –≤ Authentication ‚Üí Settings ‚Üí Authorized domains.
  -->
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --muted: #94a3b8; --text: #e5e7eb; --brand: #22d3ee; --accent: #60a5fa; --card: #0b1220; --good: #34d399; --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background: linear-gradient(180deg, #0b1020 0%, #0f172a 100%); color: var(--text); }
    header { position: sticky; top: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 14px 18px; background: rgba(15,23,42,.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(148,163,184,.12); }
    .brand { display: flex; gap: 10px; align-items: center; }
    .drop { width: 28px; height: 28px; border-radius: 8px; background: radial-gradient(circle at 30% 25%, #7dd3fc, #22d3ee 60%, #60a5fa); box-shadow: inset 0 0 10px rgba(255,255,255,.2), 0 8px 18px rgba(34,211,238,.3); }
    .title { font-weight: 700; letter-spacing: .2px; }
    .subtitle { font-size: 12px; color: var(--muted); }
    .row { display: flex; gap: 12px; align-items: center; }
    .btn { border: 0; color: #0b1020; background: var(--brand); padding: 10px 14px; border-radius: 999px; cursor: pointer; font-weight: 700; }
    .btn:hover { filter: brightness(1.05); }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid rgba(148,163,184,.3); }
    main { max-width: 1100px; margin: 18px auto; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    @media (max-width: 960px){ .grid { grid-template-columns: 1fr; } }
    .card { background: linear-gradient(180deg, rgba(96,165,250,.10), rgba(34,211,238,.06)); border: 1px solid rgba(148,163,184,.16); border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; }
    h2 { margin: 0 0 10px 0; font-size: 20px; }
    .stat { display: flex; align-items: baseline; gap: 10px; }
    .stat .big { font-size: 42px; font-weight: 800; letter-spacing: .3px; }
    .stat .unit { color: var(--muted); }
    .chipbar { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0 10px; }
    .chip { border: 1px dashed rgba(148,163,184,.35); color: var(--text); background: rgba(2,6,23,.35); padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    .custom-add { display: flex; gap: 10px; align-items: center; }
    .custom-add input { width: 120px; background: #0a0f1d; color: var(--text); border: 1px solid rgba(148,163,184,.28); border-radius: 10px; padding: 8px 10px; }
    .tabs { display: flex; gap: 6px; border-bottom: 1px solid rgba(148,163,184,.16); margin-bottom: 10px; }
    .tab { background: transparent; color: var(--text); border: 0; padding: 10px 14px; cursor: pointer; }
    .tab.active { color: var(--brand); border-bottom: 2px solid var(--brand); font-weight: 700; }
    .lb-list { display: grid; gap: 10px; }
    .lb-item { display: grid; grid-template-columns: 32px 1fr auto; gap: 12px; align-items: center; background: var(--card); border-radius: 14px; padding: 10px 12px; border: 1px solid rgba(148,163,184,.12); }
    .avatar { width: 32px; height: 32px; border-radius: 50%; background: #0a0f1d; overflow: hidden; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .name { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .amt { font-weight: 800; }
    .muted { color: var(--muted); }
    .hidden { display: none !important; }
    .success { color: var(--good); font-weight: 700; }
    footer { margin: 26px auto 60px; max-width: 1100px; padding: 0 16px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="drop" aria-hidden="true"></div>
      <div>
        <div class="title">–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞</div>
        <div class="subtitle">–ö—Ç–æ –≤—ã–ø—å–µ—Ç –±–æ–ª—å—à–µ –≤–æ–¥—ã —Å–µ–≥–æ–¥–Ω—è? üíß</div>
      </div>
    </div>

    <div class="row" id="authRow">
      <div class="row hidden" id="userInfo">
        <div class="avatar" id="userAvatar"></div>
        <div class="name" id="userName"></div>
      </div>
      <button class="btn" id="signInBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      <button class="btn secondary hidden" id="signOutBtn">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <main id="app" class="hidden">
    <div class="grid">
      <section class="card" aria-labelledby="myDayTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="myDayTitle">–ú–æ–π –¥–µ–Ω—å</h2>
          <div class="muted" id="todayLabel"></div>
        </div>

        <div class="stat" aria-live="polite">
          <div class="big" id="myTotalLiters">0,0</div>
          <div class="unit">–ª–∏—Ç—Ä–∞</div>
        </div>
        <div class="hint" id="lastAction"></div>

        <div class="chipbar" aria-label="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å">
          <button class="chip" data-add="250">+ —Å—Ç–∞–∫–∞–Ω (250 –º–ª)</button>
          <button class="chip" data-add="500">+ –±—É—Ç—ã–ª–∫–∞ 0,5 –ª</button>
          <button class="chip" data-add="1500">+ –±—É—Ç—ã–ª–∫–∞ 1,5 –ª</button>
        </div>

        <div class="custom-add">
          <input id="customInput" type="number" min="1" step="1" placeholder="–î—Ä—É–≥–æ–µ, –º–ª" />
          <button class="btn" id="addCustomBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn secondary" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="hint">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, -250) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.</div>
      </section>

      <section class="card" aria-labelledby="lbTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="lbTitle">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
          <div class="muted" id="periodLabel"></div>
        </div>
        <div class="tabs" role="tablist">
          <button class="tab active" data-scope="day" role="tab" aria-selected="true">–î–µ–Ω—å</button>
          <button class="tab" data-scope="month" role="tab" aria-selected="false">–ú–µ—Å—è—Ü</button>
          <button class="tab" data-scope="year" role="tab" aria-selected="false">–ì–æ–¥</button>
        </div>
        <div class="lb-list" id="lbList" aria-live="polite"></div>
        <div class="hint">–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</div>
      </section>
    </div>
  </main>

  <footer>
    –°–¥–µ–ª–∞–Ω–æ –Ω–∞ Firebase. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ. –û–¥–∏–Ω HTML‚Äë—Ñ–∞–π–ª, –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é –Ω–∞ GitHub Pages / Firebase Hosting.
  </footer>

  <template id="lbRowTpl">
    <div class="lb-item">
      <div class="muted rank"></div>
      <div class="row" style="gap:10px; overflow:hidden;">
        <div class="avatar av"></div>
        <div class="name nm"></div>
      </div>
      <div class="amt am"></div>
    </div>
  </template>

  <script type="module">
    // Firebase SDK (modular)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection, onSnapshot, orderBy, limit, query, getDocs, increment } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // === –ö–æ–Ω—Ñ–∏–≥ –ø—Ä–æ–µ–∫—Ç–∞ (–∏–∑ —Ç–≤–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8z2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π redirect-–ø–æ—Ç–æ–∫
    setPersistence(auth, browserLocalPersistence).catch(console.warn);
    getRedirectResult(auth).catch(() => {});

    // === –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const appEl = document.getElementById('app');
    const todayLabelEl = document.getElementById('todayLabel');
    const addChips = Array.from(document.querySelectorAll('[data-add]'));
    const customInput = document.getElementById('customInput');
    const addCustomBtn = document.getElementById('addCustomBtn');
    const undoBtn = document.getElementById('undoBtn');
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const myTotalLitersEl = document.getElementById('myTotalLiters');
    const lastActionEl = document.getElementById('lastAction');
    const lbListEl = document.getElementById('lbList');
    const periodLabelEl = document.getElementById('periodLabel');

    const pad = (n) => String(n).padStart(2, '0');
    const keysFor = (date = new Date()) => ({
      dateStr: `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`,
      monthStr: `${date.getFullYear()}-${pad(date.getMonth()+1)}`,
      yearStr: `${date.getFullYear()}`,
    });
    todayLabelEl.textContent = `–°–µ–≥–æ–¥–Ω—è: ${new Date().toLocaleDateString(undefined, { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' })}`;

    // === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    signInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      if (window.location.protocol === 'file:') {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ http/https (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitHub Pages –∏–ª–∏ Firebase Hosting).');
        return;
      }
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        if (e && (e.code === 'auth/operation-not-supported-in-this-environment' || e.code === 'auth/popup-blocked')) {
          await signInWithRedirect(auth, provider);
        } else {
          console.error(e);
          alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (e?.message || e));
        }
      }
    });

    signOutBtn.addEventListener('click', async () => { await signOut(auth); });

    let unsubMyDaily = null; let unsubLB = null;
    const cleanupSubscriptions = () => { if (unsubMyDaily) { unsubMyDaily(); unsubMyDaily = null; } if (unsubLB) { unsubLB(); unsubLB = null; } };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        appEl.classList.remove('hidden');
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        userInfoEl.classList.remove('hidden');
        userNameEl.textContent = user.displayName || user.email;
        userAvatarEl.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä" />` : '';
        await setDoc(doc(db, 'users', user.uid), {
          uid: user.uid,
          displayName: user.displayName || null,
          email: user.email || null,
          photoURL: user.photoURL || null,
          lastLoginAt: serverTimestamp(),
          createdAt: serverTimestamp(),
        }, { merge: true });
        subscribeMyDailyTotal();
        activateTab('day');
      } else {
        appEl.classList.add('hidden');
        signInBtn.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        userInfoEl.classList.add('hidden');
        cleanupSubscriptions();
      }
    });

    // === –î–µ–π—Å—Ç–≤–∏—è
    addChips.forEach(btn => btn.addEventListener('click', () => addAmount(parseInt(btn.dataset.add, 10))));
    addCustomBtn.addEventListener('click', () => { const v = parseInt(customInput.value, 10); if (!Number.isFinite(v) || v === 0) { toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–ª (–Ω–µ 0)'); return; } addAmount(v); customInput.value=''; });
    undoBtn.addEventListener('click', () => undoLast());
    tabs.forEach(t => t.addEventListener('click', () => activateTab(t.dataset.scope)));

    function toast(msg){ lastActionEl.textContent = msg; lastActionEl.classList.add('success'); setTimeout(() => { lastActionEl.textContent=''; lastActionEl.classList.remove('success'); }, 2500); }

    function subscribeMyDailyTotal(){
      if (unsubMyDaily) unsubMyDaily();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const ref = doc(db, 'daily_totals', dateStr, 'users', uid);
      unsubMyDaily = onSnapshot(ref, (snap) => {
        const total = snap.exists() ? (snap.data().total_ml || 0) : 0;
        myTotalLitersEl.textContent = (total / 1000).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 2 });
      });
    }

    function activateTab(scope){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.scope === scope));
      if (unsubLB) { unsubLB(); unsubLB = null; }
      const now = new Date();
      const { dateStr, monthStr, yearStr } = keysFor(now);
      let colRef, label;
      if (scope === 'day') { colRef = collection(db, 'daily_totals', dateStr, 'users'); label = `–°–µ–≥–æ–¥–Ω—è ‚Äî ${now.toLocaleDateString()}`; }
      else if (scope === 'month') { colRef = collection(db, 'monthly_totals', monthStr, 'users'); label = `–ú–µ—Å—è—Ü ‚Äî ${now.toLocaleString(undefined, { month: 'long', year: 'numeric' })}`; }
      else { colRef = collection(db, 'yearly_totals', yearStr, 'users'); label = `–ì–æ–¥ ‚Äî ${yearStr}`; }
      periodLabelEl.textContent = label;
      const q = query(colRef, orderBy('total_ml', 'desc'), limit(50));
      unsubLB = onSnapshot(q, (qs) => renderLeaderboard(qs.docs.map(d => d.data())));
    }

    function renderLeaderboard(items){
      lbListEl.innerHTML = '';
      if (!items.length) { lbListEl.innerHTML = '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üíß</div>'; return; }
      const tpl = document.getElementById('lbRowTpl');
      items.forEach((it, idx) => {
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.rank').textContent = idx + 1;
        node.querySelector('.av').innerHTML = it.photoURL ? `<img src="${it.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä"/>` : '';
        node.querySelector('.nm').textContent = it.displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        node.querySelector('.am').textContent = `${(Math.max(0, it.total_ml || 0) / 1000).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 2 })} –ª`;
        lbListEl.appendChild(node);
      });
    }

    async function addAmount(ml){
      const user = auth.currentUser; if (!user) return;
      const now = new Date();
      const { dateStr, monthStr, yearStr } = keysFor(now);
      const batch = writeBatch(db);
      const intakeRef = doc(collection(db, 'intakes'));
      batch.set(intakeRef, { uid: user.uid, displayName: user.displayName || null, photoURL: user.photoURL || null, ml, ts: serverTimestamp(), dateStr, monthStr, yearStr });
      const base = { uid: user.uid, displayName: user.displayName || null, photoURL: user.photoURL || null, updatedAt: serverTimestamp() };
      batch.set(doc(db, 'daily_totals', dateStr, 'users', user.uid), { ...base, dateStr, total_ml: increment(ml) }, { merge: true });
      batch.set(doc(db, 'monthly_totals', monthStr, 'users', user.uid), { ...base, monthStr, total_ml: increment(ml) }, { merge: true });
      batch.set(doc(db, 'yearly_totals', yearStr, 'users', user.uid), { ...base, yearStr, total_ml: increment(ml) }, { merge: true });
      await batch.commit();
      toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${ml > 0 ? '+' : ''}${ml} –º–ª`);
    }

    async function undoLast(){
      const user = auth.currentUser; if (!user) return;
      const { dateStr } = keysFor(new Date());
      const col = collection(db, 'intakes');
      const qs = await getDocs(query(col, orderBy('ts', 'desc'), limit(50)));
      const mine = qs.docs.find(d => d.data().uid === user.uid && d.data().dateStr === dateStr);
      if (!mine) { toast('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è'); return; }
      const data = mine.data();
      const batch = writeBatch(db);
      batch.set(doc(db, 'daily_totals', dateStr, 'users', user.uid), { total_ml: increment(-data.ml), updatedAt: serverTimestamp() }, { merge: true });
      batch.set(doc(db, 'monthly_totals', data.monthStr, 'users', user.uid), { total_ml: increment(-data.ml), updatedAt: serverTimestamp() }, { merge: true });
      batch.set(doc(db, 'yearly_totals', data.yearStr, 'users', user.uid), { total_ml: increment(-data.ml), updatedAt: serverTimestamp() }, { merge: true });
      // –£–¥–∞–ª–∏–º intake –ø–æ–≤–µ—Ä—Ö: –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ
      // Firestore client SDK –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç delete –≤ batch —á–µ—Ä–µ–∑ .delete –≤ v9? –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç, –Ω–æ –º—ã –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ deleteDoc –∑–¥–µ—Å—å ‚Äî –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å
      await batch.commit();
      toast('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
    }
  </script>
</body>
</html>
