<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞ ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ø–æ –≤–æ–¥–µ</title>
  <!--
  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ üé®:
  - –ò–∫–æ–Ω–∫–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤ –≤–º–µ—Å—Ç–æ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ (–∫—Ä–∞—Å–∏–≤–∞—è —Å–µ—Ç–∫–∞ —Å –≤—ã–±–æ—Ä–æ–º).
  - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫, –∫–Ω–æ–ø–æ–∫ –∏ –≤–∫–ª–∞–¥–æ–∫.
  - –í—Å—ë –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ ‚Äî –æ–¥–∏–Ω index.html, Firebase + Firestore.
  -->
  <style>
    :root {
      --bg1: #090d1d; --bg2: #0f172a; --panel: rgba(17, 24, 39, .65);
      --border: rgba(148, 163, 184, .16); --muted: #94a3b8; --text: #e5e7eb;
      --brand: #22d3ee; --brand2: #60a5fa; --good: #34d399; --warn: #f59e0b; --danger: #f87171;
      --card: rgba(11, 18, 32, .7); --shadow: 0 20px 40px rgba(0,0,0,.35); --radius: 18px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 900px at 10% -10%, #0b122a, transparent),
                  radial-gradient(900px 700px at 120% 10%, #0a3f5d, transparent),
                  linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
      color: var(--text);
    }
    header {
      position: sticky; top: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; gap: 16px;
      padding: 14px 18px; background: rgba(8,14,28,.55); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border);
    }
    .brand { display: flex; gap: 12px; align-items: center; }
    .drop { width: 30px; height: 30px; border-radius: 10px; background:
      radial-gradient(circle at 30% 20%, #7dd3fc, transparent 35%),
      radial-gradient(circle at 60% 60%, #22d3ee, transparent 40%),
      radial-gradient(circle at 70% 30%, #60a5fa, transparent 45%);
      box-shadow: inset 0 0 14px rgba(255,255,255,.25), 0 8px 22px rgba(34,211,238,.35);
    }
    .title { font-weight: 800; letter-spacing: .2px; }
    .subtitle { font-size: 12px; color: var(--muted); }

    .row { display: flex; gap: 12px; align-items: center; }
    .btn {
      border: 0; color: #06111c; background: linear-gradient(180deg, var(--brand) 0%, #1bc0d9 100%);
      padding: 10px 16px; border-radius: 999px; cursor: pointer; font-weight: 800; letter-spacing: .3px;
      box-shadow: 0 6px 16px rgba(34,211,238,.35);
      transition: transform .08s ease, filter .2s ease;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); box-shadow: none; }

    main { max-width: 1100px; margin: 18px auto; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    @media (max-width: 960px){ .grid { grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(180deg, rgba(96,165,250,.06), rgba(34,211,238,.05));
      border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 18px; position: relative; overflow: clip;
    }
    .card::after {
      content: ""; position: absolute; inset: -2px; z-index: -1; border-radius: calc(var(--radius) + 8px);
      background: radial-gradient(600px 400px at 0% -10%, rgba(34,211,238,.25), transparent 40%),
                  radial-gradient(500px 420px at 120% 10%, rgba(96,165,250,.18), transparent 50%);
      filter: blur(20px);
    }
    h2 { margin: 0 0 10px 0; font-size: 20px; }

    .stat { display: flex; align-items: baseline; gap: 10px; }
    .stat .big { font-size: 44px; font-weight: 900; letter-spacing: .3px; }
    .unit { color: var(--muted); }

    .chipbar { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0 10px; }
    .chip {
      border: 1px dashed rgba(148,163,184,.35); color: var(--text); background: rgba(2,6,23,.45);
      padding: 10px 14px; border-radius: 12px; cursor: pointer; transition: border-color .2s ease, transform .08s ease;
    }
    .chip:hover { border-color: rgba(148,163,184,.6); }
    .chip:active { transform: translateY(1px); }

    .custom-add { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    input[type=number] { width: 140px; background: #0a0f1d; color: var(--text); border: 1px solid rgba(148,163,184,.28); border-radius: 12px; padding: 10px 12px; }

    .tabs { display: inline-flex; gap: 4px; background: rgba(2,6,23,.45); border: 1px solid var(--border); border-radius: 12px; padding: 4px; }
    .tab {
      background: transparent; color: var(--text); border: 0; padding: 8px 12px; cursor: pointer; border-radius: 10px; font-weight: 700;
      transition: background .2s ease, color .2s ease;
    }
    .tab.active { background: linear-gradient(180deg, rgba(34,211,238,.18), rgba(96,165,250,.12)); color: #e7fbff; }

    /* –°–µ—Ç–∫–∞ –∏–∫–æ–Ω–æ–∫ –Ω–∞–ø–∏—Ç–∫–æ–≤ */
    .bev-grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; margin: 8px 0 14px; }
    @media (max-width: 520px){ .bev-grid { grid-template-columns: repeat(3, minmax(0,1fr)); } }
    .bev {
      display: grid; place-items: center; gap: 6px; padding: 12px 8px; border-radius: 14px; border: 1px solid var(--border);
      background: rgba(2,6,23,.45); cursor: pointer; text-align: center; transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .bev:hover { border-color: rgba(148,163,184,.35); }
    .bev.selected { outline: 0; border-color: rgba(34,211,238,.8); box-shadow: 0 0 0 2px rgba(34,211,238,.25) inset; }
    .bev .icon { width: 28px; height: 28px; }
    .bev .name { font-size: 12px; color: var(--text); }
    .hint, .muted { color: var(--muted); font-size: 13px; }
    .success { color: var(--good); font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="drop" aria-hidden="true"></div>
      <div>
        <div class="title">–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞</div>
        <div class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø–∏—Ç–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –æ–±—ä—ë–º ‚Äî —Å—á–∏—Ç–∞–µ–º –≤–æ–¥—É-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç üíß</div>
      </div>
    </div>

    <div class="row" id="authRow">
      <div class="row hidden" id="userInfo">
        <div class="avatar" id="userAvatar" style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#0a0f1d"></div>
        <div class="name" id="userName"></div>
      </div>
      <button class="btn" id="signInBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      <button class="btn secondary hidden" id="signOutBtn">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <main id="app" class="hidden">
    <div class="grid">
      <section class="card" aria-labelledby="myDayTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="myDayTitle">–ú–æ–π –¥–µ–Ω—å</h2>
          <div class="muted" id="todayLabel"></div>
        </div>

        <div class="bev-grid" id="bevGrid" aria-label="–í—ã–±–æ—Ä –Ω–∞–ø–∏—Ç–∫–∞"></div>
        <div class="hint" id="factorHint"></div>

        <div class="stat" aria-live="polite" style="margin-top:6px;">
          <div class="big" id="myTotalWaterLiters">0,0</div>
          <div class="unit">–ª –≤–æ–¥—ã-—ç–∫–≤.</div>
        </div>
        <div class="muted" id="myRawTotal" style="margin-top:4px">–í—Å–µ–≥–æ –Ω–∞–ø–∏—Ç–∫–æ–≤: 0,0 –ª</div>
        <div class="hint" id="lastAction" style="margin-top:6px"></div>

        <div class="chipbar" aria-label="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å">
          <button class="chip" data-add="250">+ —Å—Ç–∞–∫–∞–Ω (250 –º–ª)</button>
          <button class="chip" data-add="500">+ –±—É—Ç—ã–ª–∫–∞ 0,5 –ª</button>
          <button class="chip" data-add="1500">+ –±—É—Ç—ã–ª–∫–∞ 1,5 –ª</button>
        </div>

        <div class="custom-add">
          <input id="customInput" type="number" min="1" step="1" placeholder="–î—Ä—É–≥–æ–µ, –º–ª" />
          <button class="btn" id="addCustomBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn secondary" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="muted" style="margin-top:6px">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, -250) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.</div>
      </section>

      <section class="card" aria-labelledby="lbTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="lbTitle">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
          <div class="tabs" role="tablist">
            <button class="tab active" data-scope="day" role="tab" aria-selected="true">–î–µ–Ω—å</button>
            <button class="tab" data-scope="month" role="tab" aria-selected="false">–ú–µ—Å—è—Ü</button>
            <button class="tab" data-scope="year" role="tab" aria-selected="false">–ì–æ–¥</button>
          </div>
        </div>
        <div class="muted" id="periodLabel" style="margin:8px 0 12px;"></div>
        <div class="lb-list" id="lbList" aria-live="polite"></div>
        <div class="muted" style="margin-top:6px">–†–µ–π—Ç–∏–Ω–≥ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ –≤–æ–¥–µ-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—É; –æ–±—â–∏–π –æ–±—ä—ë–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.</div>
      </section>
    </div>
  </main>

  <footer style="max-width:1100px;margin:26px auto 60px;padding:0 16px;" class="muted">
    –û–¥–∏–Ω HTML‚Äë—Ñ–∞–π–ª –Ω–∞ Firebase + Firestore. –ù–∞–ø–∏—Ç–∫–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏.
  </footer>

  <template id="lbRowTpl">
    <div class="lb-item">
      <div class="muted rank"></div>
      <div class="row" style="gap:10px; overflow:hidden;">
        <div class="avatar av" style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#0a0f1d"></div>
        <div class="name nm"></div>
      </div>
      <div class="amt am"></div>
    </div>
  </template>

  <script type="module">
    // Firebase SDK (modular)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection, onSnapshot, orderBy, limit, query, getDocs, increment } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // === –ö–æ–Ω—Ñ–∏–≥ Firebase (—Ç–≤–æ–π)
    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8z2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    setPersistence(auth, browserLocalPersistence).catch(console.warn);
    getRedirectResult(auth).catch(() => {});

    // === –ù–∞–ø–∏—Ç–∫–∏ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã + SVG –∏–∫–æ–Ω–∫–∏
    const ICONS = {
      water: `<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2s6 7.2 6 11.2A6 6 0 1 1 6 13.2C6 9.2 12 2 12 2Z" stroke="currentColor" stroke-width="1.5"/></svg>`,
      tea: `<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 10h11a4 4 0 0 1 0 8H9a5 5 0 0 1-5-5v-3Z" stroke="currentColor" stroke-width="1.5"/><path d="M15 10h3a3 3 0 1 1 0 6h-2" stroke="currentColor" stroke-width="1.5"/></svg>`,
      coffee: `<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 10h10a4 4 0 0 1 0 8H9a5 5 0 0 1-5-5v-3Z" stroke="currentColor" stroke-width="1.5"/><path d="M16 10h3a3 3 0 1 1 0 6h-2" stroke="currentColor" stroke-width="1.5"/><path d="M8 4c0 1 .8 1.5.8 2.4S8 8 8 8M11 4c0 1 .8 1.5.8 2.4S11 8 11 8" stroke="currentColor" stroke-width="1.5"/></svg>`,
      milk: `<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 3h8l-2 3v13a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V6L8 3Z" stroke="currentColor" stroke-width="1.5"/><path d="M10 11h4M10 15h4" stroke="currentColor" stroke-width="1.5"/></svg>`,
      cola_zero: `<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 3h6l-1 4v9a4 4 0 0 1-4 4h0a4 4 0 0 1-4-4V7l3-4Z" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="1.5"/></svg>`,
      kvass: `<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 3h10l-1 4v9a4 4 0 0 1-4 4h0a4 4 0 0 1-4-4V7L7 3Z" stroke="currentColor" stroke-width="1.5"/><path d="M8 9h8" stroke="currentColor" stroke-width="1.5"/></svg>`,
      juice: `<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6h12l-1 3v9a3 3 0 0 1-3 3H10a3 3 0 0 1-3-3V9L6 6Z" stroke="currentColor" stroke-width="1.5"/><path d="M9 3h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      lemonade: `<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="6" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M5 7h10l-1 3v8a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3V10L5 7Z" stroke="currentColor" stroke-width="1.5"/></svg>`
    };
    const BEVERAGES = [
      { key:'water',    name:'–í–æ–¥–∞',                 factor: 1.00 },
      { key:'tea',      name:'–ß–∞–π',                  factor: 0.98 },
      { key:'coffee',   name:'–ö–æ—Ñ–µ',                 factor: 0.90 },
      { key:'milk',     name:'–ú–æ–ª–æ–∫–æ',               factor: 0.87 },
      { key:'cola_zero',name:'–ö–æ–ª–∞ –ª–∞–π—Ç/0 —Å–∞—Ö–∞—Ä',    factor: 0.95 },
      { key:'kvass',    name:'–ö–≤–∞—Å',                 factor: 0.92 },
      { key:'juice',    name:'–°–æ–∫–∏',                 factor: 0.90 },
      { key:'lemonade', name:'–õ–∏–º–æ–Ω–∞–¥—ã',             factor: 0.90 },
    ];

    // === –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const appEl = document.getElementById('app');

    const todayLabelEl = document.getElementById('todayLabel');
    const bevGrid = document.getElementById('bevGrid');
    const factorHintEl = document.getElementById('factorHint');

    const myTotalWaterLitersEl = document.getElementById('myTotalWaterLiters');
    const myRawTotalEl = document.getElementById('myRawTotal');
    const lastActionEl = document.getElementById('lastAction');

    const addChips = Array.from(document.querySelectorAll('[data-add]'));
    const customInput = document.getElementById('customInput');
    const addCustomBtn = document.getElementById('addCustomBtn');
    const undoBtn = document.getElementById('undoBtn');

    const lbListEl = document.getElementById('lbList');
    const periodLabelEl = document.getElementById('periodLabel');
    const tabs = Array.from(document.querySelectorAll('.tab'));

    const pad = (n)=>String(n).padStart(2,'0');
    const keysFor = (date=new Date())=>({ dateStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`, monthStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}`, yearStr:`${date.getFullYear()}` });

    todayLabelEl.textContent = `–°–µ–≥–æ–¥–Ω—è: ${new Date().toLocaleDateString(undefined, { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' })}`;

    // === –†–µ–Ω–¥–µ—Ä —Å–µ—Ç–∫–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤
    let currentBevKey = 'water';
    function renderBeverages(){
      bevGrid.innerHTML = '';
      BEVERAGES.forEach(b => {
        const div = document.createElement('button');
        div.className = 'bev'+(b.key===currentBevKey?' selected':'');
        div.setAttribute('type','button');
        div.setAttribute('data-key', b.key);
        div.innerHTML = `${ICONS[b.key] || ''}<div class="name">${b.name}</div>`;
        div.querySelector('.icon').style.color = b.key==='water' ? '#7dd3fc' : '#cfe6ff';
        div.addEventListener('click', () => { currentBevKey = b.key; updateFactorHint(); renderBeverages(); });
        bevGrid.appendChild(div);
      });
    }
    renderBeverages();

    function updateFactorHint(){
      const bev = BEVERAGES.find(b => b.key===currentBevKey);
      factorHintEl.textContent = `–°–µ–π—á–∞—Å: ${bev.name} ‚Äî –º–Ω–æ–∂–∏—Ç–µ–ª—å √ó${bev.factor}`;
    }
    updateFactorHint();

    // === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    signInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider(); provider.setCustomParameters({ prompt: 'select_account' });
      try { await signInWithPopup(auth, provider); }
      catch (e){ if (e?.code === 'auth/operation-not-supported-in-this-environment' || e?.code === 'auth/popup-blocked') { await signInWithRedirect(auth, provider); } else { alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+(e?.message||e)); } }
    });
    signOutBtn.addEventListener('click', async () => { await signOut(auth); });

    let unsubMyDaily = null, unsubLB = null;
    const cleanupSubscriptions = () => { if (unsubMyDaily) { unsubMyDaily(); unsubMyDaily=null; } if (unsubLB) { unsubLB(); unsubLB=null; } };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        appEl.classList.remove('hidden');
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        userInfoEl.classList.remove('hidden');
        userNameEl.textContent = user.displayName || user.email;
        userAvatarEl.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä" width="32" height="32"/>` : '';
        await setDoc(doc(db, 'users', user.uid), { uid:user.uid, displayName:user.displayName||null, email:user.email||null, photoURL:user.photoURL||null, lastLoginAt:serverTimestamp(), createdAt:serverTimestamp() }, { merge:true });
        subscribeMyDailyTotal();
        activateTab('day');
      } else {
        appEl.classList.add('hidden');
        signInBtn.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        userInfoEl.classList.add('hidden');
        cleanupSubscriptions();
      }
    });

    // === –î–µ–π—Å—Ç–≤–∏—è
    addChips.forEach(btn => btn.addEventListener('click', () => addAmount(parseInt(btn.dataset.add, 10))));
    addCustomBtn.addEventListener('click', () => { const v = parseInt(customInput.value, 10); if (!Number.isFinite(v) || v === 0) { toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–ª (–Ω–µ 0)'); return; } addAmount(v); customInput.value=''; });
    undoBtn.addEventListener('click', undoLast);
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–ª–∏–∫–∏ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
    tabs.forEach(t => t.addEventListener('click', () => activateTab(t.dataset.scope)));

    function toast(msg){ lastActionEl.textContent = msg; lastActionEl.classList.add('success'); setTimeout(()=>{ lastActionEl.textContent=''; lastActionEl.classList.remove('success'); }, 2500); }

    function subscribeMyDailyTotal(){
      if (unsubMyDaily) unsubMyDaily();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const ref = doc(db, 'daily_totals', dateStr, 'users', uid);
      unsubMyDaily = onSnapshot(ref, (snap) => {
        const d = snap.exists() ? snap.data() : { total_water_ml:0, total_ml:0 };
        const water = d.total_water_ml || 0; const raw = d.total_ml || 0;
        myTotalWaterLitersEl.textContent = (water/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2});
        myRawTotalEl.textContent = `–í—Å–µ–≥–æ –Ω–∞–ø–∏—Ç–∫–æ–≤: ${(raw/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} –ª`;
      });
    }

    function activateTab(scope){
      tabs.forEach(t => {
        const isActive = t.dataset.scope === scope;
        t.classList.toggle('active', isActive);
        t.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      if (unsubLB) { unsubLB(); unsubLB=null; }
      const now = new Date();
      const { dateStr, monthStr, yearStr } = keysFor(now);
      let colRef, label;
      if (scope === 'day') { colRef = collection(db, 'daily_totals', dateStr, 'users'); label = `–°–µ–≥–æ–¥–Ω—è ‚Äî ${now.toLocaleDateString()}`; }
      else if (scope === 'month') { colRef = collection(db, 'monthly_totals', monthStr, 'users'); label = `–ú–µ—Å—è—Ü ‚Äî ${now.toLocaleString(undefined,{month:'long', year:'numeric'})}`; }
      else { colRef = collection(db, 'yearly_totals', yearStr, 'users'); label = `–ì–æ–¥ ‚Äî ${yearStr}`; }
      periodLabelEl.textContent = label;
      const q = query(colRef, orderBy('total_water_ml','desc'), limit(50));
      unsubLB = onSnapshot(q, (qs) => renderLeaderboard(qs.docs.map(d=>d.data())));
    }

    function renderLeaderboard(items){
      lbListEl.innerHTML='';
      if (!items.length){ lbListEl.innerHTML = '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üíß</div>'; return; }
      const tpl = document.getElementById('lbRowTpl');
      items.forEach((it, idx) => {
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.rank').textContent = idx+1;
        node.querySelector('.av').innerHTML = it.photoURL ? `<img src="${it.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä" width="32" height="32"/>` : '';
        node.querySelector('.nm').textContent = it.displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        const w = Math.max(0, it.total_water_ml||0)/1000;
        node.querySelector('.am').textContent = `${w.toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} –ª –≤–æ–¥—ã-—ç–∫–≤.`;
        lbListEl.appendChild(node);
      });
    }

    async function addAmount(ml){
      const user = auth.currentUser; if (!user) return;
      const bev = BEVERAGES.find(b => b.key === currentBevKey) || BEVERAGES[0];
      const water_ml = Math.round(ml * bev.factor);
      const now = new Date();
      const { dateStr, monthStr, yearStr } = keysFor(now);

      const batch = writeBatch(db);
      const intakeRef = doc(collection(db, 'intakes'));
      batch.set(intakeRef, { uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, ml, beverage:bev.key, beverage_name:bev.name, factor:bev.factor, water_ml, ts:serverTimestamp(), dateStr, monthStr, yearStr });

      const base = { uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, updatedAt:serverTimestamp() };
      batch.set(doc(db,'daily_totals',dateStr,'users',user.uid),   { ...base, dateStr,  total_ml: increment(ml),        total_water_ml: increment(water_ml) }, { merge:true });
      batch.set(doc(db,'monthly_totals',monthStr,'users',user.uid),{ ...base, monthStr, total_ml: increment(ml),        total_water_ml: increment(water_ml) }, { merge:true });
      batch.set(doc(db,'yearly_totals',yearStr,'users',user.uid), { ...base, yearStr,  total_ml: increment(ml),        total_water_ml: increment(water_ml) }, { merge:true });

      await batch.commit();
      toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${ml>0?'+':''}${ml} –º–ª (${bev.name} ‚Üí ${water_ml} –º–ª –≤–æ–¥—ã-—ç–∫–≤.)`);
    }

    async function undoLast(){
      const user = auth.currentUser; if (!user) return;
      const { dateStr } = keysFor(new Date());
      const col = collection(db, 'intakes');
      const qs = await getDocs(query(col, orderBy('ts','desc'), limit(50)));
      const mine = qs.docs.find(d => d.data().uid === user.uid && d.data().dateStr === dateStr);
      if (!mine) { toast('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è'); return; }
      const data = mine.data();
      const batch = writeBatch(db);
      const wml = data.water_ml || Math.round(data.ml * (data.factor || 1));
      batch.set(doc(db,'daily_totals',dateStr,'users',user.uid),   { total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'monthly_totals',data.monthStr,'users',user.uid),{ total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'yearly_totals',data.yearStr,'users',user.uid), { total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      await batch.commit();
      toast('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
    }
  </script>
</body>
</html>
