<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HydroRace üíß</title>

  <!-- Tailwind (dark mode –ø–æ –∫–ª–∞—Å—Å—É) -->
  <script>
    window.tailwind = {};
    window.tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
          boxShadow: { card: "0 10px 30px -10px rgba(2,6,23,0.25)" },
          colors: {
            brand: {50:"#ecfeff",100:"#cffafe",200:"#a5f3fc",300:"#67e8f9",400:"#22d3ee",500:"#06b6d4",600:"#0891b2",700:"#0e7490",800:"#155e75",900:"#164e63"}
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∏–≥–∞–Ω–∏–µ —Ç–µ–º—ã -->
  <script>
    (function() {
      const key = "hydro_theme";
      const saved = localStorage.getItem(key);
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const wantDark = saved ? saved === "dark" : prefersDark;
      if (wantDark) document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = wantDark ? "dark" : "light";
    })();
  </script>
  <style>html, body { height: 100%; }</style>
</head>

<body class="h-full font-sans antialiased bg-gradient-to-br from-brand-50 via-white to-brand-100 dark:from-slate-900 dark:via-slate-950 dark:to-black text-slate-900 dark:text-slate-100">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    // ========= Firebase init: –í–°–¢–ê–í–¨ –°–í–û–ô –ê–ö–¢–£–ê–õ–¨–ù–´–ô –ö–û–ù–§–ò–ì –ò–ó –ö–û–ù–°–û–õ–ò =========
    const firebaseConfig = {
      apiKey: "<<<COPIED_FROM_FIREBASE_CONSOLE>>>",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.appspot.com",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // --- –•—Ä–∞–Ω–∏–º —Å–µ—Å—Å–∏—é –ª–æ–∫–∞–ª—å–Ω–æ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ ---
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((e)=>{
      console.warn("[AUTH] setPersistence error:", e);
    });
    // --- –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –ø–æ—Å–ª–µ redirect (–Ω–∞ –º–æ–±–∏–ª–µ/–ø—Ä–∏ –ø–æ–ø–∞–ø-–±–ª–æ–∫–∞—Ö) ---
    auth.getRedirectResult()
      .then(res => { if (res?.user) console.log("[AUTH] redirect OK:", res.user.uid); })
      .catch(err => console.warn("[AUTH] redirect error:", err));

    // ========= –£—Ç–∏–ª–∏—Ç—ã / –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã =========
    const THEME_KEY = "hydro_theme";
    const ML = { glass: 250, bottle05: 500, bottle15: 1500 };
    const fmtLiters = (ml) => (ml / 1000).toFixed(2).replace(/\.00$/, "") + " –ª";
    const todayISO = (d = new Date()) => d.toISOString().slice(0, 10);
    const sameDay    = (a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    const isSameMonth= (a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth();
    const isSameYear = (a,b)=> a.getFullYear()===b.getFullYear();
    const tsToDate = (ts) => ts && typeof ts.toDate === "function" ? ts.toDate() : new Date(ts || Date.now());
    const DEFAULT_DRINKS = [
      { id:"water",       name:"–í–æ–¥–∞",            emoji:"üíß", waterFraction:1.00 },
      { id:"tea",         name:"–ß–∞–π",             emoji:"üçµ", waterFraction:0.99 },
      { id:"milk",        name:"–ú–æ–ª–æ–∫–æ",          emoji:"ü•õ", waterFraction:0.87 },
      { id:"cola_light",  name:"–ö–æ–ª–∞ –õ–∞–π—Ç",       emoji:"ü•§", waterFraction:0.99 },
      { id:"cola_zero",   name:"–ö–æ–ª–∞ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞", emoji:"ü•§", waterFraction:0.99 },
      { id:"kvass",       name:"–ö–≤–∞—Å",            emoji:"üç∫", waterFraction:0.96 },
      { id:"juice",       name:"–°–æ–∫",             emoji:"üßÉ", waterFraction:0.88 },
      { id:"lemonade",    name:"–õ–∏–º–æ–Ω–∞–¥",         emoji:"üçã", waterFraction:0.90 },
    ];
    function cx(...c){return c.filter(Boolean).join(" ");}

    // ========= Hooks =========
    function useTheme(){
      const [theme, setTheme] = React.useState(()=>{
        const saved = localStorage.getItem(THEME_KEY);
        return saved || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      });
      React.useEffect(()=>{
        const root = document.documentElement;
        if(theme==="dark") root.classList.add("dark"); else root.classList.remove("dark");
        root.style.colorScheme = theme;
        localStorage.setItem(THEME_KEY, theme);
      },[theme]);
      return { theme, setTheme };
    }

    // –í—Ö–æ–¥: –ø—Ä–æ–±—É–µ–º popup, –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö ‚Äî redirect
    function useAuth(){
      const [user,setUser] = React.useState(null);
      React.useEffect(()=>auth.onAuthStateChanged((u)=>{console.log("[AUTH] state:",u?.uid||null); setUser(u);}),[]);
      const signInGoogle = React.useCallback(async ()=>{
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt:"select_account" });
        try { await auth.signInWithPopup(provider); return; }
        catch(err){
          console.warn("[AUTH] popup error:", err?.code, err?.message);
          const fallback = ["auth/operation-not-supported-in-this-environment","auth/popup-blocked","auth/popup-closed-by-user"].includes(err?.code);
          if(!fallback){ alert("Google Sign-in: "+(err?.code||"")+" ‚Äî "+(err?.message||"")); return; }
        }
        try{ await auth.signInWithRedirect(provider); }
        catch(err){ console.warn("[AUTH] redirect error:", err); alert("Redirect: "+(err?.code||"")+" ‚Äî "+(err?.message||"")); }
      },[]);
      const signInAnon = React.useCallback(()=>auth.signInAnonymously().catch(e=>alert("Anon: "+(e?.code||"")+" ‚Äî "+(e?.message||""))),[]);
      const signOut = React.useCallback(()=>auth.signOut(),[]);
      return { user, signInGoogle, signInAnon, signOut };
    }

    function getHashRoomId(){ const m = location.hash.match(/room=([A-Za-z0-9_-]+)/); return m ? m[1] : ""; }

    function useRoom(roomId){
      const [entries,setEntries] = React.useState([]);
      const [members,setMembers] = React.useState([]);
      React.useEffect(()=>{
        if(!roomId) return;
        const un1 = db.collection("rooms").doc(roomId).collection("entries").orderBy("ts","desc")
          .onSnapshot(s=>setEntries(s.docs.map(d=>({id:d.id,...d.data()}))));
        const un2 = db.collection("rooms").doc(roomId).collection("members")
          .onSnapshot(s=>setMembers(s.docs.map(d=>({id:d.id,...d.data()}))));
        return ()=>{un1();un2();};
      },[roomId]);
      return { entries, members };
    }

    // ========= Firestore ops =========
    async function createRoom(name, ownerId){
      const ref = await db.collection("rooms").add({
        name: name || "–ù–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞",
        ownerId: ownerId || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return ref.id;
    }
    async function joinRoom(roomId, user, name){
      if(!roomId||!user) return;
      await db.collection("rooms").doc(roomId).collection("members").doc(user.uid).set({
        userId: user.uid,
        name: name || user.displayName || "–ì–æ—Å—Ç—å",
        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
    }
    async function addDrinkCloud(roomId,user,{ml,drinkId,userName}){
      if(!roomId||!user) return;
      await db.collection("rooms").doc(roomId).collection("entries").add({
        userId: user.uid,
        userName: userName || "–ì–æ—Å—Ç—å",
        ml: Math.round(ml),
        drinkId,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    async function undoLastForCurrentCloud(roomId,user){
      if(!roomId||!user) return;
      const q = await db.collection("rooms").doc(roomId).collection("entries")
        .where("userId","==",user.uid).orderBy("ts","desc").limit(1).get();
      if(!q.empty) await q.docs[0].ref.delete();
    }
    async function setUserLastRoom(uid,roomId){
      if(!uid) return;
      await db.collection("users").doc(uid).set({
        lastRoomId: roomId || "",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
    }
    async function getUserLastRoom(uid){
      if(!uid) return "";
      const s = await db.collection("users").doc(uid).get();
      return s.exists ? (s.data()?.lastRoomId || "") : "";
    }

    // ========= –ê–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ (—Ä–µ–∞–∫—Ç–∏–≤–Ω–æ) =========
    function useAutoRoom(user, roomId, setRoomId){
      React.useEffect(()=>{
        if(!user) return;
        let picked = false;

        // 1) —Å–ª—É—à–∞–µ–º –≤—Å–µ —á–ª–µ–Ω—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const unsub = db.collectionGroup("members")
          .where("userId","==",user.uid)
          .onSnapshot(async (snap)=>{
            if(picked || roomId) return;
            if(snap.empty) return;
            let best = { id:"", at:0 };
            for(const doc of snap.docs){
              const ref = doc.ref.parent.parent; if(!ref) continue;
              const at = doc.data()?.joinedAt?.toMillis?.() || 0;
              if(at >= best.at) best = { id: ref.id, at };
            }
            if(best.id){
              picked = true;
              setRoomId(best.id);
              await joinRoom(best.id, user, user.displayName || "–ì–æ—Å—Ç—å");
              await setUserLastRoom(user.uid, best.id);
            }
          }, (err)=>console.warn("[AUTO-ROOM] members listener:", err));

        // 2) –±—ç–∫–∞–ø: –µ—Å–ª–∏ —á–ª–µ–Ω—Å—Ç–≤–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –∫–æ–º–Ω–∞—Ç—ã, –≥–¥–µ –æ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü
        (async ()=>{
          try{
            if(picked || roomId) return;
            const q = await db.collection("rooms").where("ownerId","==",user.uid)
                               .orderBy("createdAt","desc").limit(1).get();
            if(!q.empty && !picked && !roomId){
              const id = q.docs[0].id;
              picked = true;
              setRoomId(id);
              await joinRoom(id, user, user.displayName || "–ì–æ—Å—Ç—å");
              await setUserLastRoom(user.uid, id);
            }
          }catch(e){ console.warn("[AUTO-ROOM] owner fallback:", e); }
        })();

        // 3) –µ—â—ë –æ–¥–∏–Ω –±—ç–∫–∞–ø: –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª lastRoomId ‚Äî –ø–æ–¥—Ç—è–Ω–µ–º
        (async ()=>{
          try{
            if(picked || roomId) return;
            const last = await getUserLastRoom(user.uid);
            if(last){
              picked = true;
              setRoomId(last);
              await joinRoom(last, user, user.displayName || "–ì–æ—Å—Ç—å");
            }
          }catch(e){ console.warn("[AUTO-ROOM] lastRoomId fallback:", e); }
        })();

        return ()=>unsub && unsub();
      },[user, roomId, setRoomId]);
    }

    // ========= –°–ø–∏—Å–æ–∫ –º–æ–∏—Ö –∫–æ–º–Ω–∞—Ç =========
    function useMyRooms(user){
      const [myRooms,setMyRooms] = React.useState([]);
      React.useEffect(()=>{
        if(!user){ setMyRooms([]); return; }
        const q = db.collectionGroup("members").where("userId","==",user.uid);
        const unsub = q.onSnapshot(async (snap)=>{
          try{
            const arr = await Promise.all(snap.docs.map(async d=>{
              const roomRef = d.ref.parent.parent; if(!roomRef) return null;
              const rs = await roomRef.get();
              return rs.exists ? { id: roomRef.id, ...rs.data() } : null;
            }));
            const seen = new Set(), unique = [];
            for(const r of arr){ if(r && !seen.has(r.id)){ seen.add(r.id); unique.push(r); } }
            unique.sort((a,b)=> (b?.createdAt?.toMillis?.()||0)-(a?.createdAt?.toMillis?.()||0));
            setMyRooms(unique);
          }catch(err){ console.warn("[MYROOMS] build:", err); }
        }, err=>console.warn("[MYROOMS] listener:", err));
        return ()=>unsub && unsub();
      },[user]);
      return myRooms;
    }

    // ========= Delete/Leave =========
    async function deleteCollectionDeep(colRef,batchSize=200){
      let snap = await colRef.limit(batchSize).get();
      while(!snap.empty){
        const batch = db.batch();
        snap.docs.forEach(doc=>batch.delete(doc.ref));
        await batch.commit();
        snap = await colRef.limit(batchSize).get();
      }
    }
    async function deleteRoomDeep(roomId, currentUser){
      if(!roomId) return;
      const roomRef = db.collection("rooms").doc(roomId);
      const roomSnap = await roomRef.get(); if(!roomSnap.exists) return;
      const data = roomSnap.data() || {};
      if(data.ownerId && currentUser && data.ownerId !== currentUser.uid){
        alert("–£–¥–∞–ª—è—Ç—å –∫–æ–º–Ω–∞—Ç—É –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü."); return;
      }
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É –∏ –≤—Å–µ –∑–∞–ø–∏—Å–∏? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) return;
      await deleteCollectionDeep(roomRef.collection("entries"));
      await deleteCollectionDeep(roomRef.collection("members"));
      await roomRef.delete();
    }
    async function leaveRoom(roomId, currentUser){
      if(!roomId||!currentUser) return;
      if(!confirm("–ü–æ–∫–∏–Ω—É—Ç—å —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É?")) return;
      await db.collection("rooms").doc(roomId).collection("members").doc(currentUser.uid).delete();
    }

    // ========= UI –∞—Ç–æ–º—ã =========
    const Card = ({children,className}) => (
      <div className={cx(
        "rounded-2xl border shadow-card",
        "bg-white/70 supports-[backdrop-filter]:bg-white/60 backdrop-blur",
        "dark:bg-slate-800/60 dark:border-slate-700",
        className
      )}>{children}</div>
    );
    const SegBtn = ({active,children,onClick}) => (
      <button onClick={onClick} className={cx("px-3 py-2 text-sm transition-colors",
        active ? "bg-slate-900 text-white dark:bg-white dark:text-slate-900"
               : "bg-white/70 dark:bg-slate-800/60"
      )}>{children}</button>
    );

    // ========= App =========
    function App(){
      const { theme, setTheme } = useTheme();
      const { user, signInGoogle, signInAnon, signOut } = useAuth();

      const [period,setPeriod] = React.useState("day");
      const [selectedDate,setSelectedDate] = React.useState(todayISO());
      const [drinkId,setDrinkId] = React.useState("water");
      const [roomId, setRoomId] = React.useState(getHashRoomId());
      const [displayName, setDisplayName] = React.useState("");

      // hash <-> state
      React.useEffect(()=>{
        const onHash = ()=> setRoomId(getHashRoomId());
        addEventListener("hashchange", onHash);
        return ()=> removeEventListener("hashchange", onHash);
      },[]);
      React.useEffect(()=>{
        if(roomId){
          const h = `#room=${roomId}`;
          if(location.hash !== h) history.replaceState(null,"",h);
        }else if(location.hash){ history.replaceState(null,""," "); }
      },[roomId]);

      // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ–∞–∫—Ç–∏–≤–Ω–æ)
      useAutoRoom(user, roomId, setRoomId);

      const myRooms = useMyRooms(user);
      const { entries, members } = useRoom(roomId);

      // sync –∏–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
      React.useEffect(()=>{
        if(!user || !roomId) return;
        const me = members.find(m=>m.id===user.uid);
        if(me?.name && !displayName) setDisplayName(me.name);
        if(!me) joinRoom(roomId, user, displayName || user.displayName || "–ì–æ—Å—Ç—å");
      },[user, roomId, members]); // eslint-disable-line

      const memberMap = React.useMemo(()=>{
        const m = new Map(); members.forEach(x=>m.set(x.id,x)); return m;
      },[members]);

      const entriesForPeriod = React.useMemo(()=>{
        const sel = new Date(selectedDate+"T12:00:00");
        return entries.filter(e=>{
          const d = tsToDate(e.ts);
          if(period==="day") return sameDay(d,sel);
          if(period==="month") return isSameMonth(d,sel);
          if(period==="year") return isSameYear(d,sel);
          return false;
        });
      },[entries,selectedDate,period]);

      const totals = React.useMemo(()=>{
        const by = new Map();
        for(const e of entriesForPeriod){
          const dr = DEFAULT_DRINKS.find(x=>x.id===e.drinkId) || {waterFraction:1};
          const water = Math.round(e.ml * (dr.waterFraction ?? 1));
          const cur = by.get(e.userId) || { userId:e.userId, waterMl:0, totalMl:0 };
          cur.waterMl += water; cur.totalMl += e.ml; by.set(e.userId, cur);
        }
        return Array.from(by.values())
          .map(v=>({...v, name: memberMap.get(v.userId)?.name || "–£—á–∞—Å—Ç–Ω–∏–∫"}))
          .sort((a,b)=> b.waterMl - a.waterMl);
      },[entriesForPeriod, memberMap]);

      const myHistory = React.useMemo(()=>{
        if(!user) return [];
        return entries.filter(e=>e.userId===user.uid).slice(0,20);
      },[entries,user]);

      async function handleAddDrink(ml){
        if(!user || !roomId) return;
        const name = displayName || user.displayName || "–ì–æ—Å—Ç—å";
        await joinRoom(roomId, user, name);
        await addDrinkCloud(roomId, user, { ml, drinkId, userName: name });
      }
      async function handleUndo(){ if(user && roomId) await undoLastForCurrentCloud(roomId,user); }
      async function handleCreateRoom(){
        if(!user) return;
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã?") || "–ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞";
        const id = await createRoom(name, user.uid);
        setRoomId(id);
        await joinRoom(id, user, displayName || user.displayName || "–ì–æ—Å—Ç—å");
        await setUserLastRoom(user.uid, id);
      }
      async function handleJoinExisting(id){
        if(!user || !id) return;
        setRoomId(id);
        await joinRoom(id, user, displayName || user.displayName || "–ì–æ—Å—Ç—å");
        await setUserLastRoom(user.uid, id);
      }
      function copyInvite(){
        const url = location.origin + location.pathname + `#room=${roomId}`;
        navigator.clipboard?.writeText(url);
        alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:\n"+url);
      }
      async function goToRoom(id){
        if(!user || !id) return;
        setRoomId(id);
        await joinRoom(id, user, displayName || user.displayName || "–ì–æ—Å—Ç—å");
        await setUserLastRoom(user.uid, id);
      }
      async function handleDeleteRoom(id){
        await deleteRoomDeep(id, user);
        if(id===roomId){ setRoomId(""); await setUserLastRoom(user.uid,""); }
      }
      async function handleLeaveRoom(id){
        await leaveRoom(id, user);
        if(id===roomId){ setRoomId(""); await setUserLastRoom(user.uid,""); }
      }

      const Header = () => (
        <div className="flex flex-col sm:flex-row sm:items-end gap-4 justify-between">
          <div>
            <h1 className="text-3xl md:text-4xl font-bold tracking-tight">
              HydroRace <span className="align-middle">üíß</span>
            </h1>
            <p className="text-sm text-slate-600 dark:text-slate-300">
              –õ–∞–π–≤-—Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ø–æ <span className="font-semibold">–≤–æ–¥–Ω–æ–º—É —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—É</span>
            </p>
          </div>
          <div className="flex flex-wrap items-center gap-2">
            <div className="inline-flex rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
              <SegBtn active={period==="day"}   onClick={()=>setPeriod("day")}>–î–µ–Ω—å</SegBtn>
              <SegBtn active={period==="month"} onClick={()=>setPeriod("month")}>–ú–µ—Å—è—Ü</SegBtn>
              <SegBtn active={period==="year"}  onClick={()=>setPeriod("year")}>–ì–æ–¥</SegBtn>
            </div>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)}
                   className="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm bg-white/80 dark:bg-slate-800/80"/>
            <button onClick={()=>setTheme(theme==="dark"?"light":"dark")}
              className="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/80 hover:brightness-95 transition">
              {theme==="dark"?"üåô Dark":"üåû Light"}
            </button>
          </div>
        </div>
      );

      const MyRoomsCard = () => (
        <Card className="p-4">
          <div className="flex items-center justify-between mb-2">
            <h2 className="font-semibold">–ú–æ–∏ –∫–æ–º–Ω–∞—Ç—ã</h2>
            <span className="text-xs text-slate-500 dark:text-slate-400">{myRooms.length||0}</span>
          </div>
          {!myRooms.length && <div className="text-sm text-slate-500 dark:text-slate-400">–ü–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –ø–æ ID.</div>}
          <ul className="space-y-2">
            {myRooms.map(r=>{
              const isOwner = r.ownerId && user && r.ownerId===user.uid;
              return (
                <li key={r.id} className="flex items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 bg-white/60 dark:bg-slate-800/50">
                  <div className="min-w-0">
                    <div className="font-medium truncate">{r.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</div>
                    <div className="text-xs text-slate-500 dark:text-slate-400">ID: <code className="font-mono">{r.id}</code></div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button onClick={()=>goToRoom(r.id)} className="px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:brightness-95 text-sm">–ü–µ—Ä–µ–π—Ç–∏</button>
                    {isOwner
                      ? <button onClick={()=>handleDeleteRoom(r.id)} className="px-3 py-1.5 rounded-lg border border-red-300 dark:border-red-700 text-red-600 dark:text-red-400 hover:brightness-95 text-sm">üóë –£–¥–∞–ª–∏—Ç—å</button>
                      : <button onClick={()=>handleLeaveRoom(r.id)} className="px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:brightness-95 text-sm">üö™ –í—ã–π—Ç–∏</button>}
                  </div>
                </li>
              );
            })}
          </ul>
        </Card>
      );

      if(!user){
        return (
          <div className="min-h-full p-6 flex items-center justify-center">
            <Card className="max-w-md w-full p-6 text-center">
              <h1 className="text-2xl font-semibold mb-2">HydroRace üíß</h1>
              <p className="text-slate-600 dark:text-slate-300 mb-6">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏.</p>
              <div className="grid gap-2">
                <button onClick={signInGoogle} className="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
                <button onClick={signInAnon} className="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">–í–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ</button>
              </div>
              <p className="text-xs text-slate-500 dark:text-slate-400 mt-4">–î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω –≤ <em>Authentication ‚Üí Authorized domains</em>.</p>
            </Card>
          </div>
        );
      }

      if(!roomId){
        return (
          <div className="min-h-full p-6">
            <div className="max-w-4xl mx-auto grid gap-6">
              <Header />
              <div className="grid md:grid-cols-2 gap-6">
                <Card className="p-6">
                  <h2 className="font-semibold mb-3">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
                  <label className="text-sm block mb-3">
                    –í–∞—à–µ –∏–º—è:
                    <input value={displayName} onChange={e=>setDisplayName(e.target.value)} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê—Ä—Ç—ë–º"
                      className="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent"/>
                  </label>
                  <button onClick={handleCreateRoom} className="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                  <div className="mt-4"><button onClick={signOut} className="text-sm underline">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button></div>
                </Card>

                <Card className="p-6">
                  <h2 className="font-semibold mb-3">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –ø–æ ID</h2>
                  <JoinForm onJoin={handleJoinExisting} onSetName={setDisplayName} displayName={displayName}/>
                </Card>
              </div>

              <MyRoomsCard />
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-full p-4 md:p-8">
          <div className="max-w-6xl mx-auto grid gap-6">
            <Header />

            <div className="flex flex-wrap items-center gap-2">
              <Card className="px-3 py-2">
                <div className="text-sm">
                  –ö–æ–º–Ω–∞—Ç–∞: <code className="font-mono">{roomId}</code>
                  <button onClick={copyInvite} className="ml-2 text-sm underline decoration-dashed underline-offset-4">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
              </Card>
              <Card className="px-3 py-2">
                <div className="text-sm">
                  –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{displayName || user.displayName || "–ì–æ—Å—Ç—å"}</strong>
                  <button onClick={async()=>{
                    const n = prompt("–í–∞—à–µ –∏–º—è:", displayName || user.displayName || "–ì–æ—Å—Ç—å") || "";
                    setDisplayName(n);
                    await joinRoom(roomId, user, n);
                    await setUserLastRoom(user.uid, roomId);
                  }} className="ml-2 text-sm underline decoration-dashed underline-offset-4">–∏–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
              </Card>
              <button onClick={signOut} className="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">–í—ã–π—Ç–∏</button>
            </div>

            <div className="grid lg:grid-cols-3 gap-6">
              <Card className="p-4">
                <h2 className="font-semibold mb-3">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
                <ul className="space-y-1 text-sm">
                  {members.map(m=>(
                    <li key={m.id} className="flex items-center justify-between">
                      <span>{m.name || "–£—á–∞—Å—Ç–Ω–∏–∫"}</span>
                      <span className="text-xs text-slate-500 dark:text-slate-400">{m.id===user.uid ? "—ç—Ç–æ –≤—ã" : ""}</span>
                    </li>
                  ))}
                  {!members.length && <li className="text-slate-500 dark:text-slate-400">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ</li>}
                </ul>
              </Card>

              <Card className="p-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="font-semibold">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–∏—Ç–æ–∫ {displayName ? `–¥–ª—è ${displayName}` : ""}</h2>
                </div>

                <div className="mb-3">
                  <div className="flex gap-2 overflow-auto pb-1">
                    {DEFAULT_DRINKS.map(d=>(
                      <button key={d.id} onClick={()=>setDrinkId(d.id)}
                        className={cx("px-3 py-2 rounded-xl border whitespace-nowrap transition",
                          "border-slate-200 dark:border-slate-700",
                          drinkId===d.id ? "bg-brand-500 text-white dark:text-slate-900 dark:bg-brand-300" : "bg-white/70 dark:bg-slate-800/60 hover:brightness-95"
                        )}
                        title={`–î–æ–ª—è –≤–æ–¥—ã ~ ${Math.round((d.waterFraction??1)*100)}%`}
                      >
                        <span className="mr-1">{d.emoji}</span>{d.name}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-2">
                  <button className="rounded-2xl border border-slate-200 dark:border-slate-700 px-3 py-6 hover:brightness-95 transition" onClick={()=>handleAddDrink(ML.glass)}>
                    ü•õ –°—Ç–∞–∫–∞–Ω
                    <div className="text-xs text-slate-500 dark:text-slate-400">{fmtLiters(ML.glass)}</div>
                  </button>
                  <button className="rounded-2xl border border-slate-200 dark:border-slate-700 px-3 py-6 hover:brightness-95 transition" onClick={()=>handleAddDrink(ML.bottle05)}>
                    üß¥ –ë—É—Ç—ã–ª–∫–∞ 0.5
                    <div className="text-xs text-slate-500 dark:text-slate-400">{fmtLiters(ML.bottle05)}</div>
                  </button>
                  <button className="rounded-2xl border border-slate-200 dark:border-slate-700 px-3 py-6 hover:brightness-95 transition" onClick={()=>handleAddDrink(ML.bottle15)}>
                    üß¥ –ë—É—Ç—ã–ª–∫–∞ 1.5
                    <div className="text-xs text-slate-500 dark:text-slate-400">{fmtLiters(ML.bottle15)}</div>
                  </button>
                </div>

                <div className="mt-3 flex items-center gap-2">
                  <button className="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition" onClick={handleUndo}>‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π</button>
                </div>

                <div className="mt-4">
                  <h3 className="text-sm font-semibold mb-1">–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                  <ul className="text-sm max-h-40 overflow-auto space-y-1">
                    {myHistory.map(e=>{
                      const d = DEFAULT_DRINKS.find(x=>x.id===e.drinkId) || {emoji:"",name:"",waterFraction:1};
                      const waterMl = Math.round(e.ml * (d.waterFraction ?? 1));
                      const dt = tsToDate(e.ts);
                      return (
                        <li key={e.id} className="flex justify-between">
                          <span>{d.emoji} {d.name} ‚Äî {fmtLiters(e.ml)} <span className="text-slate-500 dark:text-slate-400">(–≤–æ–¥–∞: {fmtLiters(waterMl)})</span></span>
                          <span className="text-slate-500 dark:text-slate-400">{dt.toLocaleString()}</span>
                        </li>
                      );
                    })}
                    {!myHistory.length && <li className="text-slate-500 dark:text-slate-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</li>}
                  </ul>
                </div>
              </Card>

              <Card className="p-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="font-semibold">–ú–æ–∏ –∫–æ–º–Ω–∞—Ç—ã</h2>
                  <span className="text-xs text-slate-500 dark:text-slate-400">{myRooms.length||0}</span>
                </div>
                {!myRooms.length && <div className="text-sm text-slate-500 dark:text-slate-400">–ü–æ–∫–∞ –Ω–µ—Ç.</div>}
                <ul className="space-y-2">
                  {myRooms.map(r=>{
                    const isOwner = r.ownerId && user && r.ownerId===user.uid;
                    return (
                      <li key={r.id} className="flex items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 bg-white/60 dark:bg-slate-800/50">
                        <div className="min-w-0">
                          <div className="font-medium truncate">{r.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</div>
                          <div className="text-xs text-slate-500 dark:text-slate-400">ID: <code className="font-mono">{r.id}</code></div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button onClick={()=>goToRoom(r.id)} className="px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:brightness-95 text-sm">–ü–µ—Ä–µ–π—Ç–∏</button>
                          {isOwner
                            ? <button onClick={()=>handleDeleteRoom(r.id)} className="px-3 py-1.5 rounded-lg border border-red-300 dark:border-red-700 text-red-600 dark:text-red-400 hover:brightness-95 text-sm">üóë –£–¥–∞–ª–∏—Ç—å</button>
                            : <button onClick={()=>handleLeaveRoom(r.id)} className="px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:brightness-95 text-sm">üö™ –í—ã–π—Ç–∏</button>}
                        </div>
                      </li>
                    );
                  })}
                </ul>
              </Card>
            </div>

            <Card className="p-4">
              <h2 className="font-semibold mb-3">–õ–µ–Ω—Ç–∞ –∑–∞–ø–∏—Å–µ–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</h2>
              <ul className="space-y-1 text-sm max-h-80 overflow-auto">
                {entriesForPeriod
                  .sort((a,b)=> tsToDate(b.ts) - tsToDate(a.ts))
                  .map(e=>{
                    const mem = memberMap.get(e.userId);
                    const d = DEFAULT_DRINKS.find(x=>x.id===e.drinkId) || {emoji:"",name:"",waterFraction:1};
                    const waterMl = Math.round(e.ml * (d.waterFraction ?? 1));
                    const dt = tsToDate(e.ts);
                    return (
                      <li key={e.id} className="flex items-center justify-between">
                        <span><strong>{mem?.name || "–£—á–∞—Å—Ç–Ω–∏–∫"}</strong> ‚Äî {d.emoji} {d.name} ‚Ä¢ {fmtLiters(e.ml)} <span className="text-slate-500 dark:text-slate-400">(–≤–æ–¥–∞: {fmtLiters(waterMl)})</span></span>
                        <span className="text-slate-500 dark:text-slate-400">{dt.toLocaleString()}</span>
                      </li>
                    );
                  })}
                {!entriesForPeriod.length && <li className="text-slate-500 dark:text-slate-400">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥</li>}
              </ul>
            </Card>

            <p className="text-xs text-slate-600 dark:text-slate-400 text-center py-2">
              –°–¥–µ–ª–∞–Ω–æ –Ω–∞ React + Tailwind. –î–∞–Ω–Ω—ã–µ ‚Äî Firebase Firestore.
            </p>
          </div>
        </div>
      );
    }

    function JoinForm({ onJoin, onSetName, displayName }){
      const [id,setId] = React.useState("");
      return (
        <div>
          <label className="text-sm block mb-3">
            –í–∞—à–µ –∏–º—è:
            <input value={displayName} onChange={e=>onSetName(e.target.value)} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê—Ä—Ç—ë–º"
              className="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent"/>
          </label>
          <label className="text-sm block mb-3">
            ID –∫–æ–º–Ω–∞—Ç—ã:
            <input value={id} onChange={e=>setId(e.target.value)} placeholder="–í—Å—Ç–∞–≤—å—Ç–µ ROOM_ID"
              className="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent"/>
          </label>
          <button onClick={()=>onJoin(id)} className="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">‚¨áÔ∏è –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>
