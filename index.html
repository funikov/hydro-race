<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞ ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ø–æ –≤–æ–¥–µ</title>

  <style>
    :root { --bg1:#090d1d; --bg2:#0f172a; --border:rgba(148,163,184,.16); --muted:#94a3b8; --text:#e5e7eb; --brand:#22d3ee; --brand2:#60a5fa; --shadow:0 20px 40px rgba(0,0,0,.35); --radius:18px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;
      background:radial-gradient(1200px 900px at 10% -10%, #0b122a, transparent),
                 radial-gradient(900px 700px at 120% 10%, #0a3f5d, transparent),
                 linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
      color:var(--text)
    }
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 18px;background:rgba(8,14,28,.55);backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
    .brand{display:flex;gap:12px;align-items:center}
    .drop{width:30px;height:30px;border-radius:10px;background:radial-gradient(circle at 30% 20%, #7dd3fc, transparent 35%),radial-gradient(circle at 60% 60%, #22d3ee, transparent 40%),radial-gradient(circle at 70% 30%, #60a5fa, transparent 45%);box-shadow:inset 0 0 14px rgba(255,255,255,.25),0 8px 22px rgba(34,211,238,.35)}
    .title{font-weight:800}.subtitle{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .btn{border:0;color:#06111c;background:linear-gradient(180deg, var(--brand) 0%, #1bc0d9 100%);padding:10px 16px;border-radius:999px;cursor:pointer;font-weight:800;letter-spacing:.3px;box-shadow:0 6px 16px rgba(34,211,238,.35);transition:transform .08s ease, filter .2s ease}
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}

    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media(max-width:960px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(96,165,250,.06), rgba(34,211,238,.05));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;position:relative;overflow:clip}
    .card::after{content:"";position:absolute;inset:-2px;z-index:-1;border-radius:calc(var(--radius) + 8px);background:radial-gradient(600px 400px at 0% -10%, rgba(34,211,238,.25), transparent 40%),radial-gradient(500px 420px at 120% 10%, rgba(96,165,250,.18), transparent 50%);filter:blur(20px)}
    h2{margin:0 0 10px 0;font-size:20px}
    .stat{display:flex;align-items:baseline;gap:10px}.stat .big{font-size:44px;font-weight:900;letter-spacing:.3px}
    .unit{color:var(--muted)} .muted{color:var(--muted);font-size:13px}

    .chipbar{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 10px}
    .chip{border:1px dashed rgba(148,163,184,.35);color:var(--text);background:rgba(2,6,23,.45);padding:10px 14px;border-radius:12px;cursor:pointer;transition:border-color .2s ease, transform .08s ease}
    .chip:hover{border-color:rgba(148,163,184,.6)} .chip:active{transform:translateY(1px)}
    .custom-add{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input[type=number]{width:140px;background:#0a0f1d;color:var(--text);border:1px solid rgba(148,163,184,.28);border-radius:12px;padding:10px 12px}

    .tabs{display:inline-flex;gap:4px;background:rgba(2,6,23,.45);border:1px solid var(--border);border-radius:12px;padding:4px}
    .tab{background:transparent;color:var(--text);border:0;padding:8px 12px;cursor:pointer;border-radius:10px;font-weight:700;transition:background .2s ease, color .2s ease}
    .tab.active{background:linear-gradient(180deg, rgba(34,211,238,.18), rgba(96,165,250,.12));color:#e7fbff}

    /* –ù–∞–ø–∏—Ç–∫–∏ */
    .bev-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:8px 0 14px}
    @media(max-width:520px){.bev-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .bev{display:grid;place-items:center;gap:6px;padding:12px 8px;border-radius:14px;border:1px solid var(--border);background:rgba(2,6,23,.45);cursor:pointer;text-align:center;transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease}
    .bev:hover{border-color:rgba(148,163,184,.35)} .bev.selected{border-color:rgba(34,211,238,.8);box-shadow:0 0 0 2px rgba(34,211,238,.25) inset}
    .bev .icon{width:28px;height:28px} .bev .name{font-size:12px;color:var(--text)}

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
    .progress-wrap{display:flex;gap:18px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .progress{position:relative;width:120px;height:120px}
    .progress svg{width:120px;height:120px;transform:rotate(-90deg)}
    .progress .ring-bg{stroke:rgba(148,163,184,.18);stroke-width:10;fill:none}
    .progress .ring-fg{stroke:var(--brand);stroke-linecap:round;stroke-width:10;fill:none;transition:stroke-dashoffset .5s ease}
    .progress .inside{position:absolute;inset:0;display:grid;place-items:center;text-align:center}
    .progress .inside .big{font-weight:900;font-size:18px;display:inline-block;white-space:nowrap;transform-origin:center center}
    .goal-controls{display:flex;gap:8px;align-items:center}

    .hidden{display:none!important}

    /* –ë—Ä—ã–∑–≥–∏ üí¶ */
    #splashLayer{position:fixed;inset:0;pointer-events:none;z-index:9999}
    .splash-particle{position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, #7dd3fc, #22d3ee 60%);opacity:.95;filter:drop-shadow(0 6px 16px rgba(34,211,238,.25));animation:splash 720ms ease-out forwards}
    .splash-ripple{position:absolute;width:12px;height:12px;border:2px solid rgba(34,211,238,.7);border-radius:50%;transform:translate(-50%,-50%) scale(.2);opacity:.9;animation:ripple 650ms ease-out forwards}
    @keyframes splash{0%{transform:translate(0,0) scale(.85);opacity:.95}80%{opacity:1}100%{transform:translate(var(--dx), var(--dy)) scale(.2);opacity:0}}
    @keyframes ripple{to{transform:translate(-50%,-50%) scale(4.2);opacity:0}}

    /* –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º + –æ—Å—å Y + —Å–µ—Ç–∫–∞ */
    .hour-wrap{display:flex;gap:8px;align-items:flex-end}
    .y-axis{position:relative;height:140px;width:40px;margin-top:8px}
    .y-axis .ylabel{position:absolute;left:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);writing-mode:vertical-rl;transform:rotate(180deg)}
    .yticks{position:absolute;right:0;top:0;bottom:0;display:flex;flex-direction:column;justify-content:space-between;align-items:flex-end;font-size:11px;color:var(--muted)}
    .yticks .tick{line-height:1}
    .hour-chart{
      position:relative;
      flex:1;
      display:flex;gap:4px;align-items:flex-end;height:140px;margin-top:8px;padding:10px;
      border:1px solid var(--border);border-radius:12px;background:#0b1220
    }
    .hgrid{position:absolute;inset:10px;pointer-events:none}
    .hgrid .line{position:absolute;left:0;right:0;height:1px;background:rgba(148,163,184,.14)}
    .hour-bar{flex:1;min-width:0;height:8px;border-radius:6px 6px 0 0;background:linear-gradient(180deg, rgba(34,211,238,.9), rgba(96,165,250,.65));transition:height .35s ease}
    .hour-axis{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}

    /* –ê—á–∏–≤–∫–∏ */
    .ach-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:8px}
    @media(max-width:520px){.ach-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .ach{display:grid;place-items:center;gap:6px;padding:10px;border:1px solid var(--border);border-radius:12px;background:rgba(2,6,23,.45)}
    .ach .badge{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;color:#0b1020;background:linear-gradient(180deg, var(--brand), var(--brand2));box-shadow:0 6px 16px rgba(34,211,238,.25)}
    .ach.locked{opacity:.6;filter:grayscale(0.4)}

    /* –ú–æ–¥–∞–ª–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –º–µ—Å—è—Ü–∞ */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:10000}
    .modal{width:min(880px,92vw);max-height:80vh;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,.16);text-align:right}
    .table th:first-child,.table td:first-child{text-align:left}
    .tfoot td{font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="drop" aria-hidden="true"></div>
      <div>
        <div class="title">–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞</div>
        <div class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø–∏—Ç–æ–∫ ‚Äî —Å—á–∏—Ç–∞–µ–º –≤–æ–¥—É-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏ üíß</div>
      </div>
    </div>

    <div class="row" id="authRow">
      <div class="row hidden" id="userInfo">
        <div class="avatar" id="userAvatar" style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#0a0f1d"></div>
        <div class="name" id="userName"></div>
      </div>
      <button class="btn" id="signInBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      <button class="btn secondary hidden" id="signOutBtn">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <main id="app" class="hidden">
    <div class="grid">
      <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
      <section class="card" aria-labelledby="myDayTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="myDayTitle">–ú–æ–π –¥–µ–Ω—å</h2>
          <div class="muted" id="todayLabel"></div>
        </div>

        <div class="bev-grid" id="bevGrid" aria-label="–í—ã–±–æ—Ä –Ω–∞–ø–∏—Ç–∫–∞"></div>
        <div class="muted" id="factorHint"></div>

        <div class="progress-wrap">
          <div class="progress" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <circle class="ring-bg" cx="60" cy="60" r="52" />
              <circle class="ring-fg" id="goalFg" cx="60" cy="60" r="52" stroke-dasharray="327" stroke-dashoffset="327" />
            </svg>
            <div class="inside">
              <div class="big" id="goalNumbers">0.0 / 3.0 –ª</div>
              <div class="muted" id="goalPercent">0%</div>
            </div>
          </div>
          <div>
            <div class="stat" aria-live="polite">
              <div class="big" id="myTotalWaterLiters">0,0</div>
              <div class="unit">–ª –≤–æ–¥—ã-—ç–∫–≤.</div>
            </div>
            <div class="muted" id="myRawTotal" style="margin-top:4px">–í—Å–µ–≥–æ –Ω–∞–ø–∏—Ç–∫–æ–≤: 0,0 –ª</div>
            <div class="goal-controls" style="margin-top:10px">
              <label for="goalInput" class="muted">–¶–µ–ª—å –Ω–∞ –¥–µ–Ω—å:</label>
              <input id="goalInput" type="number" min="0.5" max="10" step="0.1" placeholder="–ª" style="width:90px" />
              <span class="muted">–ª</span>
              <button class="btn secondary" id="saveGoalBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div class="hint" id="lastAction" style="margin-top:6px"></div>
          </div>
        </div>

        <div class="chipbar" aria-label="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å">
          <button class="chip" data-add="250">+ —Å—Ç–∞–∫–∞–Ω (250 –º–ª)</button>
          <button class="chip" data-add="500">+ –±—É—Ç—ã–ª–∫–∞ 0,5 –ª</button>
          <button class="chip" data-add="1500">+ –±—É—Ç—ã–ª–∫–∞ 1,5 –ª</button>
        </div>

        <div class="custom-add" style="margin-top:10px">
          <input id="customInput" type="number" min="1" step="1" placeholder="–î—Ä—É–≥–æ–µ, –º–ª" />
          <button class="btn" id="addCustomBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn secondary" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="muted" style="margin-top:6px">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, -250) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.</div>
      </section>

      <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –õ–ò–î–ï–†–ë–û–†–î -->
      <section class="card" aria-labelledby="lbTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="lbTitle">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            <div class="tabs" role="tablist">
              <button class="tab active" data-scope="day" role="tab" aria-selected="true">–î–µ–Ω—å</button>
              <button class="tab" data-scope="month" role="tab" aria-selected="false">–ú–µ—Å—è—Ü</button>
              <button class="tab" data-scope="year" role="tab" aria-selected="false">–ì–æ–¥</button>
            </div>
            <button class="btn secondary" id="openMonthDailyBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ –¥–Ω—è–º –º–µ—Å—è—Ü–∞">–î–Ω–∏ –º–µ—Å—è—Ü–∞</button>
          </div>
        </div>
        <div class="muted" id="periodLabel" style="margin:8px 0 12px;"></div>
        <div class="lb-list" id="lbList" aria-live="polite"></div>
        <div class="muted" style="margin-top:6px">–†–µ–π—Ç–∏–Ω–≥ –ø–æ –≤–æ–¥–µ-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—É; –æ–±—â–∏–π –æ–±—ä—ë–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.</div>
      </section>

      <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
      <section class="card" aria-labelledby="insightsTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="insightsTitle">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
          <div class="muted">–ø–æ –≤–æ–¥–µ-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—É</div>
        </div>

        <div class="muted" style="margin-top:6px">–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –ø–æ —á–∞—Å–∞–º (—Å–µ–≥–æ–¥–Ω—è)</div>
        <div class="hour-wrap">
          <div class="y-axis">
            <div class="ylabel">–º–ª</div>
            <div id="yTicks" class="yticks"></div>
          </div>
          <div id="hourChart" class="hour-chart" aria-label="–ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º"></div>
        </div>
        <div class="hour-axis"><span>0</span><span>6</span><span>12</span><span>18</span><span>24</span></div>
        <div id="hourEmpty" class="muted" style="margin-top:8px;text-align:center;display:none;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>

        <div class="muted" style="margin-top:14px">–ê—á–∏–≤–∫–∏</div>
        <div id="achievements" class="ach-grid"></div>
      </section>
    </div>
  </main>

  <footer style="max-width:1100px;margin:26px auto 60px;padding:0 16px;" class="muted">
    –û–¥–∏–Ω HTML-—Ñ–∞–π–ª –Ω–∞ Firebase + Firestore. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ —Ä–µ–π—Ç–∏–Ω–≥ —Å—á–∏—Ç–∞—é—Ç –≤–æ–¥—É-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç. –ê—á–∏–≤–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫ ‚Äî –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏ ¬´–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ–≥–æ–¥–Ω—è¬ª.
  </footer>

  <template id="lbRowTpl">
    <div class="lb-item" style="display:grid;grid-template-columns:28px 1fr auto;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(148,163,184,.2)">
      <div class="muted rank"></div>
      <div class="row" style="gap:10px; overflow:hidden;">
        <div class="avatar av" style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#0a0f1d"></div>
        <div class="name nm" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
      </div>
      <div class="amt am" style="font-weight:700"></div>
    </div>
  </template>

  <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û "–î–ù–ò –ú–ï–°–Ø–¶–ê" -->
  <div id="monthModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="monthTitle">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div id="monthTitle" style="font-weight:800;font-size:18px">–ú–µ—Å—è—Ü –ø–æ –¥–Ω—è–º</div>
          <div class="muted" id="monthSubTitle"></div>
        </div>
        <button class="btn secondary" id="monthCloseBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div style="overflow:auto;">
        <table class="table" id="monthTable">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–í–æ–¥–∞-—ç–∫–≤., –ª</th>
              <th>–í—Å–µ–≥–æ, –ª</th>
              <th>–ö —Ü–µ–ª–∏</th>
            </tr>
          </thead>
          <tbody id="monthTableBody"></tbody>
          <tfoot>
            <tr class="tfoot">
              <td>–ò—Ç–æ–≥–æ</td>
              <td id="sumWater">0</td>
              <td id="sumTotal">0</td>
              <td id="sumShare">‚Äî</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div id="splashLayer"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection, onSnapshot, orderBy, limit, query, getDocs, increment, where, collectionGroup, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // === Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8z2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };

    // === Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    setPersistence(auth, browserLocalPersistence).catch(console.warn);
    getRedirectResult(auth).catch(()=>{});

    // === Icons + beverages
    const ICONS = {
      water:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2s6 7.2 6 11.2A6 6 0 1 1 6 13.2C6 9.2 12 2 12 2Z" stroke="currentColor" stroke-width="1.5"/></svg>`,
      tea:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 10h11a4 4 0 0 1 0 8H9a5 5 0 0 1-5-5v-3Z" stroke="currentColor" stroke-width="1.5"/><path d="M15 10h3a3 3 0 1 1 0 6h-2" stroke="currentColor" stroke-width="1.5"/></svg>`,
      coffee:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 10h10a4 4 0 0 1 0 8H9a5 5 0 0 1-5-5v-3Z" stroke="currentColor" stroke-width="1.5"/><path d="M16 10h3a3 3 0 1 1 0 6h-2" stroke="currentColor" stroke-width="1.5"/><path d="M8 4c0 1 .8 1.5.8 2.4S8 8 8 8M11 4c0 1 .8 1.5.8 2.4S11 8 11 8" stroke="currentColor" stroke-width="1.5"/></svg>`,
      milk:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 3h8l-2 3v13a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V6L8 3Z" stroke="currentColor" stroke-width="1.5"/><path d="M10 11h4M10 15h4" stroke="currentColor" stroke-width="1.5"/></svg>`,
      cola_zero:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 3h6l-1 4v9a4 4 0 0 1-4 4h0a4 4 0 0 1-4-4V7l3-4Z" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="1.5"/></svg>`,
      kvass:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 3h10l-1 4v9a4 4 0 0 1-4 4h0a4 4 0 0 1-4-4V7L7 3Z" stroke="currentColor" stroke-width="1.5"/><path d="M8 9h8" stroke="currentColor" stroke-width="1.5"/></svg>`,
      juice:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6h12l-1 3v9a3 3 0 0 1-3 3H10a3 3 0 0 1-3-3V9L6 6Z" stroke="currentColor" stroke-width="1.5"/><path d="M9 3h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      lemonade:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="6" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M5 7h10l-1 3v8a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3V10L5 7Z" stroke="currentColor" stroke-width="1.5"/></svg>`
    };
    const BEVERAGES = [
      { key:'water',    name:'–í–æ–¥–∞',               factor: 1.00 },
      { key:'tea',      name:'–ß–∞–π',                factor: 0.98 },
      { key:'coffee',   name:'–ö–æ—Ñ–µ',               factor: 0.90 },
      { key:'milk',     name:'–ú–æ–ª–æ–∫–æ',             factor: 0.87 },
      { key:'cola_zero',name:'–ö–æ–ª–∞ –ª–∞–π—Ç/0 —Å–∞—Ö–∞—Ä',  factor: 0.95 },
      { key:'kvass',    name:'–ö–≤–∞—Å',               factor: 0.92 },
      { key:'juice',    name:'–°–æ–∫–∏',               factor: 0.90 },
      { key:'lemonade', name:'–õ–∏–º–æ–Ω–∞–¥—ã',           factor: 0.90 },
    ];

    // --- UI refs
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn= document.getElementById('signOutBtn');
    const userInfoEl= document.getElementById('userInfo');
    const userNameEl= document.getElementById('userName');
    const userAvatarEl=document.getElementById('userAvatar');
    const appEl     = document.getElementById('app');

    const todayLabelEl = document.getElementById('todayLabel');
    const bevGrid = document.getElementById('bevGrid');
    const factorHintEl = document.getElementById('factorHint');

    const myTotalWaterLitersEl = document.getElementById('myTotalWaterLiters');
    const myRawTotalEl         = document.getElementById('myRawTotal');
    const lastActionEl         = document.getElementById('lastAction');

    const addChips = Array.from(document.querySelectorAll('[data-add]'));
    const customInput = document.getElementById('customInput');
    const addCustomBtn= document.getElementById('addCustomBtn');
    const undoBtn     = document.getElementById('undoBtn');

    const lbListEl = document.getElementById('lbList');
    const periodLabelEl = document.getElementById('periodLabel');
    const tabs = Array.from(document.querySelectorAll('.tab'));

    // Progress
    const goalFg = document.getElementById('goalFg');
    const goalNumbers = document.getElementById('goalNumbers');
    const goalPercent = document.getElementById('goalPercent');
    const goalInput   = document.getElementById('goalInput');
    const saveGoalBtn = document.getElementById('saveGoalBtn');
    let currentGoalMl = 3000; const CIRC = 2 * Math.PI * 52;

    // Month modal
    const monthModal      = document.getElementById('monthModal');
    const monthCloseBtn   = document.getElementById('monthCloseBtn');
    const monthTitle      = document.getElementById('monthTitle');
    const monthSubTitle   = document.getElementById('monthSubTitle');
    const monthTableBody  = document.getElementById('monthTableBody');
    const openMonthDailyBtn = document.getElementById('openMonthDailyBtn');
    const sumWaterEl = document.getElementById('sumWater');
    const sumTotalEl = document.getElementById('sumTotal');
    const sumShareEl = document.getElementById('sumShare');

    function setRingProgress(ratio){ const clamped = Math.max(0, Math.min(1, ratio || 0)); goalFg.setAttribute('stroke-dasharray', String(CIRC)); goalFg.setAttribute('stroke-dashoffset', String(CIRC * (1 - clamped))); }
    function fitGoalText(){ const wrap = document.querySelector('.progress .inside'); if (!wrap || !goalNumbers) return; goalNumbers.style.transform = 'scale(1)'; const maxW = Math.max(10, wrap.clientWidth - 12); const w = goalNumbers.scrollWidth; goalNumbers.style.transform = `scale(${Math.min(1, maxW / w)})`; }
    window.addEventListener('resize',(()=>{let t;return()=>{clearTimeout(t);t=setTimeout(fitGoalText,120);}})());
    function updateProgressUI(water_ml){ const goal = Math.max(0, currentGoalMl || 0); const ratio = goal > 0 ? water_ml / goal : 0; setRingProgress(ratio); goalNumbers.textContent = `${(water_ml/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} / ${(goal/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} –ª`; goalPercent.textContent = `${Math.round(Math.max(0, Math.min(100, ratio*100)))}%`; fitGoalText(); }

    // Beverages UI
    let currentBevKey = 'water';
    function renderBeverages(){ bevGrid.innerHTML = ''; BEVERAGES.forEach(b => { const btn = document.createElement('button'); btn.className='bev'+(b.key===currentBevKey?' selected':''); btn.type='button'; btn.dataset.key=b.key; btn.innerHTML = `${ICONS[b.key]||''}<div class="name">${b.name}</div>`; const ic = btn.querySelector('.icon'); if (ic) ic.style.color = b.key==='water' ? '#7dd3fc' : '#cfe6ff'; btn.addEventListener('click', ()=>{ currentBevKey=b.key; updateFactorHint(); renderBeverages(); }); bevGrid.appendChild(btn); }); }
    function updateFactorHint(){ const bev = BEVERAGES.find(b=>b.key===currentBevKey); factorHintEl.textContent = `–°–µ–π—á–∞—Å: ${bev.name} ‚Äî –º–Ω–æ–∂–∏—Ç–µ–ª—å √ó${bev.factor}`; }
    renderBeverages(); updateFactorHint();

    // Dates
    const pad=(n)=>String(n).padStart(2,'0');
    const keysFor=(date=new Date())=>({ dateStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`, monthStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}`, yearStr:`${date.getFullYear()}` });
    todayLabelEl.textContent = `–°–µ–≥–æ–¥–Ω—è: ${new Date().toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short', year:'numeric'})}`;

    // Auth
    signInBtn.addEventListener('click', async ()=>{ const provider = new GoogleAuthProvider(); provider.setCustomParameters({ prompt:'select_account' }); try{ await signInWithPopup(auth, provider); }catch(e){ if (e?.code==='auth/operation-not-supported-in-this-environment' || e?.code==='auth/popup-blocked'){ await signInWithRedirect(auth, provider); } else { alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+(e?.message||e)); } }});
    signOutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

    let unsubMyDaily=null, unsubLB=null, unsubUserDoc=null, unsubAch=null, unsubIntakes=null;
    const cleanupSubscriptions=()=>{ if (unsubMyDaily){unsubMyDaily();unsubMyDaily=null} if (unsubLB){unsubLB();unsubLB=null} if (unsubUserDoc){unsubUserDoc();unsubUserDoc=null} if (unsubAch){unsubAch();unsubAch=null} if (unsubIntakes){unsubIntakes();unsubIntakes=null} };

    onAuthStateChanged(auth, async (user)=>{
      fitGoalText();
      if (user){
        appEl.classList.remove('hidden');
        signInBtn.classList.add('hidden'); signOutBtn.classList.remove('hidden'); userInfoEl.classList.remove('hidden');
        userNameEl.textContent = user.displayName || user.email;
        userAvatarEl.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä" width="32" height="32"/>` : '';

        const userRef = doc(db, 'users', user.uid);
        await setDoc(userRef, { uid:user.uid, displayName:user.displayName||null, email:user.email||null, photoURL:user.photoURL||null, lastLoginAt:serverTimestamp(), createdAt:serverTimestamp() }, { merge:true });

        unsubUserDoc = onSnapshot(userRef, async (snap)=>{
          const d = snap.data() || {};
          if (typeof d.daily_goal_ml !== 'number'){ await setDoc(userRef, { daily_goal_ml: 3000 }, { merge:true }); currentGoalMl = 3000; }
          else { currentGoalMl = Math.min(10000, Math.max(500, Math.round(d.daily_goal_ml))); }
          goalInput.value = (currentGoalMl/1000).toFixed(1);
          updateProgressUI(lastWaterMl);
        });

        subscribeMyDailyTotal();
        subscribeIntakesToday();
        renderHourChart(); // –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ/—Å–µ—Ç–∫–∞
        subscribeAchievements();
        activateTab('day');
      } else {
        appEl.classList.add('hidden');
        signInBtn.classList.remove('hidden'); signOutBtn.classList.add('hidden'); userInfoEl.classList.add('hidden');
        cleanupSubscriptions();
      }
    });

    // tabs click handlers
    if (!window.__tabsBound) {
      tabs.forEach(tab => {
        tab.addEventListener('click', () => activateTab(tab.dataset.scope));
        tab.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activateTab(tab.dataset.scope); }
        });
      });
      window.__tabsBound = true;
    }

    saveGoalBtn.addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user) return;
      const liters = parseFloat(goalInput.value);
      if (!Number.isFinite(liters)){ alert('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å –≤ –ª–∏—Ç—Ä–∞—Ö'); return; }
      const clamped = Math.min(10, Math.max(0.5, liters));
      const ml = Math.round(clamped*1000);
      await setDoc(doc(db,'users', user.uid), { daily_goal_ml: ml }, { merge:true });
      currentGoalMl = ml; updateProgressUI(lastWaterMl);
      toast(`–¶–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: ${clamped.toFixed(1)} –ª/–¥–µ–Ω—å`);
    });

    function toast(msg){ lastActionEl.textContent = msg; lastActionEl.classList.add('success'); setTimeout(()=>{ lastActionEl.textContent=''; lastActionEl.classList.remove('success'); }, 2500); }

    // Aggregations
    let lastWaterMl = 0;
    function subscribeMyDailyTotal(){
      if (unsubMyDaily) unsubMyDaily();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const ref = doc(db, 'daily_totals', dateStr, 'users', uid);
      unsubMyDaily = onSnapshot(ref, async (snap)=>{
        const d = snap.exists()? snap.data() : { total_water_ml:0, total_ml:0 };
        const water = d.total_water_ml || 0; const raw = d.total_ml || 0;
        lastWaterMl = water;
        myTotalWaterLitersEl.textContent = (water/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2});
        myRawTotalEl.textContent = `–í—Å–µ–≥–æ –Ω–∞–ø–∏—Ç–∫–æ–≤: ${(raw/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} –ª`;
        updateProgressUI(water);
        await checkStreakAndAchievements(water);
      });
    }

    function activateTab(scope){
      tabs.forEach(t=>{ const a=t.dataset.scope===scope; t.classList.toggle('active',a); t.setAttribute('aria-selected',a?'true':'false'); });
      if (unsubLB){unsubLB();unsubLB=null;}
      const now = new Date(); const { dateStr, monthStr, yearStr } = keysFor(now);
      let colRef,label;
      if (scope==='day'){ colRef=collection(db,'daily_totals',dateStr,'users'); label=`–°–µ–≥–æ–¥–Ω—è ‚Äî ${now.toLocaleDateString()}`; }
      else if (scope==='month'){ colRef=collection(db,'monthly_totals',monthStr,'users'); label=`–ú–µ—Å—è—Ü ‚Äî ${now.toLocaleString(undefined,{month:'long',year:'numeric'})}`; }
      else { colRef=collection(db,'yearly_totals',yearStr,'users'); label=`–ì–æ–¥ ‚Äî ${yearStr}`; }
      periodLabelEl.textContent = label;
      unsubLB = onSnapshot(query(colRef, orderBy('total_water_ml','desc'), limit(50)), (qs)=>renderLeaderboard(qs.docs.map(d=>d.data())));
    }
    function renderLeaderboard(items){
      lbListEl.innerHTML='';
      if (!items.length){ lbListEl.innerHTML='<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üíß</div>'; return; }
      const tpl = document.getElementById('lbRowTpl');
      items.forEach((it,i)=>{
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.rank').textContent = i+1;
        node.querySelector('.av').innerHTML = it.photoURL ? `<img src="${it.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä" width="32" height="32"/>` : '';
        node.querySelector('.nm').textContent = it.displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        node.querySelector('.am').textContent = `${(Math.max(0,it.total_water_ml||0)/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} –ª –≤–æ–¥—ã-—ç–∫–≤.`;
        lbListEl.appendChild(node);
      });
    }

    // –ë—Ä—ã–∑–≥–∏
    const splashLayer = document.getElementById('splashLayer');
    function splashAt(x,y,opts={}){ const count = opts.count || 14; for(let i=0;i<count;i++){ const p=document.createElement('div'); p.className='splash-particle'; const angle=Math.random()*Math.PI*2; const dist=40+Math.random()*70; const dx=Math.cos(angle)*dist; const dy=Math.sin(angle)*dist-10; const size=6+Math.random()*8; p.style.setProperty('--dx',dx+'px'); p.style.setProperty('--dy',dy+'px'); p.style.width=size+'px'; p.style.height=size+'px'; p.style.left=(x-size/2)+'px'; p.style.top=(y-size/2)+'px'; if (opts.neg){ p.style.background='radial-gradient(circle at 30% 30%, #fca5a5, #f87171 60%)'; p.style.filter='drop-shadow(0 6px 16px rgba(248,113,113,.25))'; } splashLayer.appendChild(p); p.addEventListener('animationend',()=>p.remove()); } const r=document.createElement('div'); r.className='splash-ripple'; r.style.left=x+'px'; r.style.top=y+'px'; if (opts.neg){ r.style.borderColor='rgba(248,113,113,.7)'; } splashLayer.appendChild(r); r.addEventListener('animationend',()=>r.remove()); }
    function splashNearTotal(neg){ const el=document.getElementById('myTotalWaterLiters'); const rect=el.getBoundingClientRect(); splashAt(rect.left+rect.width/2, rect.top+rect.height/2, {neg:!!neg, count:10}); }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –æ—Ç–º–µ–Ω–∞
    addChips.forEach(btn=>btn.addEventListener('click',(e)=>{const ml=parseInt(btn.dataset.add,10); addAmount(ml); if(e && e.clientX!=null){ splashAt(e.clientX,e.clientY,{neg:ml<0}); }}));
    addCustomBtn.addEventListener('click', ()=>{ const v=parseInt(customInput.value,10); if (!Number.isFinite(v) || v===0){ toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–ª (–Ω–µ 0)'); return; } addAmount(v); customInput.value=''; const r = addCustomBtn.getBoundingClientRect(); splashAt(r.left+r.width/2, r.top+r.height/2, {neg:v<0}); });
    undoBtn.addEventListener('click', undoLast);

    async function addAmount(ml){
      const user=auth.currentUser; if(!user) return;
      const bev = BEVERAGES.find(b=>b.key===currentBevKey) || BEVERAGES[0];
      const water_ml = Math.round(ml * bev.factor);
      const now = new Date(); const { dateStr, monthStr, yearStr } = keysFor(now);

      const batch = writeBatch(db);
      const intakeRef = doc(collection(db,'intakes'));
      batch.set(intakeRef, { uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, ml, beverage:bev.key, beverage_name:bev.name, factor:bev.factor, water_ml, ts:serverTimestamp(), dateStr, monthStr, yearStr });

      const base={ uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, updatedAt:serverTimestamp() };
      batch.set(doc(db,'daily_totals',dateStr,'users',user.uid),   { ...base, dateStr,  total_ml: increment(ml), total_water_ml: increment(water_ml) }, { merge:true });
      batch.set(doc(db,'monthly_totals',monthStr,'users',user.uid),{ ...base, monthStr, total_ml: increment(ml), total_water_ml: increment(water_ml) }, { merge:true });
      batch.set(doc(db,'yearly_totals',yearStr,'users',user.uid), { ...base, yearStr,  total_ml: increment(ml), total_water_ml: increment(water_ml) }, { merge:true });

      await batch.commit();
      splashNearTotal(ml<0);
      toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${ml>0?'+':''}${ml} –º–ª (${bev.name} ‚Üí ${water_ml} –º–ª –≤–æ–¥—ã-—ç–∫–≤.)`);
    }

    async function undoLast(){
      const user=auth.currentUser; if(!user) return;
      const { dateStr } = keysFor(new Date());
      const qs = await getDocs(query(collection(db,'intakes'), orderBy('ts','desc'), limit(50)));
      const mine = qs.docs.find(d=> d.data().uid===user.uid && d.data().dateStr===dateStr);
      if (!mine){ toast('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è'); return; }
      const data = mine.data();
      const wml = data.water_ml || Math.round(data.ml * (data.factor||1));
      const batch = writeBatch(db);
      batch.set(doc(db,'daily_totals',dateStr,'users',user.uid),   { total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'monthly_totals',data.monthStr,'users',user.uid),{ total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'yearly_totals',data.yearStr,'users',user.uid), { total_ml: increment(-data.ml), total_water_ml: increment(-wml), updatedAt:serverTimestamp() }, { merge:true });
      await batch.commit();
      toast('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
    }

    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º + —Å–µ—Ç–∫–∞
    const hourChart = document.getElementById('hourChart');
    const hourEmpty = document.getElementById('hourEmpty');
    const yTicksEl  = document.getElementById('yTicks');
    let hourData = new Array(24).fill(0);

    function subscribeIntakesToday(){
      if (unsubIntakes) unsubIntakes();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const qy = query(collection(db,'intakes'), where('uid','==',uid), where('dateStr','==',dateStr));
      unsubIntakes = onSnapshot(qy, (qs)=>{
        hourData = new Array(24).fill(0);
        qs.forEach(d=>{
          const it=d.data();
          const ts=it.ts?.toDate ? it.ts.toDate() : new Date();
          const h=(ts instanceof Date) ? ts.getHours() : 0;
          const wml = it.water_ml || Math.round((it.ml||0) * (it.factor||1));
          if (h>=0 && h<24) hourData[h] += Math.max(0, wml);
        });
        renderHourChart();
      });
    }

    function niceStep(max, target=4){
      if (!isFinite(max) || max<=0) return 250;
      const raw = max / target;
      const pow = Math.pow(10, Math.floor(Math.log10(raw)));
      const base = raw / pow;
      let mult = 1; if (base<=1) mult=1; else if (base<=2) mult=2; else if (base<=5) mult=5; else mult=10;
      let step = mult * pow;
      step = Math.max(50, Math.round(step/50)*50); // –∫—Ä–∞—Ç–Ω–æ 50 –º–ª
      return step;
    }
    function renderYAxis(niceMax, step){
      if (yTicksEl) {
        const ticks = [];
        for (let v = niceMax; v >= 0; v -= step) ticks.push(v);
        yTicksEl.innerHTML = ticks.map(v=>`<div class="tick">${v}</div>`).join('');
      }
      if (hourChart) {
        const inner = 120;
        const grid = document.createElement('div'); grid.className = 'hgrid';
        for (let v = 0; v <= niceMax; v += step) {
          const y = inner - Math.round((v/(niceMax||1)) * inner);
          const line = document.createElement('div'); line.className = 'line'; line.style.top = y + 'px';
          grid.appendChild(line);
        }
        hourChart.appendChild(grid);
      }
    }
    function renderHourChart(){
      hourChart.innerHTML='';
      const total = hourData.reduce((a,b)=>a+b,0);
      if (hourEmpty) hourEmpty.style.display = total > 0 ? 'none' : 'block';

      const defaultMax = 1000, defaultStep = 250;
      if (total <= 0) { renderYAxis(defaultMax, defaultStep); return; }

      const max = Math.max(1, ...hourData);
      const step = niceStep(max, 4);
      const niceMax = Math.ceil(max / step) * step;
      renderYAxis(niceMax, step);

      for(let i=0;i<24;i++){
        const bar=document.createElement('div'); bar.className='hour-bar';
        const ratio = hourData[i] / (niceMax || 1);
        bar.style.height = Math.max(8, Math.round(120*ratio))+'px';
        bar.title = `${i}:00 ‚Äî ${hourData[i].toLocaleString()} –º–ª`;
        hourChart.appendChild(bar);
      }
    }

    // –ê—á–∏–≤–∫–∏ + streaks
    const achGrid = document.getElementById('achievements');
    const ACH_DEFS = [
      { id:'first_liter', name:'–ü–µ—Ä–≤—ã–π –ª–∏—Ç—Ä', desc:'1 –ª –∑–∞ –¥–µ–Ω—å', icon:'üíß' },
      { id:'goal_today',  name:'–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞', desc:'–í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–Ω–µ–≤–Ω—É—é —Ü–µ–ª—å', icon:'üéØ' },
      { id:'streak_3',    name:'–°–µ—Ä–∏—è √ó3', desc:'3 –¥–Ω—è –ø–æ–¥—Ä—è–¥', icon:'üî•' },
      { id:'streak_7',    name:'–°–µ—Ä–∏—è √ó7', desc:'7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon:'üèÜ' }
    ];
    let unlocked = new Set();
    function renderAchievements(){ achGrid.innerHTML=''; ACH_DEFS.forEach(a=>{ const has=unlocked.has(a.id); const el=document.createElement('div'); el.className='ach'+(has?'':' locked'); el.innerHTML=`<div class="badge">${a.icon}</div><div style="font-size:12px;font-weight:700;">${a.name}</div><div class="muted" style="font-size:11px;text-align:center">${a.desc}</div>`; achGrid.appendChild(el); }); }
    function subscribeAchievements(){ if (unsubAch) unsubAch(); const uid=auth.currentUser?.uid; if (!uid) return; unsubAch = onSnapshot(collection(db,'users',uid,'achievements'), (qs)=>{ unlocked = new Set(qs.docs.map(d=>d.id)); renderAchievements(); }); }
    async function recordAchievement(id,payload={}){ const uid=auth.currentUser?.uid; if (!uid || unlocked.has(id)) return; await setDoc(doc(db,'users',uid,'achievements',id), { id, unlockedAt: serverTimestamp(), ...payload }, { merge:true }); }
    function ymdShift(date,delta){ const dt=new Date(date); dt.setDate(dt.getDate()+delta); const y=dt.getFullYear(); const m=('0'+(dt.getMonth()+1)).slice(-2); const d=('0'+dt.getDate()).slice(-2); return `${y}-${m}-${d}`; }
    function onSnapshotOnce(ref){ return new Promise((resolve)=>{ const unsub=onSnapshot(ref,(snap)=>{ resolve(snap); unsub(); },{includeMetadataChanges:false}); }); }
    async function checkStreakAndAchievements(todayWater){
      const user=auth.currentUser; if(!user) return;
      const userRef = doc(db,'users',user.uid);
      const uSnap = await onSnapshotOnce(userRef); const u = uSnap.data()||{};
      const goal = typeof u.daily_goal_ml === 'number' ? u.daily_goal_ml : 3000;
      const todayStr = keysFor(new Date()).dateStr;
      const yesterdayStr = ymdShift(new Date(), -1);

      if (todayWater >= 1000) await recordAchievement('first_liter', { dateStr: todayStr });
      if (todayWater >= goal)  await recordAchievement('goal_today',  { dateStr: todayStr, goal_ml: goal });

      if (todayWater >= goal){
        const lastDone = u.streak_last_completed_dateStr;
        if (lastDone !== todayStr){
          const current = (lastDone === yesterdayStr) ? (u.streak_current||0)+1 : 1;
          const best = Math.max(u.streak_best||0, current);
          await setDoc(userRef, { streak_current: current, streak_best: best, streak_last_completed_dateStr: todayStr }, { merge:true });
          if (current >= 3) await recordAchievement('streak_3', { dateStr: todayStr, streak: current });
          if (current >= 7) await recordAchievement('streak_7', { dateStr: todayStr, streak: current });
        }
      }
    }

    /* ====== –ú–µ—Å—è—Ü –ø–æ –¥–Ω—è–º (—Ç–∞–±–ª–∏—Ü–∞) ====== */
    function liters(n_ml){ return (n_ml/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2}); }
    function goalPct(w, goalMl){ if (!goalMl) return '‚Äî'; return Math.round((w/goalMl)*100)+'%'; }

    async function fetchMonthRowsSafe(uid, year, monthIndex){
      const monthStr = year + '-' + String(monthIndex+1).padStart(2,'0');
      const daysInMonth = new Date(year, monthIndex+1, 0).getDate();
      const rows = Array.from({length:daysInMonth}, (_,i)=>({
        day:i+1, dateStr: `${monthStr}-${String(i+1).padStart(2,'0')}`, total_water_ml:0, total_ml:0
      }));

      try{
        const startStr = `${monthStr}-01`;
        const endStr   = `${monthStr}-31`;
        const cg = query(
          collectionGroup(db, 'users'),
          where('uid','==', uid),
          where('dateStr','>=', startStr),
          where('dateStr','<=', endStr),
          orderBy('dateStr','asc')
        );
        const snap = await getDocs(cg);
        snap.forEach(d=>{
          const x = d.data();
          const ds = x.dateStr;
          const idx = parseInt(ds.slice(-2), 10) - 1;
          if (idx>=0 && idx<rows.length){
            rows[idx].total_water_ml = Math.max(0, x.total_water_ml||0);
            rows[idx].total_ml = Math.max(0, x.total_ml||0);
          }
        });
        return rows;
      } catch(err){
        const promises = rows.map(async (r)=>{
          const ref = doc(db,'daily_totals', r.dateStr, 'users', uid);
          const ds  = await getDoc(ref);
          if (ds.exists()){
            const x = ds.data();
            r.total_water_ml = Math.max(0, x.total_water_ml||0);
            r.total_ml       = Math.max(0, x.total_ml||0);
          }
          return r;
        });
        return Promise.all(promises);
      }
    }

    openMonthDailyBtn.addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user) return;
      const now = new Date();
      const rows = await fetchMonthRowsSafe(user.uid, now.getFullYear(), now.getMonth());

      let sumW=0, sumT=0;
      monthTableBody.innerHTML = rows.map(r=>{
        sumW += r.total_water_ml; sumT += r.total_ml;
        return `<tr>
          <td>${new Date(r.dateStr).toLocaleDateString(undefined,{day:'2-digit', month:'short', weekday:'short'})}</td>
          <td>${liters(r.total_water_ml)}</td>
          <td>${liters(r.total_ml)}</td>
          <td>${goalPct(r.total_water_ml, currentGoalMl)}</td>
        </tr>`;
      }).join('');
      sumWaterEl.textContent = liters(sumW);
      sumTotalEl.textContent = liters(sumT);
      sumShareEl.textContent = '‚Äî'; // —Å—É–º–º–∞—Ä–Ω—ã–π % –∫ —Ü–µ–ª–∏ –Ω–µ —Å—á–∏—Ç–∞–µ–º

      monthTitle.textContent = '–ú–µ—Å—è—Ü –ø–æ –¥–Ω—è–º';
      monthSubTitle.textContent = new Date(now.getFullYear(), now.getMonth(), 1).toLocaleDateString(undefined,{month:'long', year:'numeric'});
      monthModal.style.display = 'flex';
    });

    monthCloseBtn.addEventListener('click', ()=>{ monthModal.style.display='none'; });
    monthModal.addEventListener('click', (e)=>{ if (e.target === monthModal) monthModal.style.display='none'; });
  </script>
</body>
</html>
