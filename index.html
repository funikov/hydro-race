<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞ ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ø–æ –≤–æ–¥–µ</title>
  
  <!--
  ==========================
  –í–ê–ñ–ù–û: –ö–ê–ö –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–û–ï–ö–¢
  ==========================
  1) –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ Firebase: https://console.firebase.google.com
  2) –í–∫–ª—é—á–∏—Ç–µ Authentication ‚Üí Sign-in method ‚Üí Google.
  3) –í–∫–ª—é—á–∏—Ç–µ Firestore (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Production mode).
  4) –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –≤–µ–±‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Firebase (Project settings ‚Üí Your apps ‚Üí Web app)
     –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –æ–±—ä–µ–∫—Ç firebaseConfig –Ω–∏–∂–µ (–∑–∞–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ YOUR_...).
  5) –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Firestore (–ø—Ä–∏–º–µ—Ä –Ω–∏–∂–µ).
  6) –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª index.html –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ —Ä–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ Firebase Hosting / –ª—é–±–æ–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ö–æ—Å—Ç–∏–Ω–≥.

  --------------------------
  –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª Firestore (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ Firestore Rules):

  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function signedIn() { return request.auth != null; }

      // –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      match /users/{uid} {
        allow read: if signedIn();
        allow write: if signedIn() && request.auth.uid == uid;
      }

      // –°—ã—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤–æ–¥—ã (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏ –æ—Ç–º–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è)
      match /intakes/{intakeId} {
        allow read: if signedIn();
        allow create: if signedIn() && request.resource.data.uid == request.auth.uid;
        allow update, delete: if signedIn() && resource.data.uid == request.auth.uid;
      }

      // –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç.–∫. UID –≤ –ø—É—Ç–∏
      match /daily_totals/{dateStr}/users/{uid} {
        allow read: if true; // –ø—É–±–ª–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
        allow write: if signedIn() && request.auth.uid == uid;
      }
      match /monthly_totals/{monthStr}/users/{uid} {
        allow read: if true;
        allow write: if signedIn() && request.auth.uid == uid;
      }
      match /yearly_totals/{yearStr}/users/{uid} {
        allow read: if true;
        allow write: if signedIn() && request.auth.uid == uid;
      }
    }
  }

  --------------------------
  –ò–Ω–¥–µ–∫—Å—ã Firestore: –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ –Ω–µ –Ω—É–∂–Ω—ã, —Ç.–∫. —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–¥—ë—Ç –ø–æ –ø–æ–ª—é –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö where.
  -->

  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --panel: #111827;       /* gray-900 */
      --muted: #94a3b8;       /* slate-400 */
      --text: #e5e7eb;        /* gray-200 */
      --brand: #22d3ee;       /* cyan-400 */
      --accent: #60a5fa;      /* blue-400 */
      --card: #0b1220;        /* custom dark */
      --good: #34d399;        /* emerald-400 */
      --warn: #f59e0b;        /* amber-500 */
      --danger: #f87171;      /* red-400 */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1020 0%, #0f172a 100%);
      color: var(--text); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      gap: 16px; padding: 14px 18px; background: rgba(15, 23, 42, .7); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148,163,184,.12);
    }
    .brand { display: flex; gap: 10px; align-items: center; }
    .drop { width: 28px; height: 28px; border-radius: 8px; background: radial-gradient(circle at 30% 25%, #7dd3fc, #22d3ee 60%, #60a5fa);
            box-shadow: inset 0 0 10px rgba(255,255,255,.2), 0 8px 18px rgba(34,211,238,.3);
          }
    .title { font-weight: 700; letter-spacing: .2px; }
    .subtitle { font-size: 12px; color: var(--muted); }

    .row { display: flex; gap: 12px; align-items: center; }
    .spacer { flex: 1; }

    .btn { border: 0; color: #0b1020; background: var(--brand); padding: 10px 14px; border-radius: 999px; cursor: pointer; font-weight: 700; }
    .btn:hover { filter: brightness(1.05); }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid rgba(148,163,184,.3); }

    main { max-width: 1100px; margin: 18px auto; padding: 0 16px; }

    .grid { display: grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    @media (max-width: 960px){ .grid { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(180deg, rgba(96,165,250,.10), rgba(34,211,238,.06)); border: 1px solid rgba(148,163,184,.16);
            border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; }

    h2 { margin: 0 0 10px 0; font-size: 20px; }

    .stat { display: flex; align-items: baseline; gap: 10px; }
    .stat .big { font-size: 42px; font-weight: 800; letter-spacing: .3px; }
    .stat .unit { color: var(--muted); }

    .chipbar { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0 10px; }
    .chip { border: 1px dashed rgba(148,163,184,.35); color: var(--text); background: rgba(2,6,23,.35); padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    .chip:hover { border-style: solid; }

    .custom-add { display: flex; gap: 10px; align-items: center; }
    .custom-add input { width: 120px; background: #0a0f1d; color: var(--text); border: 1px solid rgba(148,163,184,.28); border-radius: 10px; padding: 8px 10px; }

    .tabs { display: flex; gap: 6px; border-bottom: 1px solid rgba(148,163,184,.16); margin-bottom: 10px; }
    .tab { background: transparent; color: var(--text); border: 0; padding: 10px 14px; cursor: pointer; }
    .tab.active { color: var(--brand); border-bottom: 2px solid var(--brand); font-weight: 700; }

    .lb-list { display: grid; gap: 10px; }
    .lb-item { display: grid; grid-template-columns: 32px 1fr auto; gap: 12px; align-items: center; background: var(--card); border-radius: 14px; padding: 10px 12px; border: 1px solid rgba(148,163,184,.12); }
    .avatar { width: 32px; height: 32px; border-radius: 50%; background: #0a0f1d; overflow: hidden; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .name { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .amt { font-weight: 800; }

    .muted { color: var(--muted); }
    .hidden { display: none !important; }
    .success { color: var(--good); font-weight: 700; }
    .hint { font-size: 13px; color: var(--muted); }

    footer { margin: 26px auto 60px; max-width: 1100px; padding: 0 16px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="drop" aria-hidden="true"></div>
      <div>
        <div class="title">–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞</div>
        <div class="subtitle">–ö—Ç–æ –≤—ã–ø—å–µ—Ç –±–æ–ª—å—à–µ –≤–æ–¥—ã —Å–µ–≥–æ–¥–Ω—è? üíß</div>
      </div>
    </div>

    <div class="row" id="authRow">
      <div class="row hidden" id="userInfo">
        <div class="avatar" id="userAvatar"></div>
        <div class="name" id="userName"></div>
      </div>
      <button class="btn" id="signInBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      <button class="btn secondary hidden" id="signOutBtn">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <main id="app" class="hidden">
    <div class="grid">
      <section class="card" aria-labelledby="myDayTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="myDayTitle">–ú–æ–π –¥–µ–Ω—å</h2>
          <div class="muted" id="todayLabel"></div>
        </div>

        <div class="stat" aria-live="polite">
          <div class="big" id="myTotalLiters">0,0</div>
          <div class="unit">–ª–∏—Ç—Ä–∞</div>
        </div>
        <div class="hint" id="lastAction"></div>

        <div class="chipbar" aria-label="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å">
          <button class="chip" data-add="250">+ —Å—Ç–∞–∫–∞–Ω (250 –º–ª)</button>
          <button class="chip" data-add="500">+ –±—É—Ç—ã–ª–∫–∞ 0,5 –ª</button>
          <button class="chip" data-add="1500">+ –±—É—Ç—ã–ª–∫–∞ 1,5 –ª</button>
        </div>

        <div class="custom-add">
          <input id="customInput" type="number" min="1" step="1" placeholder="–î—Ä—É–≥–æ–µ, –º–ª" />
          <button class="btn" id="addCustomBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn secondary" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, -250).</div>
      </section>

      <section class="card" aria-labelledby="lbTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="lbTitle">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
          <div class="muted" id="periodLabel"></div>
        </div>
        <div class="tabs" role="tablist">
          <button class="tab active" data-scope="day" role="tab" aria-selected="true">–î–µ–Ω—å</button>
          <button class="tab" data-scope="month" role="tab" aria-selected="false">–ú–µ—Å—è—Ü</button>
          <button class="tab" data-scope="year" role="tab" aria-selected="false">–ì–æ–¥</button>
        </div>
        <div class="lb-list" id="lbList" aria-live="polite"></div>
        <div class="hint">–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –ü–µ–π—Ç–µ –≤–æ–¥—É –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –¥—Ä—É–∑–µ–π!</div>
      </section>
    </div>
  </main>

  <footer>
    –°–¥–µ–ª–∞–Ω–æ –Ω–∞ Firebase. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ. –ö–æ–¥ ‚Äî –æ–¥–∏–Ω —Ñ–∞–π–ª, –≥–æ—Ç–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è.
  </footer>

  <template id="lbRowTpl">
    <div class="lb-item">
      <div class="muted rank"></div>
      <div class="row" style="gap:10px; overflow:hidden;">
        <div class="avatar av"></div>
        <div class="name nm"></div>
      </div>
      <div class="amt am"></div>
    </div>
  </template>

  <script type="module">
    // ===== Firebase SDK (modular) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import {
      getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection, addDoc,
      onSnapshot, orderBy, limit, query, getDocs, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // ===== –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ö–û–ù–§–ò–ì –°–Æ–î–ê =====
    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8z2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç
    setPersistence(auth, browserLocalPersistence).catch(console.warn);
    getRedirectResult(auth).catch(() => {});
    const db = getFirestore(app);

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∏–ø –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (local ‚Üí session ‚Üí inMemory)
    (async () => {
      try { await setPersistence(auth, browserLocalPersistence); }
      catch (e1) {
        try { await setPersistence(auth, browserSessionPersistence); }
        catch (e2) { await setPersistence(auth, inMemoryPersistence); }
      }
      try {
        const redirectResult = await getRedirectResult(auth);
        if (redirectResult?.user) {
          console.log('Signed in via redirect:', redirectResult.user.uid);
        }
      } catch (e) { console.warn('Redirect handling issue', e); }
    })();

    // –•–µ–ª–ø–µ—Ä—ã —Å—Ä–µ–¥—ã
    function isMobile(){ return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent); }
    function isStoragePartitioned(){
      try {
        const k='__fb_test__'; sessionStorage.setItem(k,'1'); sessionStorage.removeItem(k); return false;
      } catch { return true; }
    }

    // ===== –£–¢–ò–õ–ò–¢–´ –î–ê–¢–´/–ö–õ–Æ–ß–ï–ô =====
    const pad = (n) => String(n).padStart(2, '0');
    function keysFor(date = new Date()) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Ç–∞–π–º–∑–æ–Ω—É –±—Ä–∞—É–∑–µ—Ä–∞ ‚Äî —Ç–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏–≤—ã—á–Ω–µ–µ.
      const y = date.getFullYear();
      const m = pad(date.getMonth() + 1);
      const d = pad(date.getDate());
      return {
        dateStr: `${y}-${m}-${d}`,
        monthStr: `${y}-${m}`,
        yearStr: `${y}`,
      };
    }
    function formatHuman(date = new Date()) {
      return date.toLocaleDateString(undefined, { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
    }

    // ===== UI –≠–õ–ï–ú–ï–ù–¢–´ =====
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const appEl = document.getElementById('app');

    const lastActionEl = document.getElementById('lastAction');
    const myTotalLitersEl = document.getElementById('myTotalLiters');
    const todayLabelEl = document.getElementById('todayLabel');

    const lbListEl = document.getElementById('lbList');
    const periodLabelEl = document.getElementById('periodLabel');

    const addChips = Array.from(document.querySelectorAll('[data-add]'));
    const customInput = document.getElementById('customInput');
    const addCustomBtn = document.getElementById('addCustomBtn');
    const undoBtn = document.getElementById('undoBtn');
    const tabs = Array.from(document.querySelectorAll('.tab'));

    todayLabelEl.textContent = `–°–µ–≥–æ–¥–Ω—è: ${formatHuman(new Date())}`;

    // ===== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è =====
    signInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });

      if (window.location.protocol === 'file:') {
        alert('–î–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ http/https (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Firebase Hosting). –í—Ö–æ–¥ —á–µ—Ä–µ–∑ file:// –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.');
        return;
      }

      try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º popup; –µ—Å–ª–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ‚Äî –ø–µ—Ä–µ–π–¥—ë–º –Ω–∞ redirect
        await signInWithPopup(auth, provider);
      } catch (e) {
        if (e && (e.code === 'auth/operation-not-supported-in-this-environment' || e.code === 'auth/popup-blocked')) {
          await signInWithRedirect(auth, provider);
          return;
        }
        console.error(e);
        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (e && e.message ? e.message : e));
      }
    });
      // –í —Å—Ä–µ–¥–∞—Ö, –≥–¥–µ popup –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (iOS Safari, –∏–Ω‚Äë–∞–ø–ø –±—Ä–∞—É–∑–µ—Ä—ã), –∏—Å–ø–æ–ª—å–∑—É–µ–º redirect
      if (isMobile() || isStoragePartitioned()) {
        await signInWithRedirect(auth, provider);
        return;
      }
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        const code = e?.code || '';
        if (code === 'auth/operation-not-supported-in-this-environment' || code === 'auth/popup-blocked' || code === 'auth/popup-closed-by-user') {
          await signInWithRedirect(auth, provider);
        } else {
          alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (e?.message || e));
          console.error(e);
        }
      }
    });
    signOutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // –ü–æ–∫–∞–∑–∞—Ç—å UI
        appEl.classList.remove('hidden');
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        userInfoEl.classList.remove('hidden');
        userNameEl.textContent = user.displayName || user.email;
        userAvatarEl.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä" />` : '';

        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users
        await setDoc(doc(db, 'users', user.uid), {
          uid: user.uid,
          displayName: user.displayName || null,
          email: user.email || null,
          photoURL: user.photoURL || null,
          lastLoginAt: serverTimestamp(),
          createdAt: serverTimestamp(),
        }, { merge: true });

        // –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–æ–π –¥–Ω–µ–≤–Ω–æ–π –∏—Ç–æ–≥
        window.subscribeMyDailyTotal?.();
        // –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –¥–µ–Ω—å)
        window.activateTab?.('day');
      } else {
        appEl.classList.add('hidden');
        signInBtn.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        userInfoEl.classList.add('hidden');
        window.cleanupSubscriptions?.();
      }
    });

    // ===== –õ–û–ì–ò–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø / –û–¢–ú–ï–ù–´ =====
    addChips.forEach(btn => btn.addEventListener('click', () => window.addAmount(parseInt(btn.dataset.add, 10))));
    addCustomBtn.addEventListener('click', () => {
      const val = parseInt(customInput.value, 10);
      if (!Number.isFinite(val) || val === 0) { toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–ª (–Ω–µ 0)'); return; }
      window.addAmount(val);
      customInput.value = '';
    });
    undoBtn.addEventListener('click', window.undoLast);

    async function addAmount(ml) {
      const user = auth.currentUser; if (!user) return;
      const { dateStr, monthStr, yearStr } = keysFor(new Date());

      const batch = writeBatch(db);

      // –°—ã—Ä–æ–π intake (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã)
      const intakeRef = doc(collection(db, 'intakes'));
      batch.set(intakeRef, {
        uid: user.uid,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        ml: ml,
        ts: serverTimestamp(),
        dateStr, monthStr, yearStr,
      });

      // –ê—Ç–æ–º–∞—Ä–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–Ω–µ–≤–Ω—ã–µ/–º–µ—Å—è—á–Ω—ã–µ/–≥–æ–¥–æ–≤—ã–µ —Å—É–º–º—ã
      const dailyRef = doc(db, 'daily_totals', dateStr, 'users', user.uid);
      const monthlyRef = doc(db, 'monthly_totals', monthStr, 'users', user.uid);
      const yearlyRef = doc(db, 'yearly_totals', yearStr, 'users', user.uid);

      const base = {
        uid: user.uid,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        updatedAt: serverTimestamp(),
      };

      batch.set(dailyRef, { ...base, dateStr, total_ml: (self => self)(0) }, { merge: true });
      batch.set(monthlyRef, { ...base, monthStr, total_ml: (self => self)(0) }, { merge: true });
      batch.set(yearlyRef, { ...base, yearStr, total_ml: (self => self)(0) }, { merge: true });
      // Firestore –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç increment –≤–Ω—É—Ç—Ä–∏ set(..., merge:true) –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ —á–µ—Ä–µ–∑ –ø–æ–ª–µ,
      // –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ set —Å "FieldValue.increment" —á–µ—Ä–µ–∑ update-like —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:
      // –ù–æ –≤ –≤–µ–± v9 increment –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ firestore; –∑–¥–µ—Å—å –ø—Ä–æ—â–µ —Å–¥–µ–ª–∞—Ç—å –≤—Ç–æ—Ä–æ–π –±–∞—Ç—á.set —Å merge:true –∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º increment.

    }

    // –ù–∞–º –Ω—É–∂–µ–Ω increment ‚Äî –¥–æ–±–∞–≤–∏–º –∏–º–ø–æ—Ä—Ç –∏ –∑–∞–≤–µ—Ä—à–∏–º addAmount
  </script>

  <script type="module">
    import { getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ window.firebaseApp, —á—Ç–æ–±—ã –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å –ø—Ä–∏–º–µ—Ä
  </script>

  <script type="module">
    // –ß—Ç–æ–±—ã –Ω–µ –¥—Ä–æ–±–∏—Ç—å –∫–æ–¥, –∑–∞–≤–µ—Ä—à–∏–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∑–¥–µ—Å—å (–≤ —Ç–æ–º –∂–µ –º–æ–¥—É–ª–µ, —á—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª Firebase –≤—ã—à–µ)
    import { getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection, addDoc, onSnapshot, orderBy, limit, query, getDocs, deleteDoc, increment } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const db = getFirestore();
    const auth = getAuth();

    const lbListEl = document.getElementById('lbList');
    const lastActionEl = document.getElementById('lastAction');
    const myTotalLitersEl = document.getElementById('myTotalLiters');
    const periodLabelEl = document.getElementById('periodLabel');

    const tabs = Array.from(document.querySelectorAll('.tab'));
    tabs.forEach(t => t.addEventListener('click', () => activateTab(t.dataset.scope)));

    const pad = (n) => String(n).padStart(2, '0');
    function keysFor(date = new Date()) {
      const y = date.getFullYear();
      const m = pad(date.getMonth() + 1);
      const d = pad(date.getDate());
      return { dateStr: `${y}-${m}-${d}`, monthStr: `${y}-${m}`, yearStr: `${y}` };
    }
    function formatHuman(date = new Date()) {
      return date.toLocaleDateString(undefined, { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
    }

    let unsubMyDaily = null;
    let unsubLB = null;

    function cleanupSubscriptions(){
      if (unsubMyDaily) { unsubMyDaily(); unsubMyDaily = null; }
    window.cleanupSubscriptions = cleanupSubscriptions;
      if (unsubLB) { unsubLB(); unsubLB = null; }
    }

    window.subscribeMyDailyTotal = function subscribeMyDailyTotal(){
      if (unsubMyDaily) unsubMyDaily();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const ref = doc(db, 'daily_totals', dateStr, 'users', uid);
      unsubMyDaily = onSnapshot(ref, (snap) => {
        const total = snap.exists() ? (snap.data().total_ml || 0) : 0;
        myTotalLitersEl.textContent = (total / 1000).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 2 });
      });
    }

    window.activateTab = function activateTab(scope){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.scope === scope));
      if (unsubLB) { unsubLB(); unsubLB = null; }

      const now = new Date();
      const { dateStr, monthStr, yearStr } = keysFor(now);

      let colRef, label;
      if (scope === 'day') {
        colRef = collection(db, 'daily_totals', dateStr, 'users');
        label = `–°–µ–≥–æ–¥–Ω—è ‚Äî ${now.toLocaleDateString()}`;
      } else if (scope === 'month') {
        colRef = collection(db, 'monthly_totals', monthStr, 'users');
        label = `–ú–µ—Å—è—Ü ‚Äî ${now.toLocaleString(undefined, { month: 'long', year: 'numeric' })}`;
      } else {
        colRef = collection(db, 'yearly_totals', yearStr, 'users');
        label = `–ì–æ–¥ ‚Äî ${yearStr}`;
      }
      periodLabelEl.textContent = label;

      const q = query(colRef, orderBy('total_ml', 'desc'), limit(50));
      unsubLB = onSnapshot(q, (qs) => {
        renderLeaderboard(qs.docs.map(d => d.data()));
      });
    }

    function renderLeaderboard(items){
      lbListEl.innerHTML = '';
      if (!items.length) { lbListEl.innerHTML = '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üíß</div>'; return; }
      const tpl = document.getElementById('lbRowTpl');
      items.forEach((it, idx) => {
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.rank').textContent = idx + 1;
        const av = node.querySelector('.av');
        av.innerHTML = it.photoURL ? `<img src="${it.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä"/>` : '';
        node.querySelector('.nm').textContent = it.displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        node.querySelector('.am').textContent = `${(Math.max(0, it.total_ml || 0) / 1000).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 2 })} –ª`;
        lbListEl.appendChild(node);
      });
    }

    window.addAmount = async function addAmount(ml){
      const user = auth.currentUser; if (!user) return;
      const now = new Date();
      const { dateStr, monthStr, yearStr } = keysFor(now);

      const batch = writeBatch(db);
      const intakeRef = doc(collection(db, 'intakes'));
      batch.set(intakeRef, {
        uid: user.uid,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        ml: ml,
        ts: serverTimestamp(),
        dateStr, monthStr, yearStr,
      });

      const base = { uid: user.uid, displayName: user.displayName || null, photoURL: user.photoURL || null, updatedAt: serverTimestamp() };
      const dailyRef = doc(db, 'daily_totals', dateStr, 'users', user.uid);
      const monthlyRef = doc(db, 'monthly_totals', monthStr, 'users', user.uid);
      const yearlyRef = doc(db, 'yearly_totals', yearStr, 'users', user.uid);

      batch.set(dailyRef, { ...base, dateStr, total_ml: increment(ml) }, { merge: true });
      batch.set(monthlyRef, { ...base, monthStr, total_ml: increment(ml) }, { merge: true });
      batch.set(yearlyRef, { ...base, yearStr, total_ml: increment(ml) }, { merge: true });

      await batch.commit();
      const sign = ml > 0 ? '+' : '';
      toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${sign}${ml} –º–ª`);
    }

    window.undoLast = async function undoLast(){
      const user = auth.currentUser; if (!user) return;
      const { dateStr } = keysFor(new Date());
      // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const col = collection(db, 'intakes');
      const qs = await getDocs(query(col, orderBy('ts', 'desc'), limit(50))); // –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 50 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–µ–∫—Ç–∞
      const mine = qs.docs.find(d => d.data().uid === user.uid && d.data().dateStr === dateStr);
      if (!mine) { toast('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è'); return; }
      const data = mine.data();

      const batch = writeBatch(db);
      batch.delete(mine.ref);

      const { monthStr, yearStr, ml } = data;
      const dailyRef = doc(db, 'daily_totals', dateStr, 'users', user.uid);
      const monthlyRef = doc(db, 'monthly_totals', monthStr, 'users', user.uid);
      const yearlyRef = doc(db, 'yearly_totals', yearStr, 'users', user.uid);

      batch.set(dailyRef, { total_ml: increment(-ml), updatedAt: serverTimestamp() }, { merge: true });
      batch.set(monthlyRef, { total_ml: increment(-ml), updatedAt: serverTimestamp() }, { merge: true });
      batch.set(yearlyRef, { total_ml: increment(-ml), updatedAt: serverTimestamp() }, { merge: true });

      await batch.commit();
      toast('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
    }

    // ===== –¢–æ—Å—Ç-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è =====
    let toastTimer = null;
    function toast(msg){
      lastActionEl.textContent = msg;
      lastActionEl.classList.add('success');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { lastActionEl.textContent = ''; lastActionEl.classList.remove('success'); }, 2500);
    }
  </script>
</body>
</html>
