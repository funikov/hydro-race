<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞ ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ø–æ –≤–æ–¥–µ</title>
  <!--
  –ß—Ç–æ –Ω–æ–≤–æ–≥–æ:
  - –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä –Ω–∞–ø–∏—Ç–∫–∞ –∏ –ø–µ—Ä–µ—Å—á—ë—Ç –≤ "–≤–æ–¥–∞-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç" (hydration factor).
  - –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –∏ –≥–ª–∞–≤–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ —Ç–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞—é—Ç –∏–º–µ–Ω–Ω–æ –≤–æ–¥—É-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç (–Ω–æ —Ç–∞–∫–∂–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ–±—â–∏–π –æ–±—ä—ë–º –Ω–∞–ø–∏—Ç–∫–æ–≤).

  –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Firebase:
  1) Authentication ‚Üí Google (–≤–∫–ª—é—á–∏—Ç—å). Authorized domains: –¥–æ–±–∞–≤—å—Ç–µ funikov.github.io (–∏–ª–∏ —Å–≤–æ–π –¥–æ–º–µ–Ω).
  2) Firestore (Production mode). –ü—Ä–∞–≤–∏–ª–∞ ‚Äî –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ (–ø–æ–¥–æ–π–¥—É—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π; –Ω–æ–≤—ã–µ –ø–æ–ª—è –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—è—Ç—Å—è).
  -->
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#22d3ee; --card:#0b1220; --good:#34d399; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;background:linear-gradient(180deg,#0b1020 0%,#0f172a 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 18px;background:rgba(15,23,42,.7);backdrop-filter:blur(10px);border-bottom:1px solid rgba(148,163,184,.12)}
    .brand{display:flex;gap:10px;align-items:center}.drop{width:28px;height:28px;border-radius:8px;background:radial-gradient(circle at 30% 25%,#7dd3fc,#22d3ee 60%,#60a5fa);box-shadow:inset 0 0 10px rgba(255,255,255,.2),0 8px 18px rgba(34,211,238,.3)}
    .title{font-weight:700}.subtitle{font-size:12px;color:var(--muted)} .row{display:flex;gap:12px;align-items:center}
    .btn{border:0;color:#0b1020;background:var(--brand);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(148,163,184,.3)}
    main{max-width:1100px;margin:18px auto;padding:0 16px} .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px} @media(max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(96,165,250,.10),rgba(34,211,238,.06));border:1px solid rgba(148,163,184,.16);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    h2{margin:0 0 10px 0;font-size:20px} .muted{color:var(--muted)} .hidden{display:none!important} .success{color:var(--good);font-weight:700}
    .stat{display:flex;align-items:baseline;gap:10px}.stat .big{font-size:42px;font-weight:800}
    .chipbar{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 10px}.chip{border:1px dashed rgba(148,163,184,.35);background:rgba(2,6,23,.35);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .custom-add{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select, input[type=number]{background:#0a0f1d;color:var(--text);border:1px solid rgba(148,163,184,.28);border-radius:10px;padding:8px 10px}
    .tabs{display:flex;gap:6px;border-bottom:1px solid rgba(148,163,184,.16);margin-bottom:10px}
    .tab{background:transparent;color:var(--text);border:0;padding:10px 14px;cursor:pointer}.tab.active{color:var(--brand);border-bottom:2px solid var(--brand);font-weight:700}
    .lb-list{display:grid;gap:10px}.lb-item{display:grid;grid-template-columns:32px 1fr auto;gap:12px;align-items:center;background:var(--card);border-radius:14px;padding:10px 12px;border:1px solid rgba(148,163,184,.12)}
    .avatar{width:32px;height:32px;border-radius:50%;background:#0a0f1d;overflow:hidden}.avatar img{width:100%;height:100%;object-fit:cover;display:block}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="drop" aria-hidden="true"></div>
      <div>
        <div class="title">–í–æ–¥–Ω–∞—è –±–∏—Ç–≤–∞</div>
        <div class="subtitle">–°—á–∏—Ç–∞–µ–º –≤–æ–¥—É-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç üíß</div>
      </div>
    </div>

    <div class="row" id="authRow">
      <div class="row hidden" id="userInfo">
        <div class="avatar" id="userAvatar"></div>
        <div class="name" id="userName"></div>
      </div>
      <button class="btn" id="signInBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      <button class="btn secondary hidden" id="signOutBtn">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <main id="app" class="hidden">
    <div class="grid">
      <section class="card" aria-labelledby="myDayTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="myDayTitle">–ú–æ–π –¥–µ–Ω—å</h2>
          <div class="muted" id="todayLabel"></div>
        </div>

        <div class="custom-add" style="margin: 6px 0 10px;">
          <label for="beverage" class="muted">–ù–∞–ø–∏—Ç–æ–∫:</label>
          <select id="beverage"></select>
        </div>

        <div class="stat" aria-live="polite">
          <div class="big" id="myTotalWaterLiters">0,0</div>
          <div class="unit">–ª –≤–æ–¥—ã-—ç–∫–≤.</div>
        </div>
        <div class="muted" id="myRawTotal" style="margin-top:4px">–í—Å–µ–≥–æ –Ω–∞–ø–∏—Ç–∫–æ–≤: 0,0 –ª</div>
        <div class="muted" id="factorHint" style="margin-top:4px"></div>
        <div class="hint" id="lastAction" style="margin-top:6px"></div>

        <div class="chipbar" aria-label="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å">
          <button class="chip" data-add="250">+ —Å—Ç–∞–∫–∞–Ω (250 –º–ª)</button>
          <button class="chip" data-add="500">+ –±—É—Ç—ã–ª–∫–∞ 0,5 –ª</button>
          <button class="chip" data-add="1500">+ –±—É—Ç—ã–ª–∫–∞ 1,5 –ª</button>
        </div>

        <div class="custom-add">
          <input id="customInput" type="number" min="1" step="1" placeholder="–î—Ä—É–≥–æ–µ, –º–ª" />
          <button class="btn" id="addCustomBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn secondary" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="muted" style="margin-top:6px">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, -250) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.</div>
      </section>

      <section class="card" aria-labelledby="lbTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="lbTitle">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ (–≤–æ–¥–∞-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç)</h2>
          <div class="muted" id="periodLabel"></div>
        </div>
        <div class="tabs" role="tablist">
          <button class="tab active" data-scope="day" role="tab" aria-selected="true">–î–µ–Ω—å</button>
          <button class="tab" data-scope="month" role="tab" aria-selected="false">–ú–µ—Å—è—Ü</button>
          <button class="tab" data-scope="year" role="tab" aria-selected="false">–ì–æ–¥</button>
        </div>
        <div class="lb-list" id="lbList" aria-live="polite"></div>
        <div class="muted" style="margin-top:6px">–†–µ–π—Ç–∏–Ω–≥ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ –≤–æ–¥–µ-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—É; –æ–±—â–∏–π –æ–±—ä—ë–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.</div>
      </section>
    </div>
  </main>

  <footer>–û–¥–∏–Ω HTML‚Äë—Ñ–∞–π–ª –Ω–∞ Firebase + Firestore. –ù–∞–ø–∏—Ç–∫–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ (–≤–æ–¥—ã-—ç–∫–≤.).</footer>

  <template id="lbRowTpl">
    <div class="lb-item">
      <div class="muted rank"></div>
      <div class="row" style="gap:10px; overflow:hidden;">
        <div class="avatar av"></div>
        <div class="name nm"></div>
      </div>
      <div class="amt am"></div>
    </div>
  </template>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection, onSnapshot, orderBy, limit, query, getDocs, increment } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // === –ö–æ–Ω—Ñ–∏–≥ Firebase (—Ç–≤–æ–π)
    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8z2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    setPersistence(auth, browserLocalPersistence).catch(console.warn);
    getRedirectResult(auth).catch(() => {});

    // === –ù–∞–ø–∏—Ç–∫–∏ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (–º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø—Ä–∞–≤–∏—Ç—å)
    const BEVERAGES = [
      { key:'water',    name:'–í–æ–¥–∞',                 factor: 1.00 },
      { key:'tea',      name:'–ß–∞–π',                  factor: 0.98 },
      { key:'coffee',   name:'–ö–æ—Ñ–µ',                 factor: 0.90 },
      { key:'milk',     name:'–ú–æ–ª–æ–∫–æ',               factor: 0.87 },
      { key:'cola_zero',name:'–ö–æ–ª–∞ –ª–∞–π—Ç/–±–µ–∑ —Å–∞—Ö–∞—Ä–∞', factor: 0.95 },
      { key:'kvass',    name:'–ö–≤–∞—Å',                 factor: 0.92 },
      { key:'juice',    name:'–°–æ–∫–∏',                 factor: 0.90 },
      { key:'lemonade', name:'–õ–∏–º–æ–Ω–∞–¥—ã',             factor: 0.90 },
    ];

    // === –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfoEl = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const appEl = document.getElementById('app');

    const todayLabelEl = document.getElementById('todayLabel');
    const beverageSel = document.getElementById('beverage');
    const factorHintEl = document.getElementById('factorHint');

    const myTotalWaterLitersEl = document.getElementById('myTotalWaterLiters');
    const myRawTotalEl = document.getElementById('myRawTotal');
    const lastActionEl = document.getElementById('lastAction');

    const addChips = Array.from(document.querySelectorAll('[data-add]'));
    const customInput = document.getElementById('customInput');
    const addCustomBtn = document.getElementById('addCustomBtn');
    const undoBtn = document.getElementById('undoBtn');

    const lbListEl = document.getElementById('lbList');
    const periodLabelEl = document.getElementById('periodLabel');
    const tabs = Array.from(document.querySelectorAll('.tab'));

    todayLabelEl.textContent = `–°–µ–≥–æ–¥–Ω—è: ${new Date().toLocaleDateString(undefined, { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' })}`;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –Ω–∞–ø–∏—Ç–∫–æ–≤
    BEVERAGES.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b.key; opt.textContent = b.name + ` (√ó${b.factor})`;
      beverageSel.appendChild(opt);
    });
    beverageSel.value = 'water';
    updateFactorHint();
    beverageSel.addEventListener('change', updateFactorHint);
    function updateFactorHint(){
      const bev = BEVERAGES.find(b => b.key === beverageSel.value);
      factorHintEl.textContent = `–°–µ–π—á–∞—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–º–Ω–æ–∂–∞—é—Ç—Å—è –Ω–∞ √ó${bev.factor} –¥–ª—è –≤–æ–¥—ã-—ç–∫–≤.`;
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    signInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      try { await signInWithPopup(auth, provider); }
      catch (e){ if (e?.code === 'auth/operation-not-supported-in-this-environment' || e?.code === 'auth/popup-blocked') { await signInWithRedirect(auth, provider); } else { alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+(e?.message||e)); } }
    });
    signOutBtn.addEventListener('click', async () => { await signOut(auth); });

    let unsubMyDaily = null; let unsubLB = null;
    const cleanupSubscriptions = () => { if (unsubMyDaily) { unsubMyDaily(); unsubMyDaily=null; } if (unsubLB) { unsubLB(); unsubLB=null; } };

    const pad = (n)=>String(n).padStart(2,'0');
    const keysFor = (date=new Date())=>({ dateStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`, monthStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}`, yearStr:`${date.getFullYear()}` });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        appEl.classList.remove('hidden');
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        userInfoEl.classList.remove('hidden');
        userNameEl.textContent = user.displayName || user.email;
        userAvatarEl.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä"/>` : '';
        await setDoc(doc(db, 'users', user.uid), { uid:user.uid, displayName:user.displayName||null, email:user.email||null, photoURL:user.photoURL||null, lastLoginAt:serverTimestamp(), createdAt:serverTimestamp() }, { merge:true });
        subscribeMyDailyTotal();
        activateTab('day');
      } else {
        appEl.classList.add('hidden');
        signInBtn.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        userInfoEl.classList.add('hidden');
        cleanupSubscriptions();
      }
    });

    // –î–µ–π—Å—Ç–≤–∏—è
    addChips.forEach(btn => btn.addEventListener('click', () => addAmount(parseInt(btn.dataset.add, 10))));
    addCustomBtn.addEventListener('click', () => { const v = parseInt(customInput.value, 10); if (!Number.isFinite(v) || v === 0) { toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–ª (–Ω–µ 0)'); return; } addAmount(v); customInput.value=''; });
    undoBtn.addEventListener('click', undoLast);

    function toast(msg){ lastActionEl.textContent = msg; lastActionEl.classList.add('success'); setTimeout(()=>{ lastActionEl.textContent=''; lastActionEl.classList.remove('success'); }, 2500); }

    function subscribeMyDailyTotal(){
      if (unsubMyDaily) unsubMyDaily();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const ref = doc(db, 'daily_totals', dateStr, 'users', uid);
      unsubMyDaily = onSnapshot(ref, (snap) => {
        const d = snap.exists() ? snap.data() : { total_water_ml:0, total_ml:0 };
        const water = d.total_water_ml || 0; const raw = d.total_ml || 0;
        myTotalWaterLitersEl.textContent = (water/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2});
        myRawTotalEl.textContent = `–í—Å–µ–≥–æ –Ω–∞–ø–∏—Ç–∫–æ–≤: ${(raw/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} –ª`;
      });
    }

    function activateTab(scope){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.scope === scope));
      if (unsubLB) { unsubLB(); unsubLB=null; }
      const now = new Date();
      const { dateStr, monthStr, yearStr } = keysFor(now);
      let colRef, label;
      if (scope === 'day') { colRef = collection(db, 'daily_totals', dateStr, 'users'); label = `–°–µ–≥–æ–¥–Ω—è ‚Äî ${now.toLocaleDateString()}`; }
      else if (scope === 'month') { colRef = collection(db, 'monthly_totals', monthStr, 'users'); label = `–ú–µ—Å—è—Ü ‚Äî ${now.toLocaleString(undefined,{month:'long', year:'numeric'})}`; }
      else { colRef = collection(db, 'yearly_totals', yearStr, 'users'); label = `–ì–æ–¥ ‚Äî ${yearStr}`; }
      periodLabelEl.textContent = label;
      const q = query(colRef, orderBy('total_water_ml','desc'), limit(50));
      unsubLB = onSnapshot(q, (qs) => renderLeaderboard(qs.docs.map(d=>d.data())));
    }

    function renderLeaderboard(items){
      lbListEl.innerHTML='';
      if (!items.length){ lbListEl.innerHTML = '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üíß</div>'; return; }
      const tpl = document.getElementById('lbRowTpl');
      items.forEach((it, idx) => {
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.rank').textContent = idx+1;
        node.querySelector('.av').innerHTML = it.photoURL ? `<img src="${it.photoURL}" alt="–ê–≤–∞—Ç–∞—Ä"/>` : '';
        node.querySelector('.nm').textContent = it.displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        const w = Math.max(0, it.total_water_ml||0)/1000;
        node.querySelector('.am').textContent = `${w.toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} –ª –≤–æ–¥—ã-—ç–∫–≤.`;
        lbListEl.appendChild(node);
      });
    }

    async function addAmount(ml){
      const user = auth.currentUser; if (!user) return;
      const bev = BEVERAGES.find(b => b.key === beverageSel.value) || BEVERAGES[0];
      const water_ml = Math.round(ml * bev.factor);
      const now = new Date();
      const { dateStr, monthStr, yearStr } = keysFor(now);

      const batch = writeBatch(db);
      const intakeRef = doc(collection(db, 'intakes'));
      batch.set(intakeRef, { uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, ml, beverage:bev.key, beverage_name:bev.name, factor:bev.factor, water_ml, ts:serverTimestamp(), dateStr, monthStr, yearStr });

      const base = { uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, updatedAt:serverTimestamp() };
      batch.set(doc(db,'daily_totals',dateStr,'users',user.uid),   { ...base, dateStr,  total_ml: increment(ml),        total_water_ml: increment(water_ml) }, { merge:true });
      batch.set(doc(db,'monthly_totals',monthStr,'users',user.uid),{ ...base, monthStr, total_ml: increment(ml),        total_water_ml: increment(water_ml) }, { merge:true });
      batch.set(doc(db,'yearly_totals',yearStr,'users',user.uid), { ...base, yearStr,  total_ml: increment(ml),        total_water_ml: increment(water_ml) }, { merge:true });

      await batch.commit();
      toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${ml>0?'+':''}${ml} –º–ª (${bev.name} ‚Üí ${water_ml} –º–ª –≤–æ–¥—ã-—ç–∫–≤.)`);
    }

    async function undoLast(){
      const user = auth.currentUser; if (!user) return;
      const { dateStr } = keysFor(new Date());
      const col = collection(db, 'intakes');
      const qs = await getDocs(query(col, orderBy('ts','desc'), limit(50)));
      const mine = qs.docs.find(d => d.data().uid === user.uid && d.data().dateStr === dateStr);
      if (!mine) { toast('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è'); return; }
      const data = mine.data();
      const batch = writeBatch(db);
      batch.set(doc(db,'daily_totals',dateStr,'users',user.uid),   { total_ml: increment(-data.ml),        total_water_ml: increment(-(data.water_ml||Math.round(data.ml*(data.factor||1)))) , updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'monthly_totals',data.monthStr,'users',user.uid),{ total_ml: increment(-data.ml),        total_water_ml: increment(-(data.water_ml||Math.round(data.ml*(data.factor||1)))), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'yearly_totals',data.yearStr,'users',user.uid), { total_ml: increment(-data.ml),        total_water_ml: increment(-(data.water_ml||Math.round(data.ml*(data.factor||1)))), updatedAt:serverTimestamp() }, { merge:true });
      await batch.commit();
      toast('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
    }
  </script>
</body>
</html>
