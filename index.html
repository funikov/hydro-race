<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HydroRace üíß</title>

  <!-- Tailwind config -->
  <script>
    window.tailwind = {};
    window.tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
          boxShadow: { card: "0 10px 30px -10px rgba(2,6,23,0.25)" },
          colors: {
            brand: {50:"#ecfeff",100:"#cffafe",200:"#a5f3fc",300:"#67e8f9",400:"#22d3ee",500:"#06b6d4",600:"#0891b2",700:"#0e7490",800:"#155e75",900:"#164e63"}
          },
        },
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- prevent theme flash -->
  <script>
    (function() {
      const key = "hydro_theme";
      const saved = localStorage.getItem(key);
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const wantDark = saved ? saved === "dark" : prefersDark;
      if (wantDark) document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = wantDark ? "dark" : "light";
    })();
  </script>
  <style>
    html, body { height: 100%; }
    /* iOS safe-area helpers */
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 12px); }
    .safe-top { padding-top: calc(env(safe-area-inset-top) + 8px); }
  </style>
</head>

<body class="h-full font-sans antialiased bg-gradient-to-br from-brand-50 via-white to-brand-100 dark:from-slate-900 dark:via-slate-950 dark:to-black text-slate-900 dark:text-slate-100">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    // ====== Firebase init (—Ç–≤–æ–π –∫–æ–Ω—Ñ–∏–≥) ======
    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8z2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };
    if (!firebase.apps || firebase.apps.length === 0) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –û–î–ò–ù –†–ê–ó –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–Ω–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–ª–∏–∫–∞!)
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((e)=>{
      console.warn("setPersistence failed:", e);
      alert("setPersistence error: " + (e?.code || "") + " " + (e?.message || ""));
    });

    // –ó–∞–≤–µ—Ä—à–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π redirect-–≤—Ö–æ–¥ (–µ—Å–ª–∏ –±—ã–ª) + –ª–æ–≥ –æ—à–∏–±–æ–∫
    auth.getRedirectResult()
      .then((res) => {
        if (res && res.user) {
          console.log("Redirect sign-in success:", res.user.uid);
        }
      })
      .catch((err) => {
        console.warn("Firebase redirect error:", err);
        alert("Redirect error: " + (err?.code || "") + " ‚Äî " + (err?.message || ""));
      });

    // ====== Utils / constants ======
    const STORAGE_KEY_DRINKS = "hydro_drinks_cfg_v1";
    const THEME_KEY = "hydro_theme";

    const ML = { glass: 250, bottle05: 500, bottle15: 1500 };
    const fmtLiters = (ml) => (ml / 1000).toFixed(2).replace(/\.00$/, "") + " –ª";
    const fmtPct = (x) => Math.round(x * 100) + "%";
    const todayISO = (d = new Date()) => d.toISOString().slice(0, 10);
    const sameDay = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    const isSameMonth = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth();
    const isSameYear = (a,b) => a.getFullYear()===b.getFullYear();
    const tsToDate = (ts) => ts && typeof ts.toDate === "function" ? ts.toDate() : new Date(ts || Date.now());

    const DEFAULT_DRINKS = [
      { id:"water",       name:"–í–æ–¥–∞",            emoji:"üíß", waterFraction:1.00 },
      { id:"tea",         name:"–ß–∞–π",             emoji:"üçµ", waterFraction:0.99 },
      { id:"milk",        name:"–ú–æ–ª–æ–∫–æ",          emoji:"ü•õ", waterFraction:0.87 },
      { id:"cola_light",  name:"–ö–æ–ª–∞ –õ–∞–π—Ç",       emoji:"ü•§", waterFraction:0.99 },
      { id:"cola_zero",   name:"–ö–æ–ª–∞ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞", emoji:"ü•§", waterFraction:0.99 },
      { id:"kvass",       name:"–ö–≤–∞—Å",            emoji:"üç∫", waterFraction:0.96 },
      { id:"juice",       name:"–°–æ–∫",             emoji:"üßÉ", waterFraction:0.88 },
      { id:"lemonade",    name:"–õ–∏–º–æ–Ω–∞–¥",         emoji:"üçã", waterFraction:0.90 },
    ];

    function cx(...classes){ return classes.filter(Boolean).join(" "); }

    // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π? (Telegram/Instagram/Facebook/Gmail –∏ –¥—Ä.)
    function isInAppBrowser() {
      const ua = navigator.userAgent || "";
      const isFB = ua.includes("FBAN") || ua.includes("FBAV") || ua.includes("FB_IAB");
      const isIG = ua.includes("Instagram");
      const isLine = ua.includes("Line/");
      const isWeChat = ua.includes("MicroMessenger");
      const isTwitter = ua.includes("Twitter");
      const isTelegram = ua.includes("Telegram");
      const isGmail = ua.includes("GSA") || ua.includes("Gmail");
      const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
      return !isStandalone && (isFB || isIG || isLine || isWeChat || isTwitter || isTelegram || isGmail);
    }
    function openInExternalBrowser() {
      // –í IAB —ç—Ç–æ –∑–∞—á–∞—Å—Ç—É—é –æ—Ç–∫—Ä–æ–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π ¬´Open in‚Ä¶¬ª
      window.location.href = window.location.href;
    }

    // ====== Hooks ======
    function useTheme(){
      const [theme, setTheme] = React.useState(()=>{
        const saved = localStorage.getItem(THEME_KEY);
        return saved || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      });
      React.useEffect(()=>{
        const root = document.documentElement;
        if(theme === "dark"){ root.classList.add("dark"); }
        else { root.classList.remove("dark"); }
        root.style.colorScheme = theme;
        localStorage.setItem(THEME_KEY, theme);
      }, [theme]);
      return { theme, setTheme };
    }

    // useAuth: –ë–ï–ó await –ø–µ—Ä–µ–¥ popup! (–≤–∞–∂–Ω–æ –¥–ª—è "user gesture")
    function useAuth() {
      const [user, setUser] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        return auth.onAuthStateChanged((u) => {
          setUser(u);
          setLoading(false);
        });
      }, []);

      async function signInGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });
        try {
          await auth.signInWithRedirect(provider);
        } catch (err) {
          console.warn("Redirect sign-in error:", err);
          alert("Redirect sign-in error: " + (err?.code || "") + " ‚Äî " + (err?.message || ""));
        }
      }

      function signInAnon() {
        return auth.signInAnonymously().catch((err)=>{
          console.warn("Anon sign-in error:", err);
          alert("Anon sign-in error: " + (err?.code || "") + " ‚Äî " + (err?.message || ""));
        });
      }

      function signOut() { return auth.signOut(); }

      return { user, loading, signInGoogle, signInAnon, signOut };
    }

    function useDrinksConfig(){
      const [drinks, setDrinks] = React.useState(()=>{
        const saved = localStorage.getItem(STORAGE_KEY_DRINKS);
        if(saved){ try { const d = JSON.parse(saved); if(Array.isArray(d) && d.length) return d; } catch {} }
        return DEFAULT_DRINKS;
      });
      React.useEffect(()=>localStorage.setItem(STORAGE_KEY_DRINKS, JSON.stringify(drinks)), [drinks]);
      const drinkById = React.useMemo(()=> {
        const m = new Map();
        drinks.forEach(d => m.set(d.id, d));
        return m;
      }, [drinks]);
      function updateDrinkFraction(id, newFraction){
        newFraction = Math.max(0, Math.min(1, newFraction));
        setDrinks(ds => ds.map(d => d.id===id ? {...d, waterFraction:newFraction} : d));
      }
      return { drinks, setDrinks, drinkById, updateDrinkFraction };
    }

    function getHashRoomId(){
      const m = location.hash.match(/room=([A-Za-z0-9_-]+)/);
      return m ? m[1] : "";
    }

    function useRoom(roomId) {
      const [entries, setEntries] = React.useState([]);
      const [members, setMembers] = React.useState([]);
      React.useEffect(() => {
        if (!roomId) return;
        const un1 = db.collection("rooms").doc(roomId).collection("entries")
          .orderBy("ts", "desc")
          .onSnapshot(snap => setEntries(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
        const un2 = db.collection("rooms").doc(roomId).collection("members")
          .onSnapshot(snap => setMembers(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
        return () => { un1(); un2(); };
      }, [roomId]);
      return { entries, members };
    }

    // ====== Firestore ops ======
    async function createRoom(name) {
      const ref = await db.collection("rooms").add({
        name: name || "–ù–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return ref.id;
    }

    async function joinRoom(roomId, user, name) {
      if (!roomId || !user) return;
      await db.collection("rooms").doc(roomId).collection("members").doc(user.uid).set({
        name: name || user.displayName || "–ì–æ—Å—Ç—å",
        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    async function addDrinkCloud(roomId, user, { ml, drinkId, userName }) {
      if (!roomId || !user) return;
      await db.collection("rooms").doc(roomId).collection("entries").add({
        userId: user.uid,
        userName: userName || "–ì–æ—Å—Ç—å",
        ml: Math.round(ml),
        drinkId,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    async function undoLastForCurrentCloud(roomId, user) {
      if (!roomId || !user) return;
      const q = await db.collection("rooms").doc(roomId).collection("entries")
        .where("userId","==", user.uid).orderBy("ts","desc").limit(1).get();
      if (!q.empty) await q.docs[0].ref.delete();
    }

    // ====== UI components ======
    const Card = ({children, className})=>(
      <div className={cx(
        "rounded-2xl border shadow-card",
        "bg-white/70 supports-[backdrop-filter]:bg-white/60 backdrop-blur",
        "dark:bg-slate-800/60 dark:border-slate-700",
        className
      )}>{children}</div>
    );

    const SegBtn = ({active, children, onClick})=>(
      <button
        onClick={onClick}
        className={cx(
          "px-3 py-2 min-h-[44px] text-sm transition-colors",
          active
            ? "bg-slate-900 text-white dark:bg-white dark:text-slate-900"
            : "bg-white/70 dark:bg-slate-800/60"
        )}
      >{children}</button>
    );

    // ====== App ======
    function App(){
      const { theme, setTheme } = useTheme();
      const { user, loading, signInGoogle, signInAnon, signOut } = useAuth();
      const { drinks, drinkById, updateDrinkFraction } = useDrinksConfig();

      const [period,setPeriod]=React.useState("day");
      const [selectedDate,setSelectedDate]=React.useState(todayISO());
      const [drinkId,setDrinkId]=React.useState("water");
      const [showDrinkSettings,setShowDrinkSettings]=React.useState(false);
      const [roomId, setRoomId] = React.useState(getHashRoomId());
      const [displayName, setDisplayName] = React.useState("");
      const [customOpen, setCustomOpen] = React.useState(false);
      const [customMl, setCustomMl] = React.useState(330);
      const [inApp, setInApp] = React.useState(false);

      React.useEffect(()=> setInApp(isInAppBrowser()), []);

      // sync hash <-> state
      React.useEffect(()=>{
        const onHash = () => setRoomId(getHashRoomId());
        window.addEventListener("hashchange", onHash);
        return () => window.removeEventListener("hashchange", onHash);
      }, []);
      React.useEffect(()=>{
        if (roomId) {
          const hash = `#room=${roomId}`;
          if (location.hash !== hash) history.replaceState(null, "", hash);
        } else if (location.hash) {
          history.replaceState(null, "", " ");
        }
      }, [roomId]);

      const { entries, members } = useRoom(roomId);

      // ensure membership name
      React.useEffect(()=>{
        if (!user || !roomId) return;
        const member = members.find(m => m.id === user.uid);
        if (member && member.name && !displayName) setDisplayName(member.name);
        if (!member) joinRoom(roomId, user, displayName || user.displayName || "–ì–æ—Å—Ç—å");
      }, [user, roomId, members]); // eslint-disable-line

      const drinkSelected = drinkById.get(drinkId) || drinks[0];

      // derived
      const memberMap = React.useMemo(()=>{
        const m = new Map();
        members.forEach(mem => m.set(mem.id, mem));
        return m;
      }, [members]);

      const entriesForPeriod = React.useMemo(()=>{
        const sel = new Date(selectedDate + "T12:00:00");
        return entries.filter(e=>{
          const d = tsToDate(e.ts);
          if(period==="day")   return sameDay(d,sel);
          if(period==="month") return isSameMonth(d,sel);
          if(period==="year")  return isSameYear(d,sel);
          return false;
        });
      }, [entries, selectedDate, period]);

      const totals = React.useMemo(()=>{
        const byId = new Map();
        for (const e of entriesForPeriod) {
          const drink = drinkById.get(e.drinkId) || { waterFraction: 1 };
          const waterMl = Math.round(e.ml * (drink.waterFraction ?? 1));
          const cur = byId.get(e.userId) || { userId: e.userId, waterMl:0, totalMl:0 };
          cur.waterMl += waterMl;
          cur.totalMl += e.ml;
          byId.set(e.userId, cur);
        }
        return Array.from(byId.values())
          .map(v => ({ ...v, name: memberMap.get(v.userId)?.name || "–£—á–∞—Å—Ç–Ω–∏–∫" }))
          .sort((a,b)=> b.waterMl - a.waterMl);
      }, [entriesForPeriod, drinkById, memberMap]);

      const myHistory = React.useMemo(()=>{
        if (!user) return [];
        return entries.filter(e => e.userId === user.uid).slice(0,20);
      }, [entries, user]);

      // actions
      async function handleAddDrink(ml){
        if (!user || !roomId) return;
        const name = displayName || user.displayName || "–ì–æ—Å—Ç—å";
        await joinRoom(roomId, user, name);
        await addDrinkCloud(roomId, user, { ml, drinkId, userName: name });
      }
      async function handleUndo(){
        if (!user || !roomId) return;
        await undoLastForCurrentCloud(roomId, user);
      }
      async function handleCreateRoom(){
        if (!user) return;
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã?") || "–ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞";
        const id = await createRoom(name);
        setRoomId(id);
        await joinRoom(id, user, displayName || user.displayName || "–ì–æ—Å—Ç—å");
      }
      async function handleJoinExisting(id){
        if (!user || !id) return;
        setRoomId(id);
        await joinRoom(id, user, displayName || user.displayName || "–ì–æ—Å—Ç—å");
      }
      function copyInvite(){
        const url = location.origin + location.pathname + `#room=${roomId}`;
        navigator.clipboard?.writeText(url);
        alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:\n" + url);
      }

      const Header = () => (
        <div className="flex flex-col sm:flex-row sm:items-end gap-4 justify-between safe-top">
          <div>
            <h1 className="text-3xl md:text-4xl font-bold tracking-tight">
              HydroRace <span className="align-middle">üíß</span>
            </h1>
            <p className="text-sm text-slate-600 dark:text-slate-300">
              –õ–∞–π–≤-—Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ø–æ <span className="font-semibold">–≤–æ–¥–Ω–æ–º—É —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—É</span>
            </p>
          </div>

          <div className="flex flex-wrap items-center gap-2">
            <div className="inline-flex rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
              <SegBtn active={period==="day"}   onClick={()=>setPeriod("day")}>–î–µ–Ω—å</SegBtn>
              <SegBtn active={period==="month"} onClick={()=>setPeriod("month")}>–ú–µ—Å—è—Ü</SegBtn>
              <SegBtn active={period==="year"}  onClick={()=>setPeriod("year")}>–ì–æ–¥</SegBtn>
            </div>

            <input
              type="date"
              value={selectedDate}
              onChange={(e) => setSelectedDate(e.target.value)}
              className="px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm bg-white/80 dark:bg-slate-800/80"
            />

            <button
              onClick={()=>setTheme(theme==="dark"?"light":"dark")}
              className="px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/80 hover:brightness-95 transition"
              title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"
              aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"
            >
              {theme==="dark" ? "üåô" : "üåû"}
            </button>
          </div>
        </div>
      );

      if (loading) {
        return (
          <div className="min-h-full p-4 grid place-items-center">
            <div className="text-slate-600 dark:text-slate-300">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          </div>
        );
      }

      if (!user) {
        return (
          <div className="min-h-full p-4 md:p-6 flex items-center justify-center">
            <div className="max-w-md w-full space-y-3">
              {inApp && (
                <div className="rounded-xl border border-amber-300 bg-amber-50 text-amber-900 dark:bg-amber-900/30 dark:border-amber-700 dark:text-amber-200 p-3">
                  –ü–æ—Ö–æ–∂–µ, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ <b>–≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä, Telegram/Instagram/Gmail).
                  Google-–≤—Ö–æ–¥ —Ç—É—Ç —á–∞—Å—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π –≤ <b>–æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ</b>:
                  <div className="mt-2 flex gap-2">
                    <a href={location.href} target="_blank" rel="noopener" className="px-3 py-2 rounded-xl border">–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ</a>
                    <button onClick={openInExternalBrowser} className="px-3 py-2 rounded-xl border">–û—Ç–∫—Ä—ã—Ç—å –∑–¥–µ—Å—å</button>
                  </div>
                </div>
              )}
              <Card className="p-6 text-center">
                <h1 className="text-2xl font-semibold mb-2">HydroRace üíß</h1>
                <p className="text-slate-600 dark:text-slate-300 mb-6">
                  –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏.
                </p>
                <div className="grid gap-2">
                  <button onclick="void(0)" style="display:none"></button> <!-- –Ω–µ–±–æ–ª—å—à–æ–π ¬´—Ä–∞–∑–æ–≥—Ä–µ–≤¬ª –¥–ª—è –∂–µ—Å—Ç–æ–≤ -->
                  <button onClick={signInGoogle} className="px-4 py-3 rounded-xl min-h-[44px] border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
                  <button onClick={signInAnon} className="px-4 py-3 rounded-xl min-h-[44px] border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">–í–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ</button>
                </div>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-4">
                  –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –≤—Ö–æ–¥ ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤ Safari/Chrome, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
                </p>
              </Card>
            </div>
          </div>
        );
      }

      if (!roomId) {
        return (
          <div className="min-h-full p-4 md:p-6 pb-28">
            <div className="max-w-3xl mx-auto grid gap-6">
              <Header />
              <Card className="p-6">
                <h2 className="font-semibold mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É</h2>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="border rounded-xl p-4">
                    <div className="font-medium mb-2">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é</div>
                    <label className="text-sm block mb-3">
                      –í–∞—à–µ –∏–º—è:
                      <input value={displayName} onChange={e=>setDisplayName(e.target.value)} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê—Ä—Ç—ë–º"
                        className="mt-1 w-full px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent"/>
                    </label>
                    <button onClick={handleCreateRoom} className="px-4 py-3 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">
                      ‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                    </button>
                  </div>
                  <div className="border rounded-xl p-4">
                    <div className="font-medium mb-2">–í–æ–π—Ç–∏ –ø–æ ID</div>
                    <JoinForm onJoin={handleJoinExisting} onSetName={setDisplayName} displayName={displayName} />
                  </div>
                </div>
                <div className="mt-4 text-xs text-slate-600 dark:text-slate-400">
                  –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–≤—Ö–æ–¥–∞ –ø–æ–ª—É—á–∏—Ç–µ —Å—Å—ã–ª–∫—É –≤–∏–¥–∞ <code>#room=ROOM_ID</code> –∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –µ—é.
                </div>
                <div className="mt-4">
                  <button onClick={signOut} className="text-sm underline">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                </div>
              </Card>
            </div>
            <BottomBarHint />
          </div>
        );
      }

      return (
        <div className="min-h-full p-4 md:p-8 pb-28">
          <div className="max-w-6xl mx-auto grid gap-6">
            <Header />

            <div className="flex flex-wrap items-center gap-2">
              <Card className="px-3 py-2">
                <div className="text-sm">
                  –ö–æ–º–Ω–∞—Ç–∞: <code className="font-mono">{roomId}</code>
                  <button onClick={copyInvite} className="ml-2 text-sm underline decoration-dashed underline-offset-4">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
              </Card>
              <Card className="px-3 py-2">
                <div className="text-sm">
                  –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{displayName || user.displayName || "–ì–æ—Å—Ç—å"}</strong>
                  <button onClick={async()=>{
                    const n = prompt("–í–∞—à–µ –∏–º—è:", displayName || user.displayName || "–ì–æ—Å—Ç—å") || "";
                    setDisplayName(n);
                    await joinRoom(roomId, user, n);
                  }} className="ml-2 text-sm underline decoration-dashed underline-offset-4">–∏–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
              </Card>
              <button onClick={signOut} className="px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">–í—ã–π—Ç–∏</button>
            </div>

            <section className="grid lg:grid-cols-3 gap-6">
              <Card className="p-4">
                <h2 className="font-semibold mb-3">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
                <ul className="space-y-1 text-sm">
                  {members.map(m => (
                    <li key={m.id} className="flex items-center justify-between">
                      <span>{m.name || "–£—á–∞—Å—Ç–Ω–∏–∫"}</span>
                      <span className="text-xs text-slate-500 dark:text-slate-400">{m.id===user.uid ? "—ç—Ç–æ –≤—ã" : ""}</span>
                    </li>
                  ))}
                  {!members.length && <li className="text-slate-500 dark:text-slate-400">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ</li>}
                </ul>
              </Card>

              <Card className="p-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="font-semibold">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–∏—Ç–æ–∫ {displayName ? `–¥–ª—è ${displayName}` : ""}</h2>
                  <button className="text-sm underline decoration-dashed underline-offset-4" onClick={()=>setShowDrinkSettings(true)}>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤</button>
                </div>

                <div className="mb-3">
                  <div className="flex gap-2 overflow-x-auto pb-1 -mx-1 px-1">
                    {drinks.map(d=>(
                      <button key={d.id} onClick={()=>setDrinkId(d.id)}
                        className={cx("px-3 py-2 min-h-[44px] rounded-xl border whitespace-nowrap transition",
                          "border-slate-200 dark:border-slate-700",
                          drinkId===d.id ? "bg-brand-500 text-white dark:text-slate-900 dark:bg-brand-300" : "bg-white/70 dark:bg-slate-800/60 hover:brightness-95"
                        )}
                        title={`–î–æ–ª—è –≤–æ–¥—ã: ${fmtPct(d.waterFraction)}`}>
                        <span className="mr-1">{d.emoji}</span>{d.name}
                      </button>
                    ))}
                  </div>
                  <div className="text-xs text-slate-600 dark:text-slate-300 mt-2">
                    –í—ã–±—Ä–∞–Ω–æ: <strong>{(drinkById.get(drinkId)||{}).emoji} {(drinkById.get(drinkId)||{}).name}</strong> ‚Äî –¥–æ–ª—è –≤–æ–¥—ã {fmtPct((drinkById.get(drinkId)||{waterFraction:1}).waterFraction)}
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-2">
                  <button className="rounded-2xl border border-slate-200 dark:border-slate-700 px-3 py-6 hover:brightness-95 transition" onClick={() => handleAddDrink(ML.glass)}>
                    ü•õ –°—Ç–∞–∫–∞–Ω
                    <div className="text-xs text-slate-500 dark:text-slate-400">{fmtLiters(ML.glass)}</div>
                  </button>
                  <button className="rounded-2xl border border-slate-200 dark:border-slate-700 px-3 py-6 hover:brightness-95 transition" onClick={() => handleAddDrink(ML.bottle05)}>
                    üß¥ –ë—É—Ç—ã–ª–∫–∞ 0.5
                    <div className="text-xs text-slate-500 dark:text-slate-400">{fmtLiters(ML.bottle05)}</div>
                  </button>
                  <button className="rounded-2xl border border-slate-200 dark:border-slate-700 px-3 py-6 hover:brightness-95 transition" onClick={() => handleAddDrink(ML.bottle15)}>
                    üß¥ –ë—É—Ç—ã–ª–∫–∞ 1.5
                    <div className="text-xs text-slate-500 dark:text-slate-400">{fmtLiters(ML.bottle15)}</div>
                  </button>
                </div>

                <div className="mt-3 flex items-center gap-2">
                  <button className="px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition" onClick={handleUndo}>‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π</button>
                </div>

                <div className="mt-4">
                  <h3 className="text-sm font-semibold mb-1">–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                  <ul className="text-sm max-h-40 overflow-auto space-y-1">
                    {myHistory.map((e) => {
                      const d = drinkById.get(e.drinkId) || {emoji:"",name:"",waterFraction:1};
                      const waterMl = Math.round(e.ml * (d.waterFraction ?? 1));
                      const dt = tsToDate(e.ts);
                      return (
                        <li key={e.id} className="flex justify-between">
                          <span>{d.emoji} {d.name} ‚Äî {fmtLiters(e.ml)} <span className="text-slate-500 dark:text-slate-400">(–≤–æ–¥–∞: {fmtLiters(waterMl)})</span></span>
                          <span className="text-slate-500 dark:text-slate-400">{dt.toLocaleString()}</span>
                        </li>
                      );
                    })}
                    {!myHistory.length && <li className="text-slate-500 dark:text-slate-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</li>}
                  </ul>
                </div>
              </Card>

              <Card className="p-4">
                <h2 className="font-semibold mb-3">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ ‚Äî {period === "day" ? "–∑–∞ –¥–µ–Ω—å" : period === "month" ? "–∑–∞ –º–µ—Å—è—Ü" : "–∑–∞ –≥–æ–¥"}</h2>
                <p className="text-xs text-slate-600 dark:text-slate-300 mb-2">–†–µ–π—Ç–∏–Ω–≥ –ø–æ <strong>–≤–æ–¥–Ω–æ–º—É —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—É</strong></p>
                <ol className="space-y-2">
                  {totals.map((t, i) => (
                    <li key={t.userId} className="flex items-center justify-between rounded-xl px-3 py-2 border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-800/50">
                      <div className="flex items-center gap-3">
                        <span className="w-6 text-center font-bold">{i + 1}</span>
                        <span className="font-medium">{t.name}</span>
                      </div>
                      <div className="text-right">
                        <div className="font-semibold">{fmtLiters(t.waterMl)} –≤–æ–¥—ã</div>
                        <div className="text-xs text-slate-500 dark:text-slate-400">–≤—Å–µ–≥–æ –≤—ã–ø–∏—Ç–æ: {fmtLiters(t.totalMl)}</div>
                      </div>
                    </li>
                  ))}
                  {!totals.length && <li className="text-slate-500 dark:text-slate-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>}
                </ol>
              </Card>
            </section>

            <Card className="p-4">
              <h2 className="font-semibold mb-3">–õ–µ–Ω—Ç–∞ –∑–∞–ø–∏—Å–µ–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</h2>
              <ul className="space-y-1 text-sm max-h-80 overflow-auto">
                {entriesForPeriod
                  .sort((a, b) => tsToDate(b.ts) - tsToDate(a.ts))
                  .map((e) => {
                    const mem = memberMap.get(e.userId);
                    const d = drinkById.get(e.drinkId) || {emoji:"",name:"",waterFraction:1};
                    const waterMl = Math.round(e.ml * (d.waterFraction ?? 1));
                    const dt = tsToDate(e.ts);
                    return (
                      <li key={e.id} className="flex items-center justify-between">
                        <span><strong>{mem?.name || "–£—á–∞—Å—Ç–Ω–∏–∫"}</strong> ‚Äî {d.emoji} {d.name} ‚Ä¢ {fmtLiters(e.ml)} <span className="text-slate-500 dark:text-slate-400">(–≤–æ–¥–∞: {fmtLiters(waterMl)})</span></span>
                        <span className="text-slate-500 dark:text-slate-400">{dt.toLocaleString()}</span>
                      </li>
                    );
                  })}
                {!entriesForPeriod.length && <li className="text-slate-500 dark:text-slate-400">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥</li>}
              </ul>
            </Card>

            <p className="text-xs text-slate-600 dark:text-slate-400 text-center py-2">
              –°–¥–µ–ª–∞–Ω–æ –Ω–∞ React + Tailwind. –î–∞–Ω–Ω—ã–µ ‚Äî Firebase Firestore.
            </p>
          </div>

          <!-- Sticky Bottom Action Bar -->
          <div className="fixed bottom-0 inset-x-0 z-50">
            <div className="mx-auto max-w-6xl px-3">
              <div className="rounded-2xl border border-slate-200 dark:border-slate-700 shadow-card bg-white/90 dark:bg-slate-900/90 backdrop-blur safe-bottom">
                <div className="flex items-center gap-2 p-2 overflow-x-auto">
                  <button className={btnAction()} onClick={()=>setShowDrinkSettings(true)} title="–ù–∞–ø–∏—Ç–∫–∏">‚öôÔ∏è</button>

                  <div className="flex-1 flex gap-2 overflow-x-auto">
                    <button className={btnActionPrimary()} onClick={()=>handleAddDrink(ML.glass)} aria-label="–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–∫–∞–Ω">
                      ü•õ {fmtLiters(ML.glass)}
                    </button>
                    <button className={btnActionPrimary()} onClick={()=>handleAddDrink(ML.bottle05)} aria-label="–î–æ–±–∞–≤–∏—Ç—å 0.5 –ª">
                      üß¥ 0.5 –ª
                    </button>
                    <button className={btnActionPrimary()} onClick={()=>handleAddDrink(ML.bottle15)} aria-label="–î–æ–±–∞–≤–∏—Ç—å 1.5 –ª">
                      üß¥ 1.5 –ª
                    </button>
                    <button className={btnAction()} onClick={()=>setCustomOpen(true)} aria-label="–°–≤–æ–π –æ–±—ä—ë–º">
                      ‚ûï –°–≤–æ–π
                    </button>
                  </div>

                  <button className={btnAction()} onClick={handleUndo} title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å">‚Ü©Ô∏è</button>
                </div>
              </div>
            </div>
          </div>

          {/* –ú–æ–¥–∞–ª: –°–≤–æ–π –æ–±—ä—ë–º */}
          {customOpen && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="max-w-sm w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 shadow-card">
                <div className="p-4 border-b border-slate-200 dark:border-slate-700">
                  <h3 className="font-semibold text-lg">–°–≤–æ–π –æ–±—ä—ë–º</h3>
                </div>
                <div className="p-4 grid gap-3">
                  <label className="text-sm">
                    –ú–∏–ª–ª–∏–ª–∏—Ç—Ä—ã:
                    <input type="number" inputmode="numeric" min="50" step="10"
                      value={customMl} onChange={e=>setCustomMl(parseInt(e.target.value||0,10))}
                      className="mt-1 w-full px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent"/>
                  </label>
                  <div className="flex gap-2">
                    {[200,250,300,330,500,700,750,1000].map(v=>(
                      <button key={v} onClick={()=>setCustomMl(v)} className="px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 text-sm">
                        {v} –º–ª
                      </button>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <button className={btnActionPrimary()+" flex-1"} onClick={()=>{ setCustomOpen(false); handleAddDrink(customMl); }}>–î–æ–±–∞–≤–∏—Ç—å {fmtLiters(customMl)}</button>
                    <button className={btnAction()+" flex-1"} onClick={()=>setCustomOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* –ú–æ–¥–∞–ª: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤ */}
          {showDrinkSettings && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="max-w-2xl w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 shadow-card">
                <div className="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
                  <h3 className="font-semibold text-lg">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤</h3>
                  <button className="text-sm underline" onClick={()=>setShowDrinkSettings(false)}>–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
                <div className="p-4">
                  <div className="flex gap-2 overflow-x-auto pb-2 -mx-1 px-1 mb-3">
                    {drinks.map(d=>(
                      <button key={d.id} onClick={()=>setDrinkId(d.id)}
                        className={cx("px-3 py-2 min-h-[44px] rounded-xl border whitespace-nowrap transition",
                          "border-slate-200 dark:border-slate-700",
                          drinkId===d.id ? "bg-brand-500 text-white dark:text-slate-900 dark:bg-brand-300" : "bg-white/70 dark:bg-slate-800/60 hover:brightness-95"
                        )}>
                        <span className="mr-1">{d.emoji}</span>{d.name}
                      </button>
                    ))}
                  </div>
                  <p className="text-xs text-slate-600 dark:text-slate-300 mb-3">
                    –í —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è <strong>–≤–æ–¥–Ω—ã–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç</strong> (= –æ–±—ä—ë–º √ó –¥–æ–ª—è –≤–æ–¥—ã).
                  </p>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {drinks.map(d=>(
                      <div key={d.id} className="border border-slate-200 dark:border-slate-700 rounded-xl p-3 bg-white/70 dark:bg-slate-800/60">
                        <div className="font-medium">{d.emoji} {d.name}</div>
                        <label className="text-sm mt-2 block">
                          –î–æ–ª—è –≤–æ–¥—ã:
                          <input
                            type="number" min="0" max="100" step="1"
                            value={Math.round((d.waterFraction ?? 1)*100)}
                            onChange={(e)=>updateDrinkFraction(d.id, (Number(e.target.value)||0)/100)}
                            className="ml-2 w-20 px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-transparent"
                          />%
                        </label>
                        <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                          –°–µ–π—á–∞—Å —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ {fmtPct(d.waterFraction ?? 1)} –æ—Ç –æ–±—ä—ë–º–∞.
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );

      // Button styles (reuse)
      function btnAction(){ return "px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/80 hover:brightness-95 transition whitespace-nowrap"; }
      function btnActionPrimary(){ return "px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 bg-brand-500 text-white hover:brightness-95 transition whitespace-nowrap"; }
    }

    function JoinForm({ onJoin, onSetName, displayName }){
      const [id, setId] = React.useState("");
      return (
        <div>
          <label className="text-sm block mb-3">
            –í–∞—à–µ –∏–º—è:
            <input value={displayName} onChange={e=>onSetName(e.target.value)} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê—Ä—Ç—ë–º"
              className="mt-1 w-full px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent"/>
          </label>
          <label className="text-sm block mb-3">
            ID –∫–æ–º–Ω–∞—Ç—ã:
            <input value={id} onChange={e=>setId(e.target.value)} placeholder="–í—Å—Ç–∞–≤—å—Ç–µ ROOM_ID"
              className="mt-1 w-full px-3 py-2 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent"/>
          </label>
          <button onClick={()=>onJoin(id)} className="px-4 py-3 min-h-[44px] rounded-xl border border-slate-200 dark:border-slate-700 hover:brightness-95 transition">
            ‚¨áÔ∏è –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É
          </button>
        </div>
      );
    }

    function BottomBarHint(){
      return (
        <div className="fixed bottom-0 inset-x-0 pointer-events-none">
          <div className="mx-auto max-w-6xl px-3">
            <div className="py-1 text-center text-[10px] md:hidden text-slate-500 dark:text-slate-400">
              –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤–Ω–∏–∑—É ‚Ä¢ —Å–≤–∞–π–ø–Ω–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º, –µ—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è ‚Üí
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>
