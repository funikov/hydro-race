<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HydroRace — кто больше выпил воды</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#0b1220; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --primary:#0ea5e9; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,"Noto Sans",Arial,sans-serif;background:linear-gradient(180deg,#07101d,#0b1220 30%);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.75);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .app-title{font-weight:800;letter-spacing:.2px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:var(--radius);padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
    button{appearance:none;border:1px solid #1f2937;border-radius:14px;background:#0f172a;color:var(--text);padding:10px 14px;font-weight:600;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#0ea5e9,#0177b7);border-color:#0ea5e955}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:default}
    .amounts{display:flex;gap:10px;flex-wrap:wrap}
    .amounts button{min-width:120px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;background:#0f172a;border:1px solid #1f2937}
    input,select{width:100%;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px;color:var(--text)}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #1f2937;background:#0f172a;cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#0ea5e9,#0177b7)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}
    th{color:#9fb2c7;font-weight:700}
    .me{background:#0a1b2a}
    .footer{opacity:.7;font-size:12px;margin-top:24px}
    .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #1f2937}
    .right{margin-left:auto}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="row grow">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 2c1.5 2 3 3.5 3 6a3 3 0 1 1-6 0c0-2.5 1.5-4 3-6Zm0 0v20" stroke="#0ea5e9" stroke-width="2"/></svg>
        <div>
          <div class="app-title">HydroRace</div>
          <div class="hint">Соревнование по воде: день · месяц · год</div>
        </div>
      </div>
      <div id="authArea" class="row"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start;gap:16px;">
          <div class="grow">
            <h2 style="margin:0 0 6px">Сегодня</h2>
            <div class="hint">Твоя цель — пить воду и обновлять прогресс. Выбери объём или введи свой.</div>
          </div>
          <div>
            <label class="hint">Группа</label>
            <div class="row">
              <input id="groupInput" placeholder="например: friends2025" style="min-width:220px"/>
              <button id="saveGroupBtn">ОК</button>
            </div>
            <div class="hint" id="groupHint"></div>
          </div>
        </div>

        <div class="amounts" style="margin-top:12px">
          <button class="primary" data-ml="250">Стакан 250 мл</button>
          <button class="primary" data-ml="500">Бутылка 0.5 л</button>
          <button class="primary" data-ml="1500">Бутылка 1.5 л</button>
          <div class="pill">
            <input id="customMl" type="number" min="1" placeholder="Свои мл" style="width:120px">
            <button id="addCustomBtn">Добавить</button>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div class="pill">Сегодня выпито: <strong id="todayTotal" style="margin-left:8px">0 мл</strong></div>
          <div class="pill">Группа: <strong id="groupLabel" style="margin-left:8px">global</strong></div>
        </div>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">Топ участников</h2>
          <div class="tabs" id="periodTabs">
            <button data-period="day" class="tab active">День</button>
            <button data-period="month" class="tab">Месяц</button>
            <button data-period="year" class="tab">Год</button>
          </div>
        </div>
        <div style="margin-top:8px" class="hint">Считаем по локальному времени устройства.</div>
        <div id="leaderboardArea" style="margin-top:10px"></div>
      </section>
    </div>

    <div class="footer">Подсказка: создайте свой код группы (например, team-omega) и поделитесь им с друзьями. Все, кто выберет тот же код, увидят общий рейтинг.</div>
  </main>

  <script type="module">
    // =====================
    // 1) Firebase CONFIG
    // =====================
    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8z2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };

    // =====================
    // 2) SDK imports
    // =====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, orderBy, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // A small helper for time boundaries in local timezone
    // We avoid extra libs to keep single-file footprint small
    function startEndOf(period){
      const now = new Date();
      let start, end;
      if(period==='day'){
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
      } else if(period==='month'){
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end = new Date(now.getFullYear(), now.getMonth()+1, 1);
      } else { // 'year'
        start = new Date(now.getFullYear(), 0, 1);
        end = new Date(now.getFullYear()+1, 0, 1);
      }
      return { start: Timestamp.fromMillis(start.getTime()), end: Timestamp.fromMillis(end.getTime()) };
    }

    // =====================
    // 3) App state
    // =====================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const state = {
      user:null,
      groupId: localStorage.getItem('hydrace_group') || 'global',
      period: 'day'
    };

    // =====================
    // 4) DOM refs
    // =====================
    const authArea = document.getElementById('authArea');
    const todayTotalEl = document.getElementById('todayTotal');
    const groupLabelEl = document.getElementById('groupLabel');
    const groupInput = document.getElementById('groupInput');
    const saveGroupBtn = document.getElementById('saveGroupBtn');
    const groupHint = document.getElementById('groupHint');
    const leaderboardArea = document.getElementById('leaderboardArea');

    // =====================
    // 5) Auth UI
    // =====================
    function renderAuth(){
      authArea.innerHTML = '';
      if(!state.user){
        const btn = document.createElement('button');
        btn.className='primary';
        btn.textContent='Войти через Google';
        btn.onclick = async ()=>{
          try{
            const prov = new GoogleAuthProvider();
            await signInWithPopup(auth, prov);
          }catch(e){
            alert('Не удалось войти: '+ e.message);
          }
        };
        authArea.appendChild(btn);
      }else{
        const row = document.createElement('div');
        row.className='row';
        const img = document.createElement('img');
        img.className='avatar';
        img.src = state.user.photoURL || '';
        const name = document.createElement('div');
        name.textContent = state.user.displayName || 'Без имени';
        const out = document.createElement('button');
        out.className='ghost';
        out.textContent='Выйти';
        out.onclick = ()=> signOut(auth);
        row.append(img,name,out);
        authArea.appendChild(row);
      }
    }

    onAuthStateChanged(auth, async (u)=>{
      state.user = u;
      renderAuth();
      if(u){
        // upsert user profile
        await setDoc(doc(db,'users',u.uid),{
          uid:u.uid, displayName:u.displayName||'Без имени', photoURL:u.photoURL||'',
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'local',
          groupId: state.groupId,
          updatedAt: Timestamp.now()
        }, { merge:true });
      }
      updateGroupUI();
      refreshAll();
    });

    // =====================
    // 6) Group handling
    // =====================
    function updateGroupUI(){
      groupLabelEl.textContent = state.groupId;
      groupInput.value = state.groupId;
      groupHint.textContent = 'Код группы хранится локально и в вашем профиле';
    }

    saveGroupBtn.addEventListener('click', async ()=>{
      const val = (groupInput.value||'').trim().toLowerCase().replace(/[^a-z0-9_-]/g,'');
      state.groupId = val || 'global';
      localStorage.setItem('hydrace_group', state.groupId);
      updateGroupUI();
      if(state.user){
        await setDoc(doc(db,'users',state.user.uid),{ groupId: state.groupId, updatedAt: Timestamp.now() },{merge:true});
      }
      refreshAll();
    });

    // =====================
    // 7) Add drink buttons
    // =====================
    document.querySelectorAll('.amounts button[data-ml]').forEach(btn=>{
      btn.addEventListener('click', ()=> addDrink(parseInt(btn.dataset.ml,10)));
    });
    document.getElementById('addCustomBtn').addEventListener('click',()=>{
      const ml = parseInt(document.getElementById('customMl').value,10);
      if(!ml || ml<=0) return alert('Введите положительное число мл');
      addDrink(ml);
      document.getElementById('customMl').value='';
    });

    async function addDrink(ml){
      if(!state.user){ alert('Сначала войдите через Google'); return; }
      try{
        await addDoc(collection(db,'groups',state.groupId,'drinks'),{
          uid: state.user.uid,
          ml,
          ts: Timestamp.now(),
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'local'
        });
        refreshAll();
      }catch(e){
        alert('Не удалось сохранить запись: '+e.message);
      }
    }

    // =====================
    // 8) Leaderboard & totals
    // =====================
    const tabs = document.getElementById('periodTabs');
    tabs.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.tab');
      if(!btn) return;
      tabs.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.period = btn.dataset.period;
      refreshAll();
    });

    async function refreshAll(){
      await Promise.all([refreshTodayTotal(), refreshLeaderboard()]);
    }

    async function refreshTodayTotal(){
      if(!state.user){ todayTotalEl.textContent='0 мл'; return; }
      const {start,end} = startEndOf('day');
      const q = query(
        collection(db,'groups',state.groupId,'drinks'),
        where('uid','==',state.user.uid),
        where('ts','>=',start),
        where('ts','<',end),
        orderBy('ts','desc')
      );
      const snap = await getDocs(q);
      let sum = 0; snap.forEach(d=> sum += (d.data().ml||0));
      todayTotalEl.textContent = sum + ' мл';
    }

    async function refreshLeaderboard(){
      const {start,end} = startEndOf(state.period);
      const q = query(
        collection(db,'groups',state.groupId,'drinks'),
        where('ts','>=',start),
        where('ts','<',end)
      );
      const snap = await getDocs(q);
      const byUser = new Map();
      snap.forEach(docu=>{
        const {uid,ml} = docu.data();
        byUser.set(uid,(byUser.get(uid)||0)+(ml||0));
      });
      const arr = [...byUser.entries()].sort((a,b)=>b[1]-a[1]);

      // Fetch names
      const rows = [];
      for(const [uid,sum] of arr){
        let name = 'Без имени';
        let photo = '';
        try{
          const udoc = await getDoc(doc(db,'users',uid));
          if(udoc.exists()){
            const d = udoc.data();
            name = d.displayName || name; photo = d.photoURL || '';
          }
        }catch{}
        rows.push({uid,name,photo,sum});
      }
      renderLeaderboard(rows);
    }

    function renderLeaderboard(rows){
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>#</th><th>Участник</th><th>Объём</th></tr>`;
      table.appendChild(thead);
      const tb = document.createElement('tbody');
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        if(state.user && r.uid===state.user.uid) tr.className='me';
        tr.innerHTML = `
          <td>${i+1}</td>
          <td class="row"><img class="avatar" src="${r.photo}" alt=""/> <span>${r.name}</span></td>
          <td><strong>${r.sum}</strong> мл</td>`;
        tb.appendChild(tr);
      });
      if(rows.length===0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3" class="hint">Пока нет записей за выбранный период.</td>`;
        tb.appendChild(tr);
      }
      table.appendChild(tb);
      leaderboardArea.innerHTML = '';
      leaderboardArea.appendChild(table);
    }

    // First render
    updateGroupUI();
    renderAuth();
  </script>

  <!--
  =====================
  Минимальные правила безопасности Firestore (пример — настройте в консоли):
  =====================
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{uid} {
        allow read: if request.auth!=null;
        allow write: if request.auth!=null && request.auth.uid == uid;
      }
      match /groups/{group}/drinks/{doc} {
        allow read: if request.auth!=null;
        allow create: if request.auth!=null && request.resource.data.uid == request.auth.uid;
      }
    }
  }
  -->
</body>
</html>
